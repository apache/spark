-- Automatically generated by SQLQueryTestSuite
-- !query
CREATE OR REPLACE TEMP VIEW t0(t0a, t0b) AS VALUES (1, 1), (2, 0)
-- !query analysis
CreateViewCommand `t0`, [(t0a,None), (t0b,None)], VALUES (1, 1), (2, 0), false, true, LocalTempView, UNSUPPORTED, true
   +- LocalRelation [col1#x, col2#x]


-- !query
CREATE OR REPLACE TEMP VIEW t1(t1a, t1b, t1c) AS VALUES (1, 1, 3)
-- !query analysis
CreateViewCommand `t1`, [(t1a,None), (t1b,None), (t1c,None)], VALUES (1, 1, 3), false, true, LocalTempView, UNSUPPORTED, true
   +- LocalRelation [col1#x, col2#x, col3#x]


-- !query
CREATE OR REPLACE TEMP VIEW t2(t2a, t2b, t2c) AS VALUES (1, 1, 5), (2, 2, 7)
-- !query analysis
CreateViewCommand `t2`, [(t2a,None), (t2b,None), (t2c,None)], VALUES (1, 1, 5), (2, 2, 7), false, true, LocalTempView, UNSUPPORTED, true
   +- LocalRelation [col1#x, col2#x, col3#x]


-- !query
SELECT t0a, (SELECT sum(c) FROM
  (SELECT t1c as c
  FROM   t1
  WHERE  t1a = t0a
  UNION ALL
  SELECT t2c as c
  FROM   t2
  WHERE  t2b = t0b)
)
FROM t0
-- !query analysis
Project [t0a#x, scalar-subquery#x [t0a#x && t0b#x] AS scalarsubquery(t0a, t0b)#xL]
:  +- Aggregate [sum(c#x) AS sum(c)#xL]
:     +- SubqueryAlias __auto_generated_subquery_name
:        +- Union false, false
:           :- Project [t1c#x AS c#x]
:           :  +- Filter (t1a#x = outer(t0a#x))
:           :     +- SubqueryAlias t1
:           :        +- View (`t1`, [t1a#x, t1b#x, t1c#x])
:           :           +- Project [cast(col1#x as int) AS t1a#x, cast(col2#x as int) AS t1b#x, cast(col3#x as int) AS t1c#x]
:           :              +- LocalRelation [col1#x, col2#x, col3#x]
:           +- Project [t2c#x AS c#x]
:              +- Filter (t2b#x = outer(t0b#x))
:                 +- SubqueryAlias t2
:                    +- View (`t2`, [t2a#x, t2b#x, t2c#x])
:                       +- Project [cast(col1#x as int) AS t2a#x, cast(col2#x as int) AS t2b#x, cast(col3#x as int) AS t2c#x]
:                          +- LocalRelation [col1#x, col2#x, col3#x]
+- SubqueryAlias t0
   +- View (`t0`, [t0a#x, t0b#x])
      +- Project [cast(col1#x as int) AS t0a#x, cast(col2#x as int) AS t0b#x]
         +- LocalRelation [col1#x, col2#x]


-- !query
SELECT * FROM t0 WHERE t0a <
(SELECT sum(c) FROM
  (SELECT t1c as c
  FROM   t1
  WHERE  t1a = t0a
  UNION ALL
  SELECT t2c as c
  FROM   t2
  WHERE  t2b = t0b)
)
-- !query analysis
Project [t0a#x, t0b#x]
+- Filter (cast(t0a#x as bigint) < scalar-subquery#x [t0a#x && t0b#x])
   :  +- Aggregate [sum(c#x) AS sum(c)#xL]
   :     +- SubqueryAlias __auto_generated_subquery_name
   :        +- Union false, false
   :           :- Project [t1c#x AS c#x]
   :           :  +- Filter (t1a#x = outer(t0a#x))
   :           :     +- SubqueryAlias t1
   :           :        +- View (`t1`, [t1a#x, t1b#x, t1c#x])
   :           :           +- Project [cast(col1#x as int) AS t1a#x, cast(col2#x as int) AS t1b#x, cast(col3#x as int) AS t1c#x]
   :           :              +- LocalRelation [col1#x, col2#x, col3#x]
   :           +- Project [t2c#x AS c#x]
   :              +- Filter (t2b#x = outer(t0b#x))
   :                 +- SubqueryAlias t2
   :                    +- View (`t2`, [t2a#x, t2b#x, t2c#x])
   :                       +- Project [cast(col1#x as int) AS t2a#x, cast(col2#x as int) AS t2b#x, cast(col3#x as int) AS t2c#x]
   :                          +- LocalRelation [col1#x, col2#x, col3#x]
   +- SubqueryAlias t0
      +- View (`t0`, [t0a#x, t0b#x])
         +- Project [cast(col1#x as int) AS t0a#x, cast(col2#x as int) AS t0b#x]
            +- LocalRelation [col1#x, col2#x]


-- !query
SELECT t0a, (SELECT sum(c) FROM
  (SELECT t1c as c
  FROM   t1
  WHERE  t1a = t0a
  UNION ALL
  SELECT t2c as c
  FROM   t2
  WHERE  t2a = t0a)
)
FROM t0
-- !query analysis
Project [t0a#x, scalar-subquery#x [t0a#x && t0a#x] AS scalarsubquery(t0a, t0a)#xL]
:  +- Aggregate [sum(c#x) AS sum(c)#xL]
:     +- SubqueryAlias __auto_generated_subquery_name
:        +- Union false, false
:           :- Project [t1c#x AS c#x]
:           :  +- Filter (t1a#x = outer(t0a#x))
:           :     +- SubqueryAlias t1
:           :        +- View (`t1`, [t1a#x, t1b#x, t1c#x])
:           :           +- Project [cast(col1#x as int) AS t1a#x, cast(col2#x as int) AS t1b#x, cast(col3#x as int) AS t1c#x]
:           :              +- LocalRelation [col1#x, col2#x, col3#x]
:           +- Project [t2c#x AS c#x]
:              +- Filter (t2a#x = outer(t0a#x))
:                 +- SubqueryAlias t2
:                    +- View (`t2`, [t2a#x, t2b#x, t2c#x])
:                       +- Project [cast(col1#x as int) AS t2a#x, cast(col2#x as int) AS t2b#x, cast(col3#x as int) AS t2c#x]
:                          +- LocalRelation [col1#x, col2#x, col3#x]
+- SubqueryAlias t0
   +- View (`t0`, [t0a#x, t0b#x])
      +- Project [cast(col1#x as int) AS t0a#x, cast(col2#x as int) AS t0b#x]
         +- LocalRelation [col1#x, col2#x]


-- !query
SELECT t0a, (SELECT sum(c) FROM
  (SELECT t1c as c
  FROM   t1
  WHERE  t1a > t0a
  UNION ALL
  SELECT t2c as c
  FROM   t2
  WHERE  t2b <= t0b)
)
FROM t0
-- !query analysis
Project [t0a#x, scalar-subquery#x [t0a#x && t0b#x] AS scalarsubquery(t0a, t0b)#xL]
:  +- Aggregate [sum(c#x) AS sum(c)#xL]
:     +- SubqueryAlias __auto_generated_subquery_name
:        +- Union false, false
:           :- Project [t1c#x AS c#x]
:           :  +- Filter (t1a#x > outer(t0a#x))
:           :     +- SubqueryAlias t1
:           :        +- View (`t1`, [t1a#x, t1b#x, t1c#x])
:           :           +- Project [cast(col1#x as int) AS t1a#x, cast(col2#x as int) AS t1b#x, cast(col3#x as int) AS t1c#x]
:           :              +- LocalRelation [col1#x, col2#x, col3#x]
:           +- Project [t2c#x AS c#x]
:              +- Filter (t2b#x <= outer(t0b#x))
:                 +- SubqueryAlias t2
:                    +- View (`t2`, [t2a#x, t2b#x, t2c#x])
:                       +- Project [cast(col1#x as int) AS t2a#x, cast(col2#x as int) AS t2b#x, cast(col3#x as int) AS t2c#x]
:                          +- LocalRelation [col1#x, col2#x, col3#x]
+- SubqueryAlias t0
   +- View (`t0`, [t0a#x, t0b#x])
      +- Project [cast(col1#x as int) AS t0a#x, cast(col2#x as int) AS t0b#x]
         +- LocalRelation [col1#x, col2#x]


-- !query
SELECT t0a, (SELECT sum(t1c) FROM
  (SELECT t1c
  FROM   t1
  WHERE  t1a = t0a
  UNION ALL
  SELECT t2c
  FROM   t2
  WHERE  t2b = t0b)
)
FROM t0
-- !query analysis
Project [t0a#x, scalar-subquery#x [t0a#x && t0b#x] AS scalarsubquery(t0a, t0b)#xL]
:  +- Aggregate [sum(t1c#x) AS sum(t1c)#xL]
:     +- SubqueryAlias __auto_generated_subquery_name
:        +- Union false, false
:           :- Project [t1c#x]
:           :  +- Filter (t1a#x = outer(t0a#x))
:           :     +- SubqueryAlias t1
:           :        +- View (`t1`, [t1a#x, t1b#x, t1c#x])
:           :           +- Project [cast(col1#x as int) AS t1a#x, cast(col2#x as int) AS t1b#x, cast(col3#x as int) AS t1c#x]
:           :              +- LocalRelation [col1#x, col2#x, col3#x]
:           +- Project [t2c#x]
:              +- Filter (t2b#x = outer(t0b#x))
:                 +- SubqueryAlias t2
:                    +- View (`t2`, [t2a#x, t2b#x, t2c#x])
:                       +- Project [cast(col1#x as int) AS t2a#x, cast(col2#x as int) AS t2b#x, cast(col3#x as int) AS t2c#x]
:                          +- LocalRelation [col1#x, col2#x, col3#x]
+- SubqueryAlias t0
   +- View (`t0`, [t0a#x, t0b#x])
      +- Project [cast(col1#x as int) AS t0a#x, cast(col2#x as int) AS t0b#x]
         +- LocalRelation [col1#x, col2#x]


-- !query
SELECT t0a, (SELECT sum(t1a + 3 * t1b + 5 * t1c) FROM
  (SELECT t1c as t1a, t1a as t1b, t0a as t1c
  FROM   t1
  WHERE  t1a = t0a
  UNION ALL
  SELECT t0a as t2b, t2c as t1a, t0b as t2c
  FROM   t2
  WHERE  t2b = t0b)
)
FROM t0
-- !query analysis
Project [t0a#x, scalar-subquery#x [t0a#x && t0a#x && t0a#x && t0b#x && t0b#x] AS scalarsubquery(t0a, t0a, t0a, t0b, t0b)#xL]
:  +- Aggregate [sum(((t1a#x + (3 * t1b#x)) + (5 * t1c#x))) AS sum(((t1a + (3 * t1b)) + (5 * t1c)))#xL]
:     +- SubqueryAlias __auto_generated_subquery_name
:        +- Union false, false
:           :- Project [t1c#x AS t1a#x, t1a#x AS t1b#x, outer(t0a#x) AS t1c#x]
:           :  +- Filter (t1a#x = outer(t0a#x))
:           :     +- SubqueryAlias t1
:           :        +- View (`t1`, [t1a#x, t1b#x, t1c#x])
:           :           +- Project [cast(col1#x as int) AS t1a#x, cast(col2#x as int) AS t1b#x, cast(col3#x as int) AS t1c#x]
:           :              +- LocalRelation [col1#x, col2#x, col3#x]
:           +- Project [outer(t0a#x) AS t2b#x, t2c#x AS t1a#x, outer(t0b#x) AS t2c#x]
:              +- Filter (t2b#x = outer(t0b#x))
:                 +- SubqueryAlias t2
:                    +- View (`t2`, [t2a#x, t2b#x, t2c#x])
:                       +- Project [cast(col1#x as int) AS t2a#x, cast(col2#x as int) AS t2b#x, cast(col3#x as int) AS t2c#x]
:                          +- LocalRelation [col1#x, col2#x, col3#x]
+- SubqueryAlias t0
   +- View (`t0`, [t0a#x, t0b#x])
      +- Project [cast(col1#x as int) AS t0a#x, cast(col2#x as int) AS t0b#x]
         +- LocalRelation [col1#x, col2#x]


-- !query
SELECT t0a, (SELECT count(t1c) FROM
  (SELECT t1c
  FROM   t1
  WHERE  t1a = t0a
  UNION ALL
  SELECT t2c
  FROM   t2
  WHERE  t2b = t0b)
)
FROM t0
-- !query analysis
Project [t0a#x, scalar-subquery#x [t0a#x && t0b#x] AS scalarsubquery(t0a, t0b)#xL]
:  +- Aggregate [count(t1c#x) AS count(t1c)#xL]
:     +- SubqueryAlias __auto_generated_subquery_name
:        +- Union false, false
:           :- Project [t1c#x]
:           :  +- Filter (t1a#x = outer(t0a#x))
:           :     +- SubqueryAlias t1
:           :        +- View (`t1`, [t1a#x, t1b#x, t1c#x])
:           :           +- Project [cast(col1#x as int) AS t1a#x, cast(col2#x as int) AS t1b#x, cast(col3#x as int) AS t1c#x]
:           :              +- LocalRelation [col1#x, col2#x, col3#x]
:           +- Project [t2c#x]
:              +- Filter (t2b#x = outer(t0b#x))
:                 +- SubqueryAlias t2
:                    +- View (`t2`, [t2a#x, t2b#x, t2c#x])
:                       +- Project [cast(col1#x as int) AS t2a#x, cast(col2#x as int) AS t2b#x, cast(col3#x as int) AS t2c#x]
:                          +- LocalRelation [col1#x, col2#x, col3#x]
+- SubqueryAlias t0
   +- View (`t0`, [t0a#x, t0b#x])
      +- Project [cast(col1#x as int) AS t0a#x, cast(col2#x as int) AS t0b#x]
         +- LocalRelation [col1#x, col2#x]


-- !query
SELECT t0a, (SELECT sum(d) FROM
  (SELECT t1a - t0a as d
  FROM   t1
  UNION ALL
  SELECT t2a - t0a as d
  FROM   t2)
)
FROM t0
-- !query analysis
Project [t0a#x, scalar-subquery#x [t0a#x && t0a#x] AS scalarsubquery(t0a, t0a)#xL]
:  +- Aggregate [sum(d#x) AS sum(d)#xL]
:     +- SubqueryAlias __auto_generated_subquery_name
:        +- Union false, false
:           :- Project [(t1a#x - outer(t0a#x)) AS d#x]
:           :  +- SubqueryAlias t1
:           :     +- View (`t1`, [t1a#x, t1b#x, t1c#x])
:           :        +- Project [cast(col1#x as int) AS t1a#x, cast(col2#x as int) AS t1b#x, cast(col3#x as int) AS t1c#x]
:           :           +- LocalRelation [col1#x, col2#x, col3#x]
:           +- Project [(t2a#x - outer(t0a#x)) AS d#x]
:              +- SubqueryAlias t2
:                 +- View (`t2`, [t2a#x, t2b#x, t2c#x])
:                    +- Project [cast(col1#x as int) AS t2a#x, cast(col2#x as int) AS t2b#x, cast(col3#x as int) AS t2c#x]
:                       +- LocalRelation [col1#x, col2#x, col3#x]
+- SubqueryAlias t0
   +- View (`t0`, [t0a#x, t0b#x])
      +- Project [cast(col1#x as int) AS t0a#x, cast(col2#x as int) AS t0b#x]
         +- LocalRelation [col1#x, col2#x]


-- !query
SELECT t0a, (SELECT sum(d) FROM
  (SELECT sum(t0a) as d
  FROM   t1
  UNION ALL
  SELECT sum(t2a) + t0a as d
  FROM   t2)
)
FROM t0
-- !query analysis
org.apache.spark.sql.catalyst.ExtendedAnalysisException
{
  "errorClass" : "UNSUPPORTED_SUBQUERY_EXPRESSION_CATEGORY.CORRELATED_REFERENCE",
  "sqlState" : "0A000",
  "messageParameters" : {
    "sqlExprs" : "\"sum(t0a) AS d\""
  },
  "queryContext" : [ {
    "objectType" : "",
    "objectName" : "",
    "startIndex" : 36,
    "stopIndex" : 67,
    "fragment" : "SELECT sum(t0a) as d\n  FROM   t1"
  } ]
}


-- !query
SELECT t0a, (SELECT sum(c) FROM
  (SELECT t1c as c
  FROM   t1
  WHERE  t1a = t0a
  UNION DISTINCT
  SELECT t2c as c
  FROM   t2
  WHERE  t2b = t0b)
)
FROM t0
-- !query analysis
Project [t0a#x, scalar-subquery#x [t0a#x && t0b#x] AS scalarsubquery(t0a, t0b)#xL]
:  +- Aggregate [sum(c#x) AS sum(c)#xL]
:     +- SubqueryAlias __auto_generated_subquery_name
:        +- Distinct
:           +- Union false, false
:              :- Project [t1c#x AS c#x]
:              :  +- Filter (t1a#x = outer(t0a#x))
:              :     +- SubqueryAlias t1
:              :        +- View (`t1`, [t1a#x, t1b#x, t1c#x])
:              :           +- Project [cast(col1#x as int) AS t1a#x, cast(col2#x as int) AS t1b#x, cast(col3#x as int) AS t1c#x]
:              :              +- LocalRelation [col1#x, col2#x, col3#x]
:              +- Project [t2c#x AS c#x]
:                 +- Filter (t2b#x = outer(t0b#x))
:                    +- SubqueryAlias t2
:                       +- View (`t2`, [t2a#x, t2b#x, t2c#x])
:                          +- Project [cast(col1#x as int) AS t2a#x, cast(col2#x as int) AS t2b#x, cast(col3#x as int) AS t2c#x]
:                             +- LocalRelation [col1#x, col2#x, col3#x]
+- SubqueryAlias t0
   +- View (`t0`, [t0a#x, t0b#x])
      +- Project [cast(col1#x as int) AS t0a#x, cast(col2#x as int) AS t0b#x]
         +- LocalRelation [col1#x, col2#x]


-- !query
SELECT * FROM t0 WHERE t0a <
(SELECT sum(c) FROM
  (SELECT t1c as c
  FROM   t1
  WHERE  t1a = t0a
  UNION DISTINCT
  SELECT t2c as c
  FROM   t2
  WHERE  t2b = t0b)
)
-- !query analysis
Project [t0a#x, t0b#x]
+- Filter (cast(t0a#x as bigint) < scalar-subquery#x [t0a#x && t0b#x])
   :  +- Aggregate [sum(c#x) AS sum(c)#xL]
   :     +- SubqueryAlias __auto_generated_subquery_name
   :        +- Distinct
   :           +- Union false, false
   :              :- Project [t1c#x AS c#x]
   :              :  +- Filter (t1a#x = outer(t0a#x))
   :              :     +- SubqueryAlias t1
   :              :        +- View (`t1`, [t1a#x, t1b#x, t1c#x])
   :              :           +- Project [cast(col1#x as int) AS t1a#x, cast(col2#x as int) AS t1b#x, cast(col3#x as int) AS t1c#x]
   :              :              +- LocalRelation [col1#x, col2#x, col3#x]
   :              +- Project [t2c#x AS c#x]
   :                 +- Filter (t2b#x = outer(t0b#x))
   :                    +- SubqueryAlias t2
   :                       +- View (`t2`, [t2a#x, t2b#x, t2c#x])
   :                          +- Project [cast(col1#x as int) AS t2a#x, cast(col2#x as int) AS t2b#x, cast(col3#x as int) AS t2c#x]
   :                             +- LocalRelation [col1#x, col2#x, col3#x]
   +- SubqueryAlias t0
      +- View (`t0`, [t0a#x, t0b#x])
         +- Project [cast(col1#x as int) AS t0a#x, cast(col2#x as int) AS t0b#x]
            +- LocalRelation [col1#x, col2#x]


-- !query
SELECT t0a, (SELECT sum(c) FROM
  (SELECT t1c as c
  FROM   t1
  WHERE  t1a = t0a
  UNION DISTINCT
  SELECT t2c as c
  FROM   t2
  WHERE  t2a = t0a)
)
FROM t0
-- !query analysis
Project [t0a#x, scalar-subquery#x [t0a#x && t0a#x] AS scalarsubquery(t0a, t0a)#xL]
:  +- Aggregate [sum(c#x) AS sum(c)#xL]
:     +- SubqueryAlias __auto_generated_subquery_name
:        +- Distinct
:           +- Union false, false
:              :- Project [t1c#x AS c#x]
:              :  +- Filter (t1a#x = outer(t0a#x))
:              :     +- SubqueryAlias t1
:              :        +- View (`t1`, [t1a#x, t1b#x, t1c#x])
:              :           +- Project [cast(col1#x as int) AS t1a#x, cast(col2#x as int) AS t1b#x, cast(col3#x as int) AS t1c#x]
:              :              +- LocalRelation [col1#x, col2#x, col3#x]
:              +- Project [t2c#x AS c#x]
:                 +- Filter (t2a#x = outer(t0a#x))
:                    +- SubqueryAlias t2
:                       +- View (`t2`, [t2a#x, t2b#x, t2c#x])
:                          +- Project [cast(col1#x as int) AS t2a#x, cast(col2#x as int) AS t2b#x, cast(col3#x as int) AS t2c#x]
:                             +- LocalRelation [col1#x, col2#x, col3#x]
+- SubqueryAlias t0
   +- View (`t0`, [t0a#x, t0b#x])
      +- Project [cast(col1#x as int) AS t0a#x, cast(col2#x as int) AS t0b#x]
         +- LocalRelation [col1#x, col2#x]


-- !query
SELECT t0a, (SELECT sum(c) FROM
  (SELECT t1c as c
  FROM   t1
  WHERE  t1a > t0a
  UNION DISTINCT
  SELECT t2c as c
  FROM   t2
  WHERE  t2b <= t0b)
)
FROM t0
-- !query analysis
Project [t0a#x, scalar-subquery#x [t0a#x && t0b#x] AS scalarsubquery(t0a, t0b)#xL]
:  +- Aggregate [sum(c#x) AS sum(c)#xL]
:     +- SubqueryAlias __auto_generated_subquery_name
:        +- Distinct
:           +- Union false, false
:              :- Project [t1c#x AS c#x]
:              :  +- Filter (t1a#x > outer(t0a#x))
:              :     +- SubqueryAlias t1
:              :        +- View (`t1`, [t1a#x, t1b#x, t1c#x])
:              :           +- Project [cast(col1#x as int) AS t1a#x, cast(col2#x as int) AS t1b#x, cast(col3#x as int) AS t1c#x]
:              :              +- LocalRelation [col1#x, col2#x, col3#x]
:              +- Project [t2c#x AS c#x]
:                 +- Filter (t2b#x <= outer(t0b#x))
:                    +- SubqueryAlias t2
:                       +- View (`t2`, [t2a#x, t2b#x, t2c#x])
:                          +- Project [cast(col1#x as int) AS t2a#x, cast(col2#x as int) AS t2b#x, cast(col3#x as int) AS t2c#x]
:                             +- LocalRelation [col1#x, col2#x, col3#x]
+- SubqueryAlias t0
   +- View (`t0`, [t0a#x, t0b#x])
      +- Project [cast(col1#x as int) AS t0a#x, cast(col2#x as int) AS t0b#x]
         +- LocalRelation [col1#x, col2#x]


-- !query
SELECT t0a, (SELECT sum(t1c) FROM
  (SELECT t1c
  FROM   t1
  WHERE  t1a = t0a
  UNION DISTINCT
  SELECT t2c
  FROM   t2
  WHERE  t2b = t0b)
)
FROM t0
-- !query analysis
Project [t0a#x, scalar-subquery#x [t0a#x && t0b#x] AS scalarsubquery(t0a, t0b)#xL]
:  +- Aggregate [sum(t1c#x) AS sum(t1c)#xL]
:     +- SubqueryAlias __auto_generated_subquery_name
:        +- Distinct
:           +- Union false, false
:              :- Project [t1c#x]
:              :  +- Filter (t1a#x = outer(t0a#x))
:              :     +- SubqueryAlias t1
:              :        +- View (`t1`, [t1a#x, t1b#x, t1c#x])
:              :           +- Project [cast(col1#x as int) AS t1a#x, cast(col2#x as int) AS t1b#x, cast(col3#x as int) AS t1c#x]
:              :              +- LocalRelation [col1#x, col2#x, col3#x]
:              +- Project [t2c#x]
:                 +- Filter (t2b#x = outer(t0b#x))
:                    +- SubqueryAlias t2
:                       +- View (`t2`, [t2a#x, t2b#x, t2c#x])
:                          +- Project [cast(col1#x as int) AS t2a#x, cast(col2#x as int) AS t2b#x, cast(col3#x as int) AS t2c#x]
:                             +- LocalRelation [col1#x, col2#x, col3#x]
+- SubqueryAlias t0
   +- View (`t0`, [t0a#x, t0b#x])
      +- Project [cast(col1#x as int) AS t0a#x, cast(col2#x as int) AS t0b#x]
         +- LocalRelation [col1#x, col2#x]


-- !query
SELECT t0a, (SELECT sum(t1a + 3 * t1b + 5 * t1c) FROM
  (SELECT t1c as t1a, t1a as t1b, t0a as t1c
  FROM   t1
  WHERE  t1a = t0a
  UNION DISTINCT
  SELECT t0a as t2b, t2c as t1a, t0b as t2c
  FROM   t2
  WHERE  t2b = t0b)
)
FROM t0
-- !query analysis
Project [t0a#x, scalar-subquery#x [t0a#x && t0a#x && t0a#x && t0b#x && t0b#x] AS scalarsubquery(t0a, t0a, t0a, t0b, t0b)#xL]
:  +- Aggregate [sum(((t1a#x + (3 * t1b#x)) + (5 * t1c#x))) AS sum(((t1a + (3 * t1b)) + (5 * t1c)))#xL]
:     +- SubqueryAlias __auto_generated_subquery_name
:        +- Distinct
:           +- Union false, false
:              :- Project [t1c#x AS t1a#x, t1a#x AS t1b#x, outer(t0a#x) AS t1c#x]
:              :  +- Filter (t1a#x = outer(t0a#x))
:              :     +- SubqueryAlias t1
:              :        +- View (`t1`, [t1a#x, t1b#x, t1c#x])
:              :           +- Project [cast(col1#x as int) AS t1a#x, cast(col2#x as int) AS t1b#x, cast(col3#x as int) AS t1c#x]
:              :              +- LocalRelation [col1#x, col2#x, col3#x]
:              +- Project [outer(t0a#x) AS t2b#x, t2c#x AS t1a#x, outer(t0b#x) AS t2c#x]
:                 +- Filter (t2b#x = outer(t0b#x))
:                    +- SubqueryAlias t2
:                       +- View (`t2`, [t2a#x, t2b#x, t2c#x])
:                          +- Project [cast(col1#x as int) AS t2a#x, cast(col2#x as int) AS t2b#x, cast(col3#x as int) AS t2c#x]
:                             +- LocalRelation [col1#x, col2#x, col3#x]
+- SubqueryAlias t0
   +- View (`t0`, [t0a#x, t0b#x])
      +- Project [cast(col1#x as int) AS t0a#x, cast(col2#x as int) AS t0b#x]
         +- LocalRelation [col1#x, col2#x]


-- !query
SELECT t0a, (SELECT count(t1c) FROM
  (SELECT t1c
  FROM   t1
  WHERE  t1a = t0a
  UNION DISTINCT
  SELECT t2c
  FROM   t2
  WHERE  t2b = t0b)
)
FROM t0
-- !query analysis
Project [t0a#x, scalar-subquery#x [t0a#x && t0b#x] AS scalarsubquery(t0a, t0b)#xL]
:  +- Aggregate [count(t1c#x) AS count(t1c)#xL]
:     +- SubqueryAlias __auto_generated_subquery_name
:        +- Distinct
:           +- Union false, false
:              :- Project [t1c#x]
:              :  +- Filter (t1a#x = outer(t0a#x))
:              :     +- SubqueryAlias t1
:              :        +- View (`t1`, [t1a#x, t1b#x, t1c#x])
:              :           +- Project [cast(col1#x as int) AS t1a#x, cast(col2#x as int) AS t1b#x, cast(col3#x as int) AS t1c#x]
:              :              +- LocalRelation [col1#x, col2#x, col3#x]
:              +- Project [t2c#x]
:                 +- Filter (t2b#x = outer(t0b#x))
:                    +- SubqueryAlias t2
:                       +- View (`t2`, [t2a#x, t2b#x, t2c#x])
:                          +- Project [cast(col1#x as int) AS t2a#x, cast(col2#x as int) AS t2b#x, cast(col3#x as int) AS t2c#x]
:                             +- LocalRelation [col1#x, col2#x, col3#x]
+- SubqueryAlias t0
   +- View (`t0`, [t0a#x, t0b#x])
      +- Project [cast(col1#x as int) AS t0a#x, cast(col2#x as int) AS t0b#x]
         +- LocalRelation [col1#x, col2#x]


-- !query
SELECT t0a, (SELECT sum(d) FROM
  (SELECT t1a - t0a as d
  FROM   t1
  UNION DISTINCT
  SELECT t2a - t0a as d
  FROM   t2)
)
FROM t0
-- !query analysis
Project [t0a#x, scalar-subquery#x [t0a#x && t0a#x] AS scalarsubquery(t0a, t0a)#xL]
:  +- Aggregate [sum(d#x) AS sum(d)#xL]
:     +- SubqueryAlias __auto_generated_subquery_name
:        +- Distinct
:           +- Union false, false
:              :- Project [(t1a#x - outer(t0a#x)) AS d#x]
:              :  +- SubqueryAlias t1
:              :     +- View (`t1`, [t1a#x, t1b#x, t1c#x])
:              :        +- Project [cast(col1#x as int) AS t1a#x, cast(col2#x as int) AS t1b#x, cast(col3#x as int) AS t1c#x]
:              :           +- LocalRelation [col1#x, col2#x, col3#x]
:              +- Project [(t2a#x - outer(t0a#x)) AS d#x]
:                 +- SubqueryAlias t2
:                    +- View (`t2`, [t2a#x, t2b#x, t2c#x])
:                       +- Project [cast(col1#x as int) AS t2a#x, cast(col2#x as int) AS t2b#x, cast(col3#x as int) AS t2c#x]
:                          +- LocalRelation [col1#x, col2#x, col3#x]
+- SubqueryAlias t0
   +- View (`t0`, [t0a#x, t0b#x])
      +- Project [cast(col1#x as int) AS t0a#x, cast(col2#x as int) AS t0b#x]
         +- LocalRelation [col1#x, col2#x]


-- !query
SELECT t0a, (SELECT sum(d) FROM
  (SELECT sum(t0a) as d
  FROM   t1
  UNION DISTINCT
  SELECT sum(t2a) + t0a as d
  FROM   t2)
)
FROM t0
-- !query analysis
org.apache.spark.sql.catalyst.ExtendedAnalysisException
{
  "errorClass" : "UNSUPPORTED_SUBQUERY_EXPRESSION_CATEGORY.CORRELATED_REFERENCE",
  "sqlState" : "0A000",
  "messageParameters" : {
    "sqlExprs" : "\"sum(t0a) AS d\""
  },
  "queryContext" : [ {
    "objectType" : "",
    "objectName" : "",
    "startIndex" : 36,
    "stopIndex" : 67,
    "fragment" : "SELECT sum(t0a) as d\n  FROM   t1"
  } ]
}


-- !query
SELECT t0a, (SELECT sum(c) FROM
  (SELECT t1c as c
  FROM   t1
  WHERE  t1a = t0a
  INTERSECT ALL
  SELECT t2c as c
  FROM   t2
  WHERE  t2b = t0b)
)
FROM t0
-- !query analysis
Project [t0a#x, scalar-subquery#x [t0a#x && t0b#x] AS scalarsubquery(t0a, t0b)#xL]
:  +- Aggregate [sum(c#x) AS sum(c)#xL]
:     +- SubqueryAlias __auto_generated_subquery_name
:        +- Intersect All true
:           :- Project [t1c#x AS c#x]
:           :  +- Filter (t1a#x = outer(t0a#x))
:           :     +- SubqueryAlias t1
:           :        +- View (`t1`, [t1a#x, t1b#x, t1c#x])
:           :           +- Project [cast(col1#x as int) AS t1a#x, cast(col2#x as int) AS t1b#x, cast(col3#x as int) AS t1c#x]
:           :              +- LocalRelation [col1#x, col2#x, col3#x]
:           +- Project [t2c#x AS c#x]
:              +- Filter (t2b#x = outer(t0b#x))
:                 +- SubqueryAlias t2
:                    +- View (`t2`, [t2a#x, t2b#x, t2c#x])
:                       +- Project [cast(col1#x as int) AS t2a#x, cast(col2#x as int) AS t2b#x, cast(col3#x as int) AS t2c#x]
:                          +- LocalRelation [col1#x, col2#x, col3#x]
+- SubqueryAlias t0
   +- View (`t0`, [t0a#x, t0b#x])
      +- Project [cast(col1#x as int) AS t0a#x, cast(col2#x as int) AS t0b#x]
         +- LocalRelation [col1#x, col2#x]


-- !query
SELECT * FROM t0 WHERE t0a <
(SELECT sum(c) FROM
  (SELECT t1c as c
  FROM   t1
  WHERE  t1a = t0a
  INTERSECT ALL
  SELECT t2c as c
  FROM   t2
  WHERE  t2b = t0b)
)
-- !query analysis
Project [t0a#x, t0b#x]
+- Filter (cast(t0a#x as bigint) < scalar-subquery#x [t0a#x && t0b#x])
   :  +- Aggregate [sum(c#x) AS sum(c)#xL]
   :     +- SubqueryAlias __auto_generated_subquery_name
   :        +- Intersect All true
   :           :- Project [t1c#x AS c#x]
   :           :  +- Filter (t1a#x = outer(t0a#x))
   :           :     +- SubqueryAlias t1
   :           :        +- View (`t1`, [t1a#x, t1b#x, t1c#x])
   :           :           +- Project [cast(col1#x as int) AS t1a#x, cast(col2#x as int) AS t1b#x, cast(col3#x as int) AS t1c#x]
   :           :              +- LocalRelation [col1#x, col2#x, col3#x]
   :           +- Project [t2c#x AS c#x]
   :              +- Filter (t2b#x = outer(t0b#x))
   :                 +- SubqueryAlias t2
   :                    +- View (`t2`, [t2a#x, t2b#x, t2c#x])
   :                       +- Project [cast(col1#x as int) AS t2a#x, cast(col2#x as int) AS t2b#x, cast(col3#x as int) AS t2c#x]
   :                          +- LocalRelation [col1#x, col2#x, col3#x]
   +- SubqueryAlias t0
      +- View (`t0`, [t0a#x, t0b#x])
         +- Project [cast(col1#x as int) AS t0a#x, cast(col2#x as int) AS t0b#x]
            +- LocalRelation [col1#x, col2#x]


-- !query
SELECT t0a, (SELECT sum(c) FROM
  (SELECT t1c as c
  FROM   t1
  WHERE  t1a = t0a
  INTERSECT ALL
  SELECT t2c as c
  FROM   t2
  WHERE  t2a = t0a)
)
FROM t0
-- !query analysis
Project [t0a#x, scalar-subquery#x [t0a#x && t0a#x] AS scalarsubquery(t0a, t0a)#xL]
:  +- Aggregate [sum(c#x) AS sum(c)#xL]
:     +- SubqueryAlias __auto_generated_subquery_name
:        +- Intersect All true
:           :- Project [t1c#x AS c#x]
:           :  +- Filter (t1a#x = outer(t0a#x))
:           :     +- SubqueryAlias t1
:           :        +- View (`t1`, [t1a#x, t1b#x, t1c#x])
:           :           +- Project [cast(col1#x as int) AS t1a#x, cast(col2#x as int) AS t1b#x, cast(col3#x as int) AS t1c#x]
:           :              +- LocalRelation [col1#x, col2#x, col3#x]
:           +- Project [t2c#x AS c#x]
:              +- Filter (t2a#x = outer(t0a#x))
:                 +- SubqueryAlias t2
:                    +- View (`t2`, [t2a#x, t2b#x, t2c#x])
:                       +- Project [cast(col1#x as int) AS t2a#x, cast(col2#x as int) AS t2b#x, cast(col3#x as int) AS t2c#x]
:                          +- LocalRelation [col1#x, col2#x, col3#x]
+- SubqueryAlias t0
   +- View (`t0`, [t0a#x, t0b#x])
      +- Project [cast(col1#x as int) AS t0a#x, cast(col2#x as int) AS t0b#x]
         +- LocalRelation [col1#x, col2#x]


-- !query
SELECT t0a, (SELECT sum(c) FROM
  (SELECT t1c as c
  FROM   t1
  WHERE  t1a > t0a
  INTERSECT ALL
  SELECT t2c as c
  FROM   t2
  WHERE  t2b <= t0b)
)
FROM t0
-- !query analysis
Project [t0a#x, scalar-subquery#x [t0a#x && t0b#x] AS scalarsubquery(t0a, t0b)#xL]
:  +- Aggregate [sum(c#x) AS sum(c)#xL]
:     +- SubqueryAlias __auto_generated_subquery_name
:        +- Intersect All true
:           :- Project [t1c#x AS c#x]
:           :  +- Filter (t1a#x > outer(t0a#x))
:           :     +- SubqueryAlias t1
:           :        +- View (`t1`, [t1a#x, t1b#x, t1c#x])
:           :           +- Project [cast(col1#x as int) AS t1a#x, cast(col2#x as int) AS t1b#x, cast(col3#x as int) AS t1c#x]
:           :              +- LocalRelation [col1#x, col2#x, col3#x]
:           +- Project [t2c#x AS c#x]
:              +- Filter (t2b#x <= outer(t0b#x))
:                 +- SubqueryAlias t2
:                    +- View (`t2`, [t2a#x, t2b#x, t2c#x])
:                       +- Project [cast(col1#x as int) AS t2a#x, cast(col2#x as int) AS t2b#x, cast(col3#x as int) AS t2c#x]
:                          +- LocalRelation [col1#x, col2#x, col3#x]
+- SubqueryAlias t0
   +- View (`t0`, [t0a#x, t0b#x])
      +- Project [cast(col1#x as int) AS t0a#x, cast(col2#x as int) AS t0b#x]
         +- LocalRelation [col1#x, col2#x]


-- !query
SELECT t0a, (SELECT sum(t1c) FROM
  (SELECT t1c
  FROM   t1
  WHERE  t1a = t0a
  INTERSECT ALL
  SELECT t2c
  FROM   t2
  WHERE  t2b = t0b)
)
FROM t0
-- !query analysis
Project [t0a#x, scalar-subquery#x [t0a#x && t0b#x] AS scalarsubquery(t0a, t0b)#xL]
:  +- Aggregate [sum(t1c#x) AS sum(t1c)#xL]
:     +- SubqueryAlias __auto_generated_subquery_name
:        +- Intersect All true
:           :- Project [t1c#x]
:           :  +- Filter (t1a#x = outer(t0a#x))
:           :     +- SubqueryAlias t1
:           :        +- View (`t1`, [t1a#x, t1b#x, t1c#x])
:           :           +- Project [cast(col1#x as int) AS t1a#x, cast(col2#x as int) AS t1b#x, cast(col3#x as int) AS t1c#x]
:           :              +- LocalRelation [col1#x, col2#x, col3#x]
:           +- Project [t2c#x]
:              +- Filter (t2b#x = outer(t0b#x))
:                 +- SubqueryAlias t2
:                    +- View (`t2`, [t2a#x, t2b#x, t2c#x])
:                       +- Project [cast(col1#x as int) AS t2a#x, cast(col2#x as int) AS t2b#x, cast(col3#x as int) AS t2c#x]
:                          +- LocalRelation [col1#x, col2#x, col3#x]
+- SubqueryAlias t0
   +- View (`t0`, [t0a#x, t0b#x])
      +- Project [cast(col1#x as int) AS t0a#x, cast(col2#x as int) AS t0b#x]
         +- LocalRelation [col1#x, col2#x]


-- !query
SELECT t0a, (SELECT sum(t1a + 3 * t1b + 5 * t1c) FROM
  (SELECT t1c as t1a, t1a as t1b, t0a as t1c
  FROM   t1
  WHERE  t1a = t0a
  INTERSECT ALL
  SELECT t0a as t2b, t2c as t1a, t0b as t2c
  FROM   t2
  WHERE  t2b = t0b)
)
FROM t0
-- !query analysis
Project [t0a#x, scalar-subquery#x [t0a#x && t0a#x && t0a#x && t0b#x && t0b#x] AS scalarsubquery(t0a, t0a, t0a, t0b, t0b)#xL]
:  +- Aggregate [sum(((t1a#x + (3 * t1b#x)) + (5 * t1c#x))) AS sum(((t1a + (3 * t1b)) + (5 * t1c)))#xL]
:     +- SubqueryAlias __auto_generated_subquery_name
:        +- Intersect All true
:           :- Project [t1c#x AS t1a#x, t1a#x AS t1b#x, outer(t0a#x) AS t1c#x]
:           :  +- Filter (t1a#x = outer(t0a#x))
:           :     +- SubqueryAlias t1
:           :        +- View (`t1`, [t1a#x, t1b#x, t1c#x])
:           :           +- Project [cast(col1#x as int) AS t1a#x, cast(col2#x as int) AS t1b#x, cast(col3#x as int) AS t1c#x]
:           :              +- LocalRelation [col1#x, col2#x, col3#x]
:           +- Project [outer(t0a#x) AS t2b#x, t2c#x AS t1a#x, outer(t0b#x) AS t2c#x]
:              +- Filter (t2b#x = outer(t0b#x))
:                 +- SubqueryAlias t2
:                    +- View (`t2`, [t2a#x, t2b#x, t2c#x])
:                       +- Project [cast(col1#x as int) AS t2a#x, cast(col2#x as int) AS t2b#x, cast(col3#x as int) AS t2c#x]
:                          +- LocalRelation [col1#x, col2#x, col3#x]
+- SubqueryAlias t0
   +- View (`t0`, [t0a#x, t0b#x])
      +- Project [cast(col1#x as int) AS t0a#x, cast(col2#x as int) AS t0b#x]
         +- LocalRelation [col1#x, col2#x]


-- !query
SELECT t0a, (SELECT count(t1c) FROM
  (SELECT t1c
  FROM   t1
  WHERE  t1a = t0a
  INTERSECT ALL
  SELECT t2c
  FROM   t2
  WHERE  t2b = t0b)
)
FROM t0
-- !query analysis
Project [t0a#x, scalar-subquery#x [t0a#x && t0b#x] AS scalarsubquery(t0a, t0b)#xL]
:  +- Aggregate [count(t1c#x) AS count(t1c)#xL]
:     +- SubqueryAlias __auto_generated_subquery_name
:        +- Intersect All true
:           :- Project [t1c#x]
:           :  +- Filter (t1a#x = outer(t0a#x))
:           :     +- SubqueryAlias t1
:           :        +- View (`t1`, [t1a#x, t1b#x, t1c#x])
:           :           +- Project [cast(col1#x as int) AS t1a#x, cast(col2#x as int) AS t1b#x, cast(col3#x as int) AS t1c#x]
:           :              +- LocalRelation [col1#x, col2#x, col3#x]
:           +- Project [t2c#x]
:              +- Filter (t2b#x = outer(t0b#x))
:                 +- SubqueryAlias t2
:                    +- View (`t2`, [t2a#x, t2b#x, t2c#x])
:                       +- Project [cast(col1#x as int) AS t2a#x, cast(col2#x as int) AS t2b#x, cast(col3#x as int) AS t2c#x]
:                          +- LocalRelation [col1#x, col2#x, col3#x]
+- SubqueryAlias t0
   +- View (`t0`, [t0a#x, t0b#x])
      +- Project [cast(col1#x as int) AS t0a#x, cast(col2#x as int) AS t0b#x]
         +- LocalRelation [col1#x, col2#x]


-- !query
SELECT t0a, (SELECT sum(d) FROM
  (SELECT t1a - t0a as d
  FROM   t1
  INTERSECT ALL
  SELECT t2a - t0a as d
  FROM   t2)
)
FROM t0
-- !query analysis
Project [t0a#x, scalar-subquery#x [t0a#x && t0a#x] AS scalarsubquery(t0a, t0a)#xL]
:  +- Aggregate [sum(d#x) AS sum(d)#xL]
:     +- SubqueryAlias __auto_generated_subquery_name
:        +- Intersect All true
:           :- Project [(t1a#x - outer(t0a#x)) AS d#x]
:           :  +- SubqueryAlias t1
:           :     +- View (`t1`, [t1a#x, t1b#x, t1c#x])
:           :        +- Project [cast(col1#x as int) AS t1a#x, cast(col2#x as int) AS t1b#x, cast(col3#x as int) AS t1c#x]
:           :           +- LocalRelation [col1#x, col2#x, col3#x]
:           +- Project [(t2a#x - outer(t0a#x)) AS d#x]
:              +- SubqueryAlias t2
:                 +- View (`t2`, [t2a#x, t2b#x, t2c#x])
:                    +- Project [cast(col1#x as int) AS t2a#x, cast(col2#x as int) AS t2b#x, cast(col3#x as int) AS t2c#x]
:                       +- LocalRelation [col1#x, col2#x, col3#x]
+- SubqueryAlias t0
   +- View (`t0`, [t0a#x, t0b#x])
      +- Project [cast(col1#x as int) AS t0a#x, cast(col2#x as int) AS t0b#x]
         +- LocalRelation [col1#x, col2#x]


-- !query
SELECT t0a, (SELECT sum(d) FROM
  (SELECT sum(t0a) as d
  FROM   t1
  INTERSECT ALL
  SELECT sum(t2a) + t0a as d
  FROM   t2)
)
FROM t0
-- !query analysis
org.apache.spark.sql.catalyst.ExtendedAnalysisException
{
  "errorClass" : "UNSUPPORTED_SUBQUERY_EXPRESSION_CATEGORY.CORRELATED_REFERENCE",
  "sqlState" : "0A000",
  "messageParameters" : {
    "sqlExprs" : "\"sum(t0a) AS d\""
  },
  "queryContext" : [ {
    "objectType" : "",
    "objectName" : "",
    "startIndex" : 36,
    "stopIndex" : 67,
    "fragment" : "SELECT sum(t0a) as d\n  FROM   t1"
  } ]
}


-- !query
SELECT t0a, (SELECT sum(c) FROM
  (SELECT t1c as c
  FROM   t1
  WHERE  t1a = t0a
  INTERSECT DISTINCT
  SELECT t2c as c
  FROM   t2
  WHERE  t2b = t0b)
)
FROM t0
-- !query analysis
Project [t0a#x, scalar-subquery#x [t0a#x && t0b#x] AS scalarsubquery(t0a, t0b)#xL]
:  +- Aggregate [sum(c#x) AS sum(c)#xL]
:     +- SubqueryAlias __auto_generated_subquery_name
:        +- Intersect false
:           :- Project [t1c#x AS c#x]
:           :  +- Filter (t1a#x = outer(t0a#x))
:           :     +- SubqueryAlias t1
:           :        +- View (`t1`, [t1a#x, t1b#x, t1c#x])
:           :           +- Project [cast(col1#x as int) AS t1a#x, cast(col2#x as int) AS t1b#x, cast(col3#x as int) AS t1c#x]
:           :              +- LocalRelation [col1#x, col2#x, col3#x]
:           +- Project [t2c#x AS c#x]
:              +- Filter (t2b#x = outer(t0b#x))
:                 +- SubqueryAlias t2
:                    +- View (`t2`, [t2a#x, t2b#x, t2c#x])
:                       +- Project [cast(col1#x as int) AS t2a#x, cast(col2#x as int) AS t2b#x, cast(col3#x as int) AS t2c#x]
:                          +- LocalRelation [col1#x, col2#x, col3#x]
+- SubqueryAlias t0
   +- View (`t0`, [t0a#x, t0b#x])
      +- Project [cast(col1#x as int) AS t0a#x, cast(col2#x as int) AS t0b#x]
         +- LocalRelation [col1#x, col2#x]


-- !query
SELECT * FROM t0 WHERE t0a <
(SELECT sum(c) FROM
  (SELECT t1c as c
  FROM   t1
  WHERE  t1a = t0a
  INTERSECT DISTINCT
  SELECT t2c as c
  FROM   t2
  WHERE  t2b = t0b)
)
-- !query analysis
Project [t0a#x, t0b#x]
+- Filter (cast(t0a#x as bigint) < scalar-subquery#x [t0a#x && t0b#x])
   :  +- Aggregate [sum(c#x) AS sum(c)#xL]
   :     +- SubqueryAlias __auto_generated_subquery_name
   :        +- Intersect false
   :           :- Project [t1c#x AS c#x]
   :           :  +- Filter (t1a#x = outer(t0a#x))
   :           :     +- SubqueryAlias t1
   :           :        +- View (`t1`, [t1a#x, t1b#x, t1c#x])
   :           :           +- Project [cast(col1#x as int) AS t1a#x, cast(col2#x as int) AS t1b#x, cast(col3#x as int) AS t1c#x]
   :           :              +- LocalRelation [col1#x, col2#x, col3#x]
   :           +- Project [t2c#x AS c#x]
   :              +- Filter (t2b#x = outer(t0b#x))
   :                 +- SubqueryAlias t2
   :                    +- View (`t2`, [t2a#x, t2b#x, t2c#x])
   :                       +- Project [cast(col1#x as int) AS t2a#x, cast(col2#x as int) AS t2b#x, cast(col3#x as int) AS t2c#x]
   :                          +- LocalRelation [col1#x, col2#x, col3#x]
   +- SubqueryAlias t0
      +- View (`t0`, [t0a#x, t0b#x])
         +- Project [cast(col1#x as int) AS t0a#x, cast(col2#x as int) AS t0b#x]
            +- LocalRelation [col1#x, col2#x]


-- !query
SELECT t0a, (SELECT sum(c) FROM
  (SELECT t1c as c
  FROM   t1
  WHERE  t1a = t0a
  INTERSECT DISTINCT
  SELECT t2c as c
  FROM   t2
  WHERE  t2a = t0a)
)
FROM t0
-- !query analysis
Project [t0a#x, scalar-subquery#x [t0a#x && t0a#x] AS scalarsubquery(t0a, t0a)#xL]
:  +- Aggregate [sum(c#x) AS sum(c)#xL]
:     +- SubqueryAlias __auto_generated_subquery_name
:        +- Intersect false
:           :- Project [t1c#x AS c#x]
:           :  +- Filter (t1a#x = outer(t0a#x))
:           :     +- SubqueryAlias t1
:           :        +- View (`t1`, [t1a#x, t1b#x, t1c#x])
:           :           +- Project [cast(col1#x as int) AS t1a#x, cast(col2#x as int) AS t1b#x, cast(col3#x as int) AS t1c#x]
:           :              +- LocalRelation [col1#x, col2#x, col3#x]
:           +- Project [t2c#x AS c#x]
:              +- Filter (t2a#x = outer(t0a#x))
:                 +- SubqueryAlias t2
:                    +- View (`t2`, [t2a#x, t2b#x, t2c#x])
:                       +- Project [cast(col1#x as int) AS t2a#x, cast(col2#x as int) AS t2b#x, cast(col3#x as int) AS t2c#x]
:                          +- LocalRelation [col1#x, col2#x, col3#x]
+- SubqueryAlias t0
   +- View (`t0`, [t0a#x, t0b#x])
      +- Project [cast(col1#x as int) AS t0a#x, cast(col2#x as int) AS t0b#x]
         +- LocalRelation [col1#x, col2#x]


-- !query
SELECT t0a, (SELECT sum(c) FROM
  (SELECT t1c as c
  FROM   t1
  WHERE  t1a > t0a
  INTERSECT DISTINCT
  SELECT t2c as c
  FROM   t2
  WHERE  t2b <= t0b)
)
FROM t0
-- !query analysis
Project [t0a#x, scalar-subquery#x [t0a#x && t0b#x] AS scalarsubquery(t0a, t0b)#xL]
:  +- Aggregate [sum(c#x) AS sum(c)#xL]
:     +- SubqueryAlias __auto_generated_subquery_name
:        +- Intersect false
:           :- Project [t1c#x AS c#x]
:           :  +- Filter (t1a#x > outer(t0a#x))
:           :     +- SubqueryAlias t1
:           :        +- View (`t1`, [t1a#x, t1b#x, t1c#x])
:           :           +- Project [cast(col1#x as int) AS t1a#x, cast(col2#x as int) AS t1b#x, cast(col3#x as int) AS t1c#x]
:           :              +- LocalRelation [col1#x, col2#x, col3#x]
:           +- Project [t2c#x AS c#x]
:              +- Filter (t2b#x <= outer(t0b#x))
:                 +- SubqueryAlias t2
:                    +- View (`t2`, [t2a#x, t2b#x, t2c#x])
:                       +- Project [cast(col1#x as int) AS t2a#x, cast(col2#x as int) AS t2b#x, cast(col3#x as int) AS t2c#x]
:                          +- LocalRelation [col1#x, col2#x, col3#x]
+- SubqueryAlias t0
   +- View (`t0`, [t0a#x, t0b#x])
      +- Project [cast(col1#x as int) AS t0a#x, cast(col2#x as int) AS t0b#x]
         +- LocalRelation [col1#x, col2#x]


-- !query
SELECT t0a, (SELECT sum(t1c) FROM
  (SELECT t1c
  FROM   t1
  WHERE  t1a = t0a
  INTERSECT DISTINCT
  SELECT t2c
  FROM   t2
  WHERE  t2b = t0b)
)
FROM t0
-- !query analysis
Project [t0a#x, scalar-subquery#x [t0a#x && t0b#x] AS scalarsubquery(t0a, t0b)#xL]
:  +- Aggregate [sum(t1c#x) AS sum(t1c)#xL]
:     +- SubqueryAlias __auto_generated_subquery_name
:        +- Intersect false
:           :- Project [t1c#x]
:           :  +- Filter (t1a#x = outer(t0a#x))
:           :     +- SubqueryAlias t1
:           :        +- View (`t1`, [t1a#x, t1b#x, t1c#x])
:           :           +- Project [cast(col1#x as int) AS t1a#x, cast(col2#x as int) AS t1b#x, cast(col3#x as int) AS t1c#x]
:           :              +- LocalRelation [col1#x, col2#x, col3#x]
:           +- Project [t2c#x]
:              +- Filter (t2b#x = outer(t0b#x))
:                 +- SubqueryAlias t2
:                    +- View (`t2`, [t2a#x, t2b#x, t2c#x])
:                       +- Project [cast(col1#x as int) AS t2a#x, cast(col2#x as int) AS t2b#x, cast(col3#x as int) AS t2c#x]
:                          +- LocalRelation [col1#x, col2#x, col3#x]
+- SubqueryAlias t0
   +- View (`t0`, [t0a#x, t0b#x])
      +- Project [cast(col1#x as int) AS t0a#x, cast(col2#x as int) AS t0b#x]
         +- LocalRelation [col1#x, col2#x]


-- !query
SELECT t0a, (SELECT sum(t1a + 3 * t1b + 5 * t1c) FROM
  (SELECT t1c as t1a, t1a as t1b, t0a as t1c
  FROM   t1
  WHERE  t1a = t0a
  INTERSECT DISTINCT
  SELECT t0a as t2b, t2c as t1a, t0b as t2c
  FROM   t2
  WHERE  t2b = t0b)
)
FROM t0
-- !query analysis
Project [t0a#x, scalar-subquery#x [t0a#x && t0a#x && t0a#x && t0b#x && t0b#x] AS scalarsubquery(t0a, t0a, t0a, t0b, t0b)#xL]
:  +- Aggregate [sum(((t1a#x + (3 * t1b#x)) + (5 * t1c#x))) AS sum(((t1a + (3 * t1b)) + (5 * t1c)))#xL]
:     +- SubqueryAlias __auto_generated_subquery_name
:        +- Intersect false
:           :- Project [t1c#x AS t1a#x, t1a#x AS t1b#x, outer(t0a#x) AS t1c#x]
:           :  +- Filter (t1a#x = outer(t0a#x))
:           :     +- SubqueryAlias t1
:           :        +- View (`t1`, [t1a#x, t1b#x, t1c#x])
:           :           +- Project [cast(col1#x as int) AS t1a#x, cast(col2#x as int) AS t1b#x, cast(col3#x as int) AS t1c#x]
:           :              +- LocalRelation [col1#x, col2#x, col3#x]
:           +- Project [outer(t0a#x) AS t2b#x, t2c#x AS t1a#x, outer(t0b#x) AS t2c#x]
:              +- Filter (t2b#x = outer(t0b#x))
:                 +- SubqueryAlias t2
:                    +- View (`t2`, [t2a#x, t2b#x, t2c#x])
:                       +- Project [cast(col1#x as int) AS t2a#x, cast(col2#x as int) AS t2b#x, cast(col3#x as int) AS t2c#x]
:                          +- LocalRelation [col1#x, col2#x, col3#x]
+- SubqueryAlias t0
   +- View (`t0`, [t0a#x, t0b#x])
      +- Project [cast(col1#x as int) AS t0a#x, cast(col2#x as int) AS t0b#x]
         +- LocalRelation [col1#x, col2#x]


-- !query
SELECT t0a, (SELECT count(t1c) FROM
  (SELECT t1c
  FROM   t1
  WHERE  t1a = t0a
  INTERSECT DISTINCT
  SELECT t2c
  FROM   t2
  WHERE  t2b = t0b)
)
FROM t0
-- !query analysis
Project [t0a#x, scalar-subquery#x [t0a#x && t0b#x] AS scalarsubquery(t0a, t0b)#xL]
:  +- Aggregate [count(t1c#x) AS count(t1c)#xL]
:     +- SubqueryAlias __auto_generated_subquery_name
:        +- Intersect false
:           :- Project [t1c#x]
:           :  +- Filter (t1a#x = outer(t0a#x))
:           :     +- SubqueryAlias t1
:           :        +- View (`t1`, [t1a#x, t1b#x, t1c#x])
:           :           +- Project [cast(col1#x as int) AS t1a#x, cast(col2#x as int) AS t1b#x, cast(col3#x as int) AS t1c#x]
:           :              +- LocalRelation [col1#x, col2#x, col3#x]
:           +- Project [t2c#x]
:              +- Filter (t2b#x = outer(t0b#x))
:                 +- SubqueryAlias t2
:                    +- View (`t2`, [t2a#x, t2b#x, t2c#x])
:                       +- Project [cast(col1#x as int) AS t2a#x, cast(col2#x as int) AS t2b#x, cast(col3#x as int) AS t2c#x]
:                          +- LocalRelation [col1#x, col2#x, col3#x]
+- SubqueryAlias t0
   +- View (`t0`, [t0a#x, t0b#x])
      +- Project [cast(col1#x as int) AS t0a#x, cast(col2#x as int) AS t0b#x]
         +- LocalRelation [col1#x, col2#x]


-- !query
SELECT t0a, (SELECT sum(d) FROM
  (SELECT t1a - t0a as d
  FROM   t1
  INTERSECT DISTINCT
  SELECT t2a - t0a as d
  FROM   t2)
)
FROM t0
-- !query analysis
Project [t0a#x, scalar-subquery#x [t0a#x && t0a#x] AS scalarsubquery(t0a, t0a)#xL]
:  +- Aggregate [sum(d#x) AS sum(d)#xL]
:     +- SubqueryAlias __auto_generated_subquery_name
:        +- Intersect false
:           :- Project [(t1a#x - outer(t0a#x)) AS d#x]
:           :  +- SubqueryAlias t1
:           :     +- View (`t1`, [t1a#x, t1b#x, t1c#x])
:           :        +- Project [cast(col1#x as int) AS t1a#x, cast(col2#x as int) AS t1b#x, cast(col3#x as int) AS t1c#x]
:           :           +- LocalRelation [col1#x, col2#x, col3#x]
:           +- Project [(t2a#x - outer(t0a#x)) AS d#x]
:              +- SubqueryAlias t2
:                 +- View (`t2`, [t2a#x, t2b#x, t2c#x])
:                    +- Project [cast(col1#x as int) AS t2a#x, cast(col2#x as int) AS t2b#x, cast(col3#x as int) AS t2c#x]
:                       +- LocalRelation [col1#x, col2#x, col3#x]
+- SubqueryAlias t0
   +- View (`t0`, [t0a#x, t0b#x])
      +- Project [cast(col1#x as int) AS t0a#x, cast(col2#x as int) AS t0b#x]
         +- LocalRelation [col1#x, col2#x]


-- !query
SELECT t0a, (SELECT sum(d) FROM
  (SELECT sum(t0a) as d
  FROM   t1
  INTERSECT DISTINCT
  SELECT sum(t2a) + t0a as d
  FROM   t2)
)
FROM t0
-- !query analysis
org.apache.spark.sql.catalyst.ExtendedAnalysisException
{
  "errorClass" : "UNSUPPORTED_SUBQUERY_EXPRESSION_CATEGORY.CORRELATED_REFERENCE",
  "sqlState" : "0A000",
  "messageParameters" : {
    "sqlExprs" : "\"sum(t0a) AS d\""
  },
  "queryContext" : [ {
    "objectType" : "",
    "objectName" : "",
    "startIndex" : 36,
    "stopIndex" : 67,
    "fragment" : "SELECT sum(t0a) as d\n  FROM   t1"
  } ]
}


-- !query
SELECT t0a, (SELECT sum(c) FROM
  (SELECT t1c as c
  FROM   t1
  WHERE  t1a = t0a
  EXCEPT ALL
  SELECT t2c as c
  FROM   t2
  WHERE  t2b = t0b)
)
FROM t0
-- !query analysis
Project [t0a#x, scalar-subquery#x [t0a#x && t0b#x] AS scalarsubquery(t0a, t0b)#xL]
:  +- Aggregate [sum(c#x) AS sum(c)#xL]
:     +- SubqueryAlias __auto_generated_subquery_name
:        +- Except All true
:           :- Project [t1c#x AS c#x]
:           :  +- Filter (t1a#x = outer(t0a#x))
:           :     +- SubqueryAlias t1
:           :        +- View (`t1`, [t1a#x, t1b#x, t1c#x])
:           :           +- Project [cast(col1#x as int) AS t1a#x, cast(col2#x as int) AS t1b#x, cast(col3#x as int) AS t1c#x]
:           :              +- LocalRelation [col1#x, col2#x, col3#x]
:           +- Project [t2c#x AS c#x]
:              +- Filter (t2b#x = outer(t0b#x))
:                 +- SubqueryAlias t2
:                    +- View (`t2`, [t2a#x, t2b#x, t2c#x])
:                       +- Project [cast(col1#x as int) AS t2a#x, cast(col2#x as int) AS t2b#x, cast(col3#x as int) AS t2c#x]
:                          +- LocalRelation [col1#x, col2#x, col3#x]
+- SubqueryAlias t0
   +- View (`t0`, [t0a#x, t0b#x])
      +- Project [cast(col1#x as int) AS t0a#x, cast(col2#x as int) AS t0b#x]
         +- LocalRelation [col1#x, col2#x]


-- !query
SELECT * FROM t0 WHERE t0a <
(SELECT sum(c) FROM
  (SELECT t1c as c
  FROM   t1
  WHERE  t1a = t0a
  EXCEPT ALL
  SELECT t2c as c
  FROM   t2
  WHERE  t2b = t0b)
)
-- !query analysis
Project [t0a#x, t0b#x]
+- Filter (cast(t0a#x as bigint) < scalar-subquery#x [t0a#x && t0b#x])
   :  +- Aggregate [sum(c#x) AS sum(c)#xL]
   :     +- SubqueryAlias __auto_generated_subquery_name
   :        +- Except All true
   :           :- Project [t1c#x AS c#x]
   :           :  +- Filter (t1a#x = outer(t0a#x))
   :           :     +- SubqueryAlias t1
   :           :        +- View (`t1`, [t1a#x, t1b#x, t1c#x])
   :           :           +- Project [cast(col1#x as int) AS t1a#x, cast(col2#x as int) AS t1b#x, cast(col3#x as int) AS t1c#x]
   :           :              +- LocalRelation [col1#x, col2#x, col3#x]
   :           +- Project [t2c#x AS c#x]
   :              +- Filter (t2b#x = outer(t0b#x))
   :                 +- SubqueryAlias t2
   :                    +- View (`t2`, [t2a#x, t2b#x, t2c#x])
   :                       +- Project [cast(col1#x as int) AS t2a#x, cast(col2#x as int) AS t2b#x, cast(col3#x as int) AS t2c#x]
   :                          +- LocalRelation [col1#x, col2#x, col3#x]
   +- SubqueryAlias t0
      +- View (`t0`, [t0a#x, t0b#x])
         +- Project [cast(col1#x as int) AS t0a#x, cast(col2#x as int) AS t0b#x]
            +- LocalRelation [col1#x, col2#x]


-- !query
SELECT t0a, (SELECT sum(c) FROM
  (SELECT t1c as c
  FROM   t1
  WHERE  t1a = t0a
  EXCEPT ALL
  SELECT t2c as c
  FROM   t2
  WHERE  t2a = t0a)
)
FROM t0
-- !query analysis
Project [t0a#x, scalar-subquery#x [t0a#x && t0a#x] AS scalarsubquery(t0a, t0a)#xL]
:  +- Aggregate [sum(c#x) AS sum(c)#xL]
:     +- SubqueryAlias __auto_generated_subquery_name
:        +- Except All true
:           :- Project [t1c#x AS c#x]
:           :  +- Filter (t1a#x = outer(t0a#x))
:           :     +- SubqueryAlias t1
:           :        +- View (`t1`, [t1a#x, t1b#x, t1c#x])
:           :           +- Project [cast(col1#x as int) AS t1a#x, cast(col2#x as int) AS t1b#x, cast(col3#x as int) AS t1c#x]
:           :              +- LocalRelation [col1#x, col2#x, col3#x]
:           +- Project [t2c#x AS c#x]
:              +- Filter (t2a#x = outer(t0a#x))
:                 +- SubqueryAlias t2
:                    +- View (`t2`, [t2a#x, t2b#x, t2c#x])
:                       +- Project [cast(col1#x as int) AS t2a#x, cast(col2#x as int) AS t2b#x, cast(col3#x as int) AS t2c#x]
:                          +- LocalRelation [col1#x, col2#x, col3#x]
+- SubqueryAlias t0
   +- View (`t0`, [t0a#x, t0b#x])
      +- Project [cast(col1#x as int) AS t0a#x, cast(col2#x as int) AS t0b#x]
         +- LocalRelation [col1#x, col2#x]


-- !query
SELECT t0a, (SELECT sum(c) FROM
  (SELECT t1c as c
  FROM   t1
  WHERE  t1a > t0a
  EXCEPT ALL
  SELECT t2c as c
  FROM   t2
  WHERE  t2b <= t0b)
)
FROM t0
-- !query analysis
Project [t0a#x, scalar-subquery#x [t0a#x && t0b#x] AS scalarsubquery(t0a, t0b)#xL]
:  +- Aggregate [sum(c#x) AS sum(c)#xL]
:     +- SubqueryAlias __auto_generated_subquery_name
:        +- Except All true
:           :- Project [t1c#x AS c#x]
:           :  +- Filter (t1a#x > outer(t0a#x))
:           :     +- SubqueryAlias t1
:           :        +- View (`t1`, [t1a#x, t1b#x, t1c#x])
:           :           +- Project [cast(col1#x as int) AS t1a#x, cast(col2#x as int) AS t1b#x, cast(col3#x as int) AS t1c#x]
:           :              +- LocalRelation [col1#x, col2#x, col3#x]
:           +- Project [t2c#x AS c#x]
:              +- Filter (t2b#x <= outer(t0b#x))
:                 +- SubqueryAlias t2
:                    +- View (`t2`, [t2a#x, t2b#x, t2c#x])
:                       +- Project [cast(col1#x as int) AS t2a#x, cast(col2#x as int) AS t2b#x, cast(col3#x as int) AS t2c#x]
:                          +- LocalRelation [col1#x, col2#x, col3#x]
+- SubqueryAlias t0
   +- View (`t0`, [t0a#x, t0b#x])
      +- Project [cast(col1#x as int) AS t0a#x, cast(col2#x as int) AS t0b#x]
         +- LocalRelation [col1#x, col2#x]


-- !query
SELECT t0a, (SELECT sum(t1c) FROM
  (SELECT t1c
  FROM   t1
  WHERE  t1a = t0a
  EXCEPT ALL
  SELECT t2c
  FROM   t2
  WHERE  t2b = t0b)
)
FROM t0
-- !query analysis
Project [t0a#x, scalar-subquery#x [t0a#x && t0b#x] AS scalarsubquery(t0a, t0b)#xL]
:  +- Aggregate [sum(t1c#x) AS sum(t1c)#xL]
:     +- SubqueryAlias __auto_generated_subquery_name
:        +- Except All true
:           :- Project [t1c#x]
:           :  +- Filter (t1a#x = outer(t0a#x))
:           :     +- SubqueryAlias t1
:           :        +- View (`t1`, [t1a#x, t1b#x, t1c#x])
:           :           +- Project [cast(col1#x as int) AS t1a#x, cast(col2#x as int) AS t1b#x, cast(col3#x as int) AS t1c#x]
:           :              +- LocalRelation [col1#x, col2#x, col3#x]
:           +- Project [t2c#x]
:              +- Filter (t2b#x = outer(t0b#x))
:                 +- SubqueryAlias t2
:                    +- View (`t2`, [t2a#x, t2b#x, t2c#x])
:                       +- Project [cast(col1#x as int) AS t2a#x, cast(col2#x as int) AS t2b#x, cast(col3#x as int) AS t2c#x]
:                          +- LocalRelation [col1#x, col2#x, col3#x]
+- SubqueryAlias t0
   +- View (`t0`, [t0a#x, t0b#x])
      +- Project [cast(col1#x as int) AS t0a#x, cast(col2#x as int) AS t0b#x]
         +- LocalRelation [col1#x, col2#x]


-- !query
SELECT t0a, (SELECT sum(t1a + 3 * t1b + 5 * t1c) FROM
  (SELECT t1c as t1a, t1a as t1b, t0a as t1c
  FROM   t1
  WHERE  t1a = t0a
  EXCEPT ALL
  SELECT t0a as t2b, t2c as t1a, t0b as t2c
  FROM   t2
  WHERE  t2b = t0b)
)
FROM t0
-- !query analysis
Project [t0a#x, scalar-subquery#x [t0a#x && t0a#x && t0a#x && t0b#x && t0b#x] AS scalarsubquery(t0a, t0a, t0a, t0b, t0b)#xL]
:  +- Aggregate [sum(((t1a#x + (3 * t1b#x)) + (5 * t1c#x))) AS sum(((t1a + (3 * t1b)) + (5 * t1c)))#xL]
:     +- SubqueryAlias __auto_generated_subquery_name
:        +- Except All true
:           :- Project [t1c#x AS t1a#x, t1a#x AS t1b#x, outer(t0a#x) AS t1c#x]
:           :  +- Filter (t1a#x = outer(t0a#x))
:           :     +- SubqueryAlias t1
:           :        +- View (`t1`, [t1a#x, t1b#x, t1c#x])
:           :           +- Project [cast(col1#x as int) AS t1a#x, cast(col2#x as int) AS t1b#x, cast(col3#x as int) AS t1c#x]
:           :              +- LocalRelation [col1#x, col2#x, col3#x]
:           +- Project [outer(t0a#x) AS t2b#x, t2c#x AS t1a#x, outer(t0b#x) AS t2c#x]
:              +- Filter (t2b#x = outer(t0b#x))
:                 +- SubqueryAlias t2
:                    +- View (`t2`, [t2a#x, t2b#x, t2c#x])
:                       +- Project [cast(col1#x as int) AS t2a#x, cast(col2#x as int) AS t2b#x, cast(col3#x as int) AS t2c#x]
:                          +- LocalRelation [col1#x, col2#x, col3#x]
+- SubqueryAlias t0
   +- View (`t0`, [t0a#x, t0b#x])
      +- Project [cast(col1#x as int) AS t0a#x, cast(col2#x as int) AS t0b#x]
         +- LocalRelation [col1#x, col2#x]


-- !query
SELECT t0a, (SELECT count(t1c) FROM
  (SELECT t1c
  FROM   t1
  WHERE  t1a = t0a
  EXCEPT ALL
  SELECT t2c
  FROM   t2
  WHERE  t2b = t0b)
)
FROM t0
-- !query analysis
Project [t0a#x, scalar-subquery#x [t0a#x && t0b#x] AS scalarsubquery(t0a, t0b)#xL]
:  +- Aggregate [count(t1c#x) AS count(t1c)#xL]
:     +- SubqueryAlias __auto_generated_subquery_name
:        +- Except All true
:           :- Project [t1c#x]
:           :  +- Filter (t1a#x = outer(t0a#x))
:           :     +- SubqueryAlias t1
:           :        +- View (`t1`, [t1a#x, t1b#x, t1c#x])
:           :           +- Project [cast(col1#x as int) AS t1a#x, cast(col2#x as int) AS t1b#x, cast(col3#x as int) AS t1c#x]
:           :              +- LocalRelation [col1#x, col2#x, col3#x]
:           +- Project [t2c#x]
:              +- Filter (t2b#x = outer(t0b#x))
:                 +- SubqueryAlias t2
:                    +- View (`t2`, [t2a#x, t2b#x, t2c#x])
:                       +- Project [cast(col1#x as int) AS t2a#x, cast(col2#x as int) AS t2b#x, cast(col3#x as int) AS t2c#x]
:                          +- LocalRelation [col1#x, col2#x, col3#x]
+- SubqueryAlias t0
   +- View (`t0`, [t0a#x, t0b#x])
      +- Project [cast(col1#x as int) AS t0a#x, cast(col2#x as int) AS t0b#x]
         +- LocalRelation [col1#x, col2#x]


-- !query
SELECT t0a, (SELECT sum(d) FROM
  (SELECT t1a - t0a as d
  FROM   t1
  EXCEPT ALL
  SELECT t2a - t0a as d
  FROM   t2)
)
FROM t0
-- !query analysis
Project [t0a#x, scalar-subquery#x [t0a#x && t0a#x] AS scalarsubquery(t0a, t0a)#xL]
:  +- Aggregate [sum(d#x) AS sum(d)#xL]
:     +- SubqueryAlias __auto_generated_subquery_name
:        +- Except All true
:           :- Project [(t1a#x - outer(t0a#x)) AS d#x]
:           :  +- SubqueryAlias t1
:           :     +- View (`t1`, [t1a#x, t1b#x, t1c#x])
:           :        +- Project [cast(col1#x as int) AS t1a#x, cast(col2#x as int) AS t1b#x, cast(col3#x as int) AS t1c#x]
:           :           +- LocalRelation [col1#x, col2#x, col3#x]
:           +- Project [(t2a#x - outer(t0a#x)) AS d#x]
:              +- SubqueryAlias t2
:                 +- View (`t2`, [t2a#x, t2b#x, t2c#x])
:                    +- Project [cast(col1#x as int) AS t2a#x, cast(col2#x as int) AS t2b#x, cast(col3#x as int) AS t2c#x]
:                       +- LocalRelation [col1#x, col2#x, col3#x]
+- SubqueryAlias t0
   +- View (`t0`, [t0a#x, t0b#x])
      +- Project [cast(col1#x as int) AS t0a#x, cast(col2#x as int) AS t0b#x]
         +- LocalRelation [col1#x, col2#x]


-- !query
SELECT t0a, (SELECT sum(d) FROM
  (SELECT sum(t0a) as d
  FROM   t1
  EXCEPT ALL
  SELECT sum(t2a) + t0a as d
  FROM   t2)
)
FROM t0
-- !query analysis
org.apache.spark.sql.catalyst.ExtendedAnalysisException
{
  "errorClass" : "UNSUPPORTED_SUBQUERY_EXPRESSION_CATEGORY.CORRELATED_REFERENCE",
  "sqlState" : "0A000",
  "messageParameters" : {
    "sqlExprs" : "\"sum(t0a) AS d\""
  },
  "queryContext" : [ {
    "objectType" : "",
    "objectName" : "",
    "startIndex" : 36,
    "stopIndex" : 67,
    "fragment" : "SELECT sum(t0a) as d\n  FROM   t1"
  } ]
}


-- !query
SELECT t0a, (SELECT sum(c) FROM
  (SELECT t1c as c
  FROM   t1
  WHERE  t1a = t0a
  EXCEPT DISTINCT
  SELECT t2c as c
  FROM   t2
  WHERE  t2b = t0b)
)
FROM t0
-- !query analysis
Project [t0a#x, scalar-subquery#x [t0a#x && t0b#x] AS scalarsubquery(t0a, t0b)#xL]
:  +- Aggregate [sum(c#x) AS sum(c)#xL]
:     +- SubqueryAlias __auto_generated_subquery_name
:        +- Except false
:           :- Project [t1c#x AS c#x]
:           :  +- Filter (t1a#x = outer(t0a#x))
:           :     +- SubqueryAlias t1
:           :        +- View (`t1`, [t1a#x, t1b#x, t1c#x])
:           :           +- Project [cast(col1#x as int) AS t1a#x, cast(col2#x as int) AS t1b#x, cast(col3#x as int) AS t1c#x]
:           :              +- LocalRelation [col1#x, col2#x, col3#x]
:           +- Project [t2c#x AS c#x]
:              +- Filter (t2b#x = outer(t0b#x))
:                 +- SubqueryAlias t2
:                    +- View (`t2`, [t2a#x, t2b#x, t2c#x])
:                       +- Project [cast(col1#x as int) AS t2a#x, cast(col2#x as int) AS t2b#x, cast(col3#x as int) AS t2c#x]
:                          +- LocalRelation [col1#x, col2#x, col3#x]
+- SubqueryAlias t0
   +- View (`t0`, [t0a#x, t0b#x])
      +- Project [cast(col1#x as int) AS t0a#x, cast(col2#x as int) AS t0b#x]
         +- LocalRelation [col1#x, col2#x]


-- !query
SELECT * FROM t0 WHERE t0a <
(SELECT sum(c) FROM
  (SELECT t1c as c
  FROM   t1
  WHERE  t1a = t0a
  EXCEPT DISTINCT
  SELECT t2c as c
  FROM   t2
  WHERE  t2b = t0b)
)
-- !query analysis
Project [t0a#x, t0b#x]
+- Filter (cast(t0a#x as bigint) < scalar-subquery#x [t0a#x && t0b#x])
   :  +- Aggregate [sum(c#x) AS sum(c)#xL]
   :     +- SubqueryAlias __auto_generated_subquery_name
   :        +- Except false
   :           :- Project [t1c#x AS c#x]
   :           :  +- Filter (t1a#x = outer(t0a#x))
   :           :     +- SubqueryAlias t1
   :           :        +- View (`t1`, [t1a#x, t1b#x, t1c#x])
   :           :           +- Project [cast(col1#x as int) AS t1a#x, cast(col2#x as int) AS t1b#x, cast(col3#x as int) AS t1c#x]
   :           :              +- LocalRelation [col1#x, col2#x, col3#x]
   :           +- Project [t2c#x AS c#x]
   :              +- Filter (t2b#x = outer(t0b#x))
   :                 +- SubqueryAlias t2
   :                    +- View (`t2`, [t2a#x, t2b#x, t2c#x])
   :                       +- Project [cast(col1#x as int) AS t2a#x, cast(col2#x as int) AS t2b#x, cast(col3#x as int) AS t2c#x]
   :                          +- LocalRelation [col1#x, col2#x, col3#x]
   +- SubqueryAlias t0
      +- View (`t0`, [t0a#x, t0b#x])
         +- Project [cast(col1#x as int) AS t0a#x, cast(col2#x as int) AS t0b#x]
            +- LocalRelation [col1#x, col2#x]


-- !query
SELECT t0a, (SELECT sum(c) FROM
  (SELECT t1c as c
  FROM   t1
  WHERE  t1a = t0a
  EXCEPT DISTINCT
  SELECT t2c as c
  FROM   t2
  WHERE  t2a = t0a)
)
FROM t0
-- !query analysis
Project [t0a#x, scalar-subquery#x [t0a#x && t0a#x] AS scalarsubquery(t0a, t0a)#xL]
:  +- Aggregate [sum(c#x) AS sum(c)#xL]
:     +- SubqueryAlias __auto_generated_subquery_name
:        +- Except false
:           :- Project [t1c#x AS c#x]
:           :  +- Filter (t1a#x = outer(t0a#x))
:           :     +- SubqueryAlias t1
:           :        +- View (`t1`, [t1a#x, t1b#x, t1c#x])
:           :           +- Project [cast(col1#x as int) AS t1a#x, cast(col2#x as int) AS t1b#x, cast(col3#x as int) AS t1c#x]
:           :              +- LocalRelation [col1#x, col2#x, col3#x]
:           +- Project [t2c#x AS c#x]
:              +- Filter (t2a#x = outer(t0a#x))
:                 +- SubqueryAlias t2
:                    +- View (`t2`, [t2a#x, t2b#x, t2c#x])
:                       +- Project [cast(col1#x as int) AS t2a#x, cast(col2#x as int) AS t2b#x, cast(col3#x as int) AS t2c#x]
:                          +- LocalRelation [col1#x, col2#x, col3#x]
+- SubqueryAlias t0
   +- View (`t0`, [t0a#x, t0b#x])
      +- Project [cast(col1#x as int) AS t0a#x, cast(col2#x as int) AS t0b#x]
         +- LocalRelation [col1#x, col2#x]


-- !query
SELECT t0a, (SELECT sum(c) FROM
  (SELECT t1c as c
  FROM   t1
  WHERE  t1a > t0a
  EXCEPT DISTINCT
  SELECT t2c as c
  FROM   t2
  WHERE  t2b <= t0b)
)
FROM t0
-- !query analysis
Project [t0a#x, scalar-subquery#x [t0a#x && t0b#x] AS scalarsubquery(t0a, t0b)#xL]
:  +- Aggregate [sum(c#x) AS sum(c)#xL]
:     +- SubqueryAlias __auto_generated_subquery_name
:        +- Except false
:           :- Project [t1c#x AS c#x]
:           :  +- Filter (t1a#x > outer(t0a#x))
:           :     +- SubqueryAlias t1
:           :        +- View (`t1`, [t1a#x, t1b#x, t1c#x])
:           :           +- Project [cast(col1#x as int) AS t1a#x, cast(col2#x as int) AS t1b#x, cast(col3#x as int) AS t1c#x]
:           :              +- LocalRelation [col1#x, col2#x, col3#x]
:           +- Project [t2c#x AS c#x]
:              +- Filter (t2b#x <= outer(t0b#x))
:                 +- SubqueryAlias t2
:                    +- View (`t2`, [t2a#x, t2b#x, t2c#x])
:                       +- Project [cast(col1#x as int) AS t2a#x, cast(col2#x as int) AS t2b#x, cast(col3#x as int) AS t2c#x]
:                          +- LocalRelation [col1#x, col2#x, col3#x]
+- SubqueryAlias t0
   +- View (`t0`, [t0a#x, t0b#x])
      +- Project [cast(col1#x as int) AS t0a#x, cast(col2#x as int) AS t0b#x]
         +- LocalRelation [col1#x, col2#x]


-- !query
SELECT t0a, (SELECT sum(t1c) FROM
  (SELECT t1c
  FROM   t1
  WHERE  t1a = t0a
  EXCEPT DISTINCT
  SELECT t2c
  FROM   t2
  WHERE  t2b = t0b)
)
FROM t0
-- !query analysis
Project [t0a#x, scalar-subquery#x [t0a#x && t0b#x] AS scalarsubquery(t0a, t0b)#xL]
:  +- Aggregate [sum(t1c#x) AS sum(t1c)#xL]
:     +- SubqueryAlias __auto_generated_subquery_name
:        +- Except false
:           :- Project [t1c#x]
:           :  +- Filter (t1a#x = outer(t0a#x))
:           :     +- SubqueryAlias t1
:           :        +- View (`t1`, [t1a#x, t1b#x, t1c#x])
:           :           +- Project [cast(col1#x as int) AS t1a#x, cast(col2#x as int) AS t1b#x, cast(col3#x as int) AS t1c#x]
:           :              +- LocalRelation [col1#x, col2#x, col3#x]
:           +- Project [t2c#x]
:              +- Filter (t2b#x = outer(t0b#x))
:                 +- SubqueryAlias t2
:                    +- View (`t2`, [t2a#x, t2b#x, t2c#x])
:                       +- Project [cast(col1#x as int) AS t2a#x, cast(col2#x as int) AS t2b#x, cast(col3#x as int) AS t2c#x]
:                          +- LocalRelation [col1#x, col2#x, col3#x]
+- SubqueryAlias t0
   +- View (`t0`, [t0a#x, t0b#x])
      +- Project [cast(col1#x as int) AS t0a#x, cast(col2#x as int) AS t0b#x]
         +- LocalRelation [col1#x, col2#x]


-- !query
SELECT t0a, (SELECT sum(t1a + 3 * t1b + 5 * t1c) FROM
  (SELECT t1c as t1a, t1a as t1b, t0a as t1c
  FROM   t1
  WHERE  t1a = t0a
  EXCEPT DISTINCT
  SELECT t0a as t2b, t2c as t1a, t0b as t2c
  FROM   t2
  WHERE  t2b = t0b)
)
FROM t0
-- !query analysis
Project [t0a#x, scalar-subquery#x [t0a#x && t0a#x && t0a#x && t0b#x && t0b#x] AS scalarsubquery(t0a, t0a, t0a, t0b, t0b)#xL]
:  +- Aggregate [sum(((t1a#x + (3 * t1b#x)) + (5 * t1c#x))) AS sum(((t1a + (3 * t1b)) + (5 * t1c)))#xL]
:     +- SubqueryAlias __auto_generated_subquery_name
:        +- Except false
:           :- Project [t1c#x AS t1a#x, t1a#x AS t1b#x, outer(t0a#x) AS t1c#x]
:           :  +- Filter (t1a#x = outer(t0a#x))
:           :     +- SubqueryAlias t1
:           :        +- View (`t1`, [t1a#x, t1b#x, t1c#x])
:           :           +- Project [cast(col1#x as int) AS t1a#x, cast(col2#x as int) AS t1b#x, cast(col3#x as int) AS t1c#x]
:           :              +- LocalRelation [col1#x, col2#x, col3#x]
:           +- Project [outer(t0a#x) AS t2b#x, t2c#x AS t1a#x, outer(t0b#x) AS t2c#x]
:              +- Filter (t2b#x = outer(t0b#x))
:                 +- SubqueryAlias t2
:                    +- View (`t2`, [t2a#x, t2b#x, t2c#x])
:                       +- Project [cast(col1#x as int) AS t2a#x, cast(col2#x as int) AS t2b#x, cast(col3#x as int) AS t2c#x]
:                          +- LocalRelation [col1#x, col2#x, col3#x]
+- SubqueryAlias t0
   +- View (`t0`, [t0a#x, t0b#x])
      +- Project [cast(col1#x as int) AS t0a#x, cast(col2#x as int) AS t0b#x]
         +- LocalRelation [col1#x, col2#x]


-- !query
SELECT t0a, (SELECT count(t1c) FROM
  (SELECT t1c
  FROM   t1
  WHERE  t1a = t0a
  EXCEPT DISTINCT
  SELECT t2c
  FROM   t2
  WHERE  t2b = t0b)
)
FROM t0
-- !query analysis
Project [t0a#x, scalar-subquery#x [t0a#x && t0b#x] AS scalarsubquery(t0a, t0b)#xL]
:  +- Aggregate [count(t1c#x) AS count(t1c)#xL]
:     +- SubqueryAlias __auto_generated_subquery_name
:        +- Except false
:           :- Project [t1c#x]
:           :  +- Filter (t1a#x = outer(t0a#x))
:           :     +- SubqueryAlias t1
:           :        +- View (`t1`, [t1a#x, t1b#x, t1c#x])
:           :           +- Project [cast(col1#x as int) AS t1a#x, cast(col2#x as int) AS t1b#x, cast(col3#x as int) AS t1c#x]
:           :              +- LocalRelation [col1#x, col2#x, col3#x]
:           +- Project [t2c#x]
:              +- Filter (t2b#x = outer(t0b#x))
:                 +- SubqueryAlias t2
:                    +- View (`t2`, [t2a#x, t2b#x, t2c#x])
:                       +- Project [cast(col1#x as int) AS t2a#x, cast(col2#x as int) AS t2b#x, cast(col3#x as int) AS t2c#x]
:                          +- LocalRelation [col1#x, col2#x, col3#x]
+- SubqueryAlias t0
   +- View (`t0`, [t0a#x, t0b#x])
      +- Project [cast(col1#x as int) AS t0a#x, cast(col2#x as int) AS t0b#x]
         +- LocalRelation [col1#x, col2#x]


-- !query
SELECT t0a, (SELECT sum(d) FROM
  (SELECT t1a - t0a as d
  FROM   t1
  EXCEPT DISTINCT
  SELECT t2a - t0a as d
  FROM   t2)
)
FROM t0
-- !query analysis
Project [t0a#x, scalar-subquery#x [t0a#x && t0a#x] AS scalarsubquery(t0a, t0a)#xL]
:  +- Aggregate [sum(d#x) AS sum(d)#xL]
:     +- SubqueryAlias __auto_generated_subquery_name
:        +- Except false
:           :- Project [(t1a#x - outer(t0a#x)) AS d#x]
:           :  +- SubqueryAlias t1
:           :     +- View (`t1`, [t1a#x, t1b#x, t1c#x])
:           :        +- Project [cast(col1#x as int) AS t1a#x, cast(col2#x as int) AS t1b#x, cast(col3#x as int) AS t1c#x]
:           :           +- LocalRelation [col1#x, col2#x, col3#x]
:           +- Project [(t2a#x - outer(t0a#x)) AS d#x]
:              +- SubqueryAlias t2
:                 +- View (`t2`, [t2a#x, t2b#x, t2c#x])
:                    +- Project [cast(col1#x as int) AS t2a#x, cast(col2#x as int) AS t2b#x, cast(col3#x as int) AS t2c#x]
:                       +- LocalRelation [col1#x, col2#x, col3#x]
+- SubqueryAlias t0
   +- View (`t0`, [t0a#x, t0b#x])
      +- Project [cast(col1#x as int) AS t0a#x, cast(col2#x as int) AS t0b#x]
         +- LocalRelation [col1#x, col2#x]


-- !query
SELECT t0a, (SELECT sum(d) FROM
  (SELECT sum(t0a) as d
  FROM   t1
  EXCEPT DISTINCT
  SELECT sum(t2a) + t0a as d
  FROM   t2)
)
FROM t0
-- !query analysis
org.apache.spark.sql.catalyst.ExtendedAnalysisException
{
  "errorClass" : "UNSUPPORTED_SUBQUERY_EXPRESSION_CATEGORY.CORRELATED_REFERENCE",
  "sqlState" : "0A000",
  "messageParameters" : {
    "sqlExprs" : "\"sum(t0a) AS d\""
  },
  "queryContext" : [ {
    "objectType" : "",
    "objectName" : "",
    "startIndex" : 36,
    "stopIndex" : 67,
    "fragment" : "SELECT sum(t0a) as d\n  FROM   t1"
  } ]
}


-- !query
SELECT t0a, (SELECT sum(t1b) FROM
  (SELECT t1b
  FROM   t1 join t2 ON (t1a = t0a and t1b = t2b)
  UNION ALL
  SELECT t2b
  FROM   t1 join t2 ON (t2a = t0a and t1a = t2a))
)
FROM t0
-- !query analysis
Project [t0a#x, scalar-subquery#x [t0a#x && t0a#x] AS scalarsubquery(t0a, t0a)#xL]
:  +- Aggregate [sum(t1b#x) AS sum(t1b)#xL]
:     +- SubqueryAlias __auto_generated_subquery_name
:        +- Union false, false
:           :- Project [t1b#x]
:           :  +- Join Inner, ((t1a#x = outer(t0a#x)) AND (t1b#x = t2b#x))
:           :     :- SubqueryAlias t1
:           :     :  +- View (`t1`, [t1a#x, t1b#x, t1c#x])
:           :     :     +- Project [cast(col1#x as int) AS t1a#x, cast(col2#x as int) AS t1b#x, cast(col3#x as int) AS t1c#x]
:           :     :        +- LocalRelation [col1#x, col2#x, col3#x]
:           :     +- SubqueryAlias t2
:           :        +- View (`t2`, [t2a#x, t2b#x, t2c#x])
:           :           +- Project [cast(col1#x as int) AS t2a#x, cast(col2#x as int) AS t2b#x, cast(col3#x as int) AS t2c#x]
:           :              +- LocalRelation [col1#x, col2#x, col3#x]
:           +- Project [t2b#x]
:              +- Join Inner, ((t2a#x = outer(t0a#x)) AND (t1a#x = t2a#x))
:                 :- SubqueryAlias t1
:                 :  +- View (`t1`, [t1a#x, t1b#x, t1c#x])
:                 :     +- Project [cast(col1#x as int) AS t1a#x, cast(col2#x as int) AS t1b#x, cast(col3#x as int) AS t1c#x]
:                 :        +- LocalRelation [col1#x, col2#x, col3#x]
:                 +- SubqueryAlias t2
:                    +- View (`t2`, [t2a#x, t2b#x, t2c#x])
:                       +- Project [cast(col1#x as int) AS t2a#x, cast(col2#x as int) AS t2b#x, cast(col3#x as int) AS t2c#x]
:                          +- LocalRelation [col1#x, col2#x, col3#x]
+- SubqueryAlias t0
   +- View (`t0`, [t0a#x, t0b#x])
      +- Project [cast(col1#x as int) AS t0a#x, cast(col2#x as int) AS t0b#x]
         +- LocalRelation [col1#x, col2#x]


-- !query
SELECT t0a, (SELECT sum(t1b) FROM
  (SELECT t1b
  FROM   t1 left join t2 ON (t1a = t0a and t1b = t2b)
  UNION ALL
  SELECT t2b
  FROM   t1 join t2 ON (t2a = t0a + 1 and t1a = t2a))
)
FROM t0
-- !query analysis
Project [t0a#x, scalar-subquery#x [t0a#x && t0a#x] AS scalarsubquery(t0a, t0a)#xL]
:  +- Aggregate [sum(t1b#x) AS sum(t1b)#xL]
:     +- SubqueryAlias __auto_generated_subquery_name
:        +- Union false, false
:           :- Project [t1b#x]
:           :  +- Join LeftOuter, ((t1a#x = outer(t0a#x)) AND (t1b#x = t2b#x))
:           :     :- SubqueryAlias t1
:           :     :  +- View (`t1`, [t1a#x, t1b#x, t1c#x])
:           :     :     +- Project [cast(col1#x as int) AS t1a#x, cast(col2#x as int) AS t1b#x, cast(col3#x as int) AS t1c#x]
:           :     :        +- LocalRelation [col1#x, col2#x, col3#x]
:           :     +- SubqueryAlias t2
:           :        +- View (`t2`, [t2a#x, t2b#x, t2c#x])
:           :           +- Project [cast(col1#x as int) AS t2a#x, cast(col2#x as int) AS t2b#x, cast(col3#x as int) AS t2c#x]
:           :              +- LocalRelation [col1#x, col2#x, col3#x]
:           +- Project [t2b#x]
:              +- Join Inner, ((t2a#x = (outer(t0a#x) + 1)) AND (t1a#x = t2a#x))
:                 :- SubqueryAlias t1
:                 :  +- View (`t1`, [t1a#x, t1b#x, t1c#x])
:                 :     +- Project [cast(col1#x as int) AS t1a#x, cast(col2#x as int) AS t1b#x, cast(col3#x as int) AS t1c#x]
:                 :        +- LocalRelation [col1#x, col2#x, col3#x]
:                 +- SubqueryAlias t2
:                    +- View (`t2`, [t2a#x, t2b#x, t2c#x])
:                       +- Project [cast(col1#x as int) AS t2a#x, cast(col2#x as int) AS t2b#x, cast(col3#x as int) AS t2c#x]
:                          +- LocalRelation [col1#x, col2#x, col3#x]
+- SubqueryAlias t0
   +- View (`t0`, [t0a#x, t0b#x])
      +- Project [cast(col1#x as int) AS t0a#x, cast(col2#x as int) AS t0b#x]
         +- LocalRelation [col1#x, col2#x]
