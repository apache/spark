-- Automatically generated by SQLQueryTestSuite
-- !query
create temporary view courseSales as select * from values
  ("dotNET", 2012, 10000),
  ("Java", 2012, 20000),
  ("dotNET", 2012, 5000),
  ("dotNET", 2013, 48000),
  ("Java", 2013, 30000)
  as courseSales(course, year, earnings)
-- !query analysis
CreateViewCommand `courseSales`, select * from values
  ("dotNET", 2012, 10000),
  ("Java", 2012, 20000),
  ("dotNET", 2012, 5000),
  ("dotNET", 2013, 48000),
  ("Java", 2013, 30000)
  as courseSales(course, year, earnings), false, false, LocalTempView, UNSUPPORTED, true
   +- Project [course#x, year#x, earnings#x]
      +- SubqueryAlias courseSales
         +- LocalRelation [course#x, year#x, earnings#x]


-- !query
create temporary view years as select * from values
  (2012, 1),
  (2013, 2)
  as years(y, s)
-- !query analysis
CreateViewCommand `years`, select * from values
  (2012, 1),
  (2013, 2)
  as years(y, s), false, false, LocalTempView, UNSUPPORTED, true
   +- Project [y#x, s#x]
      +- SubqueryAlias years
         +- LocalRelation [y#x, s#x]


-- !query
create temporary view yearsWithComplexTypes as select * from values
  (2012, array(1, 1), map('1', 1), struct(1, 'a')),
  (2013, array(2, 2), map('2', 2), struct(2, 'b'))
  as yearsWithComplexTypes(y, a, m, s)
-- !query analysis
CreateViewCommand `yearsWithComplexTypes`, select * from values
  (2012, array(1, 1), map('1', 1), struct(1, 'a')),
  (2013, array(2, 2), map('2', 2), struct(2, 'b'))
  as yearsWithComplexTypes(y, a, m, s), false, false, LocalTempView, UNSUPPORTED, true
   +- Project [y#x, a#x, m#x, s#x]
      +- SubqueryAlias yearsWithComplexTypes
         +- LocalRelation [y#x, a#x, m#x, s#x]


-- !query
SELECT * FROM (
  SELECT udf(year), course, earnings FROM courseSales
)
PIVOT (
  udf(sum(earnings))
  FOR course IN ('dotNET', 'Java')
)
-- !query analysis
Project [udf(year)#x, dotNET#xL, Java#xL]
+- Project [udf(year)#x, __pivot_CAST(udf(cast(sum(earnings) as string)) AS BIGINT) AS `CAST(udf(cast(sum(earnings) as string)) AS BIGINT)`#x[0] AS dotNET#xL, __pivot_CAST(udf(cast(sum(earnings) as string)) AS BIGINT) AS `CAST(udf(cast(sum(earnings) as string)) AS BIGINT)`#x[1] AS Java#xL]
   +- Aggregate [udf(year)#x], [udf(year)#x, pivotfirst(course#x, CAST(udf(cast(sum(earnings) as string)) AS BIGINT)#xL, dotNET, Java, 0, 0) AS __pivot_CAST(udf(cast(sum(earnings) as string)) AS BIGINT) AS `CAST(udf(cast(sum(earnings) as string)) AS BIGINT)`#x]
      +- Aggregate [udf(year)#x, course#x], [udf(year)#x, course#x, cast(udf(cast(sum(earnings#x) as string)) as bigint) AS CAST(udf(cast(sum(earnings) as string)) AS BIGINT)#xL]
         +- SubqueryAlias __auto_generated_subquery_name
            +- Project [cast(udf(cast(year#x as string)) as int) AS udf(year)#x, course#x, earnings#x]
               +- SubqueryAlias coursesales
                  +- View (`courseSales`, [course#x, year#x, earnings#x])
                     +- Project [cast(course#x as string) AS course#x, cast(year#x as int) AS year#x, cast(earnings#x as int) AS earnings#x]
                        +- Project [course#x, year#x, earnings#x]
                           +- SubqueryAlias courseSales
                              +- LocalRelation [course#x, year#x, earnings#x]


-- !query
SELECT * FROM courseSales
PIVOT (
  udf(sum(earnings))
  FOR year IN (2012, 2013)
)
-- !query analysis
Project [course#x, 2012#xL, 2013#xL]
+- Project [course#x, __pivot_CAST(udf(cast(sum(earnings) as string)) AS BIGINT) AS `CAST(udf(cast(sum(earnings) as string)) AS BIGINT)`#x[0] AS 2012#xL, __pivot_CAST(udf(cast(sum(earnings) as string)) AS BIGINT) AS `CAST(udf(cast(sum(earnings) as string)) AS BIGINT)`#x[1] AS 2013#xL]
   +- Aggregate [course#x], [course#x, pivotfirst(year#x, CAST(udf(cast(sum(earnings) as string)) AS BIGINT)#xL, 2012, 2013, 0, 0) AS __pivot_CAST(udf(cast(sum(earnings) as string)) AS BIGINT) AS `CAST(udf(cast(sum(earnings) as string)) AS BIGINT)`#x]
      +- Aggregate [course#x, year#x], [course#x, year#x, cast(udf(cast(sum(earnings#x) as string)) as bigint) AS CAST(udf(cast(sum(earnings) as string)) AS BIGINT)#xL]
         +- SubqueryAlias coursesales
            +- View (`courseSales`, [course#x, year#x, earnings#x])
               +- Project [cast(course#x as string) AS course#x, cast(year#x as int) AS year#x, cast(earnings#x as int) AS earnings#x]
                  +- Project [course#x, year#x, earnings#x]
                     +- SubqueryAlias courseSales
                        +- LocalRelation [course#x, year#x, earnings#x]


-- !query
SELECT * FROM (
  SELECT year, course, earnings FROM courseSales
)
PIVOT (
  udf(sum(earnings)), udf(avg(earnings))
  FOR course IN ('dotNET', 'Java')
)
-- !query analysis
Project [year#x, dotNET_udf(sum(earnings))#xL, dotNET_udf(avg(earnings))#x, Java_udf(sum(earnings))#xL, Java_udf(avg(earnings))#x]
+- Project [year#x, __pivot_CAST(udf(cast(sum(earnings) as string)) AS BIGINT) AS `CAST(udf(cast(sum(earnings) as string)) AS BIGINT)`#x[0] AS dotNET_udf(sum(earnings))#xL, __pivot_CAST(udf(cast(avg(earnings) as string)) AS DOUBLE) AS `CAST(udf(cast(avg(earnings) as string)) AS DOUBLE)`#x[0] AS dotNET_udf(avg(earnings))#x, __pivot_CAST(udf(cast(sum(earnings) as string)) AS BIGINT) AS `CAST(udf(cast(sum(earnings) as string)) AS BIGINT)`#x[1] AS Java_udf(sum(earnings))#xL, __pivot_CAST(udf(cast(avg(earnings) as string)) AS DOUBLE) AS `CAST(udf(cast(avg(earnings) as string)) AS DOUBLE)`#x[1] AS Java_udf(avg(earnings))#x]
   +- Aggregate [year#x], [year#x, pivotfirst(course#x, CAST(udf(cast(sum(earnings) as string)) AS BIGINT)#xL, dotNET, Java, 0, 0) AS __pivot_CAST(udf(cast(sum(earnings) as string)) AS BIGINT) AS `CAST(udf(cast(sum(earnings) as string)) AS BIGINT)`#x, pivotfirst(course#x, CAST(udf(cast(avg(earnings) as string)) AS DOUBLE)#x, dotNET, Java, 0, 0) AS __pivot_CAST(udf(cast(avg(earnings) as string)) AS DOUBLE) AS `CAST(udf(cast(avg(earnings) as string)) AS DOUBLE)`#x]
      +- Aggregate [year#x, course#x], [year#x, course#x, cast(udf(cast(sum(earnings#x) as string)) as bigint) AS CAST(udf(cast(sum(earnings) as string)) AS BIGINT)#xL, cast(udf(cast(avg(earnings#x) as string)) as double) AS CAST(udf(cast(avg(earnings) as string)) AS DOUBLE)#x]
         +- SubqueryAlias __auto_generated_subquery_name
            +- Project [year#x, course#x, earnings#x]
               +- SubqueryAlias coursesales
                  +- View (`courseSales`, [course#x, year#x, earnings#x])
                     +- Project [cast(course#x as string) AS course#x, cast(year#x as int) AS year#x, cast(earnings#x as int) AS earnings#x]
                        +- Project [course#x, year#x, earnings#x]
                           +- SubqueryAlias courseSales
                              +- LocalRelation [course#x, year#x, earnings#x]


-- !query
SELECT * FROM (
  SELECT udf(course) as course, earnings FROM courseSales
)
PIVOT (
  udf(sum(earnings))
  FOR course IN ('dotNET', 'Java')
)
-- !query analysis
Project [dotNET#xL, Java#xL]
+- Project [__pivot_CAST(udf(cast(sum(earnings) as string)) AS BIGINT) AS `CAST(udf(cast(sum(earnings) as string)) AS BIGINT)`#x[0] AS dotNET#xL, __pivot_CAST(udf(cast(sum(earnings) as string)) AS BIGINT) AS `CAST(udf(cast(sum(earnings) as string)) AS BIGINT)`#x[1] AS Java#xL]
   +- Aggregate [pivotfirst(course#x, CAST(udf(cast(sum(earnings) as string)) AS BIGINT)#xL, dotNET, Java, 0, 0) AS __pivot_CAST(udf(cast(sum(earnings) as string)) AS BIGINT) AS `CAST(udf(cast(sum(earnings) as string)) AS BIGINT)`#x]
      +- Aggregate [course#x], [course#x, cast(udf(cast(sum(earnings#x) as string)) as bigint) AS CAST(udf(cast(sum(earnings) as string)) AS BIGINT)#xL]
         +- SubqueryAlias __auto_generated_subquery_name
            +- Project [cast(udf(cast(course#x as string)) as string) AS course#x, earnings#x]
               +- SubqueryAlias coursesales
                  +- View (`courseSales`, [course#x, year#x, earnings#x])
                     +- Project [cast(course#x as string) AS course#x, cast(year#x as int) AS year#x, cast(earnings#x as int) AS earnings#x]
                        +- Project [course#x, year#x, earnings#x]
                           +- SubqueryAlias courseSales
                              +- LocalRelation [course#x, year#x, earnings#x]


-- !query
SELECT * FROM (
  SELECT year, course, earnings FROM courseSales
)
PIVOT (
  udf(sum(udf(earnings))), udf(min(year))
  FOR course IN ('dotNET', 'Java')
)
-- !query analysis
Project [dotNET_udf(sum(udf(earnings)))#xL, dotNET_udf(min(year))#x, Java_udf(sum(udf(earnings)))#xL, Java_udf(min(year))#x]
+- Project [__pivot_CAST(udf(cast(sum(cast(udf(cast(earnings as string)) as int)) as string)) AS BIGINT) AS `CAST(udf(cast(sum(cast(udf(cast(earnings as string)) as int)) as string)) AS BIGINT)`#x[0] AS dotNET_udf(sum(udf(earnings)))#xL, __pivot_CAST(udf(cast(min(year) as string)) AS INT) AS `CAST(udf(cast(min(year) as string)) AS INT)`#x[0] AS dotNET_udf(min(year))#x, __pivot_CAST(udf(cast(sum(cast(udf(cast(earnings as string)) as int)) as string)) AS BIGINT) AS `CAST(udf(cast(sum(cast(udf(cast(earnings as string)) as int)) as string)) AS BIGINT)`#x[1] AS Java_udf(sum(udf(earnings)))#xL, __pivot_CAST(udf(cast(min(year) as string)) AS INT) AS `CAST(udf(cast(min(year) as string)) AS INT)`#x[1] AS Java_udf(min(year))#x]
   +- Aggregate [pivotfirst(course#x, CAST(udf(cast(sum(cast(udf(cast(earnings as string)) as int)) as string)) AS BIGINT)#xL, dotNET, Java, 0, 0) AS __pivot_CAST(udf(cast(sum(cast(udf(cast(earnings as string)) as int)) as string)) AS BIGINT) AS `CAST(udf(cast(sum(cast(udf(cast(earnings as string)) as int)) as string)) AS BIGINT)`#x, pivotfirst(course#x, CAST(udf(cast(min(year) as string)) AS INT)#x, dotNET, Java, 0, 0) AS __pivot_CAST(udf(cast(min(year) as string)) AS INT) AS `CAST(udf(cast(min(year) as string)) AS INT)`#x]
      +- Aggregate [course#x], [course#x, cast(udf(cast(sum(cast(udf(cast(earnings#x as string)) as int)) as string)) as bigint) AS CAST(udf(cast(sum(cast(udf(cast(earnings as string)) as int)) as string)) AS BIGINT)#xL, cast(udf(cast(min(year#x) as string)) as int) AS CAST(udf(cast(min(year) as string)) AS INT)#x]
         +- SubqueryAlias __auto_generated_subquery_name
            +- Project [year#x, course#x, earnings#x]
               +- SubqueryAlias coursesales
                  +- View (`courseSales`, [course#x, year#x, earnings#x])
                     +- Project [cast(course#x as string) AS course#x, cast(year#x as int) AS year#x, cast(earnings#x as int) AS earnings#x]
                        +- Project [course#x, year#x, earnings#x]
                           +- SubqueryAlias courseSales
                              +- LocalRelation [course#x, year#x, earnings#x]


-- !query
SELECT * FROM (
  SELECT course, year, earnings, udf(s) as s
  FROM courseSales
  JOIN years ON year = y
)
PIVOT (
  udf(sum(earnings))
  FOR s IN (1, 2)
)
-- !query analysis
Project [course#x, year#x, 1#xL, 2#xL]
+- Project [course#x, year#x, __pivot_CAST(udf(cast(sum(earnings) as string)) AS BIGINT) AS `CAST(udf(cast(sum(earnings) as string)) AS BIGINT)`#x[0] AS 1#xL, __pivot_CAST(udf(cast(sum(earnings) as string)) AS BIGINT) AS `CAST(udf(cast(sum(earnings) as string)) AS BIGINT)`#x[1] AS 2#xL]
   +- Aggregate [course#x, year#x], [course#x, year#x, pivotfirst(s#x, CAST(udf(cast(sum(earnings) as string)) AS BIGINT)#xL, 1, 2, 0, 0) AS __pivot_CAST(udf(cast(sum(earnings) as string)) AS BIGINT) AS `CAST(udf(cast(sum(earnings) as string)) AS BIGINT)`#x]
      +- Aggregate [course#x, year#x, s#x], [course#x, year#x, s#x, cast(udf(cast(sum(earnings#x) as string)) as bigint) AS CAST(udf(cast(sum(earnings) as string)) AS BIGINT)#xL]
         +- SubqueryAlias __auto_generated_subquery_name
            +- Project [course#x, year#x, earnings#x, cast(udf(cast(s#x as string)) as int) AS s#x]
               +- Join Inner, (year#x = y#x)
                  :- SubqueryAlias coursesales
                  :  +- View (`courseSales`, [course#x, year#x, earnings#x])
                  :     +- Project [cast(course#x as string) AS course#x, cast(year#x as int) AS year#x, cast(earnings#x as int) AS earnings#x]
                  :        +- Project [course#x, year#x, earnings#x]
                  :           +- SubqueryAlias courseSales
                  :              +- LocalRelation [course#x, year#x, earnings#x]
                  +- SubqueryAlias years
                     +- View (`years`, [y#x, s#x])
                        +- Project [cast(y#x as int) AS y#x, cast(s#x as int) AS s#x]
                           +- Project [y#x, s#x]
                              +- SubqueryAlias years
                                 +- LocalRelation [y#x, s#x]


-- !query
SELECT * FROM (
  SELECT course, year, earnings, s
  FROM courseSales
  JOIN years ON year = y
)
PIVOT (
  udf(sum(earnings)), udf(min(s))
  FOR course IN ('dotNET', 'Java')
)
-- !query analysis
Project [year#x, dotNET_udf(sum(earnings))#xL, dotNET_udf(min(s))#x, Java_udf(sum(earnings))#xL, Java_udf(min(s))#x]
+- Project [year#x, __pivot_CAST(udf(cast(sum(earnings) as string)) AS BIGINT) AS `CAST(udf(cast(sum(earnings) as string)) AS BIGINT)`#x[0] AS dotNET_udf(sum(earnings))#xL, __pivot_CAST(udf(cast(min(s) as string)) AS INT) AS `CAST(udf(cast(min(s) as string)) AS INT)`#x[0] AS dotNET_udf(min(s))#x, __pivot_CAST(udf(cast(sum(earnings) as string)) AS BIGINT) AS `CAST(udf(cast(sum(earnings) as string)) AS BIGINT)`#x[1] AS Java_udf(sum(earnings))#xL, __pivot_CAST(udf(cast(min(s) as string)) AS INT) AS `CAST(udf(cast(min(s) as string)) AS INT)`#x[1] AS Java_udf(min(s))#x]
   +- Aggregate [year#x], [year#x, pivotfirst(course#x, CAST(udf(cast(sum(earnings) as string)) AS BIGINT)#xL, dotNET, Java, 0, 0) AS __pivot_CAST(udf(cast(sum(earnings) as string)) AS BIGINT) AS `CAST(udf(cast(sum(earnings) as string)) AS BIGINT)`#x, pivotfirst(course#x, CAST(udf(cast(min(s) as string)) AS INT)#x, dotNET, Java, 0, 0) AS __pivot_CAST(udf(cast(min(s) as string)) AS INT) AS `CAST(udf(cast(min(s) as string)) AS INT)`#x]
      +- Aggregate [year#x, course#x], [year#x, course#x, cast(udf(cast(sum(earnings#x) as string)) as bigint) AS CAST(udf(cast(sum(earnings) as string)) AS BIGINT)#xL, cast(udf(cast(min(s#x) as string)) as int) AS CAST(udf(cast(min(s) as string)) AS INT)#x]
         +- SubqueryAlias __auto_generated_subquery_name
            +- Project [course#x, year#x, earnings#x, s#x]
               +- Join Inner, (year#x = y#x)
                  :- SubqueryAlias coursesales
                  :  +- View (`courseSales`, [course#x, year#x, earnings#x])
                  :     +- Project [cast(course#x as string) AS course#x, cast(year#x as int) AS year#x, cast(earnings#x as int) AS earnings#x]
                  :        +- Project [course#x, year#x, earnings#x]
                  :           +- SubqueryAlias courseSales
                  :              +- LocalRelation [course#x, year#x, earnings#x]
                  +- SubqueryAlias years
                     +- View (`years`, [y#x, s#x])
                        +- Project [cast(y#x as int) AS y#x, cast(s#x as int) AS s#x]
                           +- Project [y#x, s#x]
                              +- SubqueryAlias years
                                 +- LocalRelation [y#x, s#x]


-- !query
SELECT * FROM (
  SELECT course, year, earnings, s
  FROM courseSales
  JOIN years ON year = y
)
PIVOT (
  udf(sum(earnings * s))
  FOR course IN ('dotNET', 'Java')
)
-- !query analysis
Project [year#x, dotNET#xL, Java#xL]
+- Project [year#x, __pivot_CAST(udf(cast(sum((earnings * s)) as string)) AS BIGINT) AS `CAST(udf(cast(sum((earnings * s)) as string)) AS BIGINT)`#x[0] AS dotNET#xL, __pivot_CAST(udf(cast(sum((earnings * s)) as string)) AS BIGINT) AS `CAST(udf(cast(sum((earnings * s)) as string)) AS BIGINT)`#x[1] AS Java#xL]
   +- Aggregate [year#x], [year#x, pivotfirst(course#x, CAST(udf(cast(sum((earnings * s)) as string)) AS BIGINT)#xL, dotNET, Java, 0, 0) AS __pivot_CAST(udf(cast(sum((earnings * s)) as string)) AS BIGINT) AS `CAST(udf(cast(sum((earnings * s)) as string)) AS BIGINT)`#x]
      +- Aggregate [year#x, course#x], [year#x, course#x, cast(udf(cast(sum((earnings#x * s#x)) as string)) as bigint) AS CAST(udf(cast(sum((earnings * s)) as string)) AS BIGINT)#xL]
         +- SubqueryAlias __auto_generated_subquery_name
            +- Project [course#x, year#x, earnings#x, s#x]
               +- Join Inner, (year#x = y#x)
                  :- SubqueryAlias coursesales
                  :  +- View (`courseSales`, [course#x, year#x, earnings#x])
                  :     +- Project [cast(course#x as string) AS course#x, cast(year#x as int) AS year#x, cast(earnings#x as int) AS earnings#x]
                  :        +- Project [course#x, year#x, earnings#x]
                  :           +- SubqueryAlias courseSales
                  :              +- LocalRelation [course#x, year#x, earnings#x]
                  +- SubqueryAlias years
                     +- View (`years`, [y#x, s#x])
                        +- Project [cast(y#x as int) AS y#x, cast(s#x as int) AS s#x]
                           +- Project [y#x, s#x]
                              +- SubqueryAlias years
                                 +- LocalRelation [y#x, s#x]


-- !query
SELECT 2012_s, 2013_s, 2012_a, 2013_a, c FROM (
  SELECT year y, course c, earnings e FROM courseSales
)
PIVOT (
  udf(sum(e)) s, udf(avg(e)) a
  FOR y IN (2012, 2013)
)
-- !query analysis
Project [2012_s#xL, 2013_s#xL, 2012_a#x, 2013_a#x, c#x]
+- Project [c#x, __pivot_CAST(udf(cast(sum(e) as string)) AS BIGINT) AS s AS `CAST(udf(cast(sum(e) as string)) AS BIGINT) AS s`#x[0] AS 2012_s#xL, __pivot_CAST(udf(cast(avg(e) as string)) AS DOUBLE) AS a AS `CAST(udf(cast(avg(e) as string)) AS DOUBLE) AS a`#x[0] AS 2012_a#x, __pivot_CAST(udf(cast(sum(e) as string)) AS BIGINT) AS s AS `CAST(udf(cast(sum(e) as string)) AS BIGINT) AS s`#x[1] AS 2013_s#xL, __pivot_CAST(udf(cast(avg(e) as string)) AS DOUBLE) AS a AS `CAST(udf(cast(avg(e) as string)) AS DOUBLE) AS a`#x[1] AS 2013_a#x]
   +- Aggregate [c#x], [c#x, pivotfirst(y#x, CAST(udf(cast(sum(e) as string)) AS BIGINT) AS s#xL, 2012, 2013, 0, 0) AS __pivot_CAST(udf(cast(sum(e) as string)) AS BIGINT) AS s AS `CAST(udf(cast(sum(e) as string)) AS BIGINT) AS s`#x, pivotfirst(y#x, CAST(udf(cast(avg(e) as string)) AS DOUBLE) AS a#x, 2012, 2013, 0, 0) AS __pivot_CAST(udf(cast(avg(e) as string)) AS DOUBLE) AS a AS `CAST(udf(cast(avg(e) as string)) AS DOUBLE) AS a`#x]
      +- Aggregate [c#x, y#x], [c#x, y#x, cast(udf(cast(sum(e#x) as string)) as bigint) AS CAST(udf(cast(sum(e) as string)) AS BIGINT) AS s#xL, cast(udf(cast(avg(e#x) as string)) as double) AS CAST(udf(cast(avg(e) as string)) AS DOUBLE) AS a#x]
         +- SubqueryAlias __auto_generated_subquery_name
            +- Project [year#x AS y#x, course#x AS c#x, earnings#x AS e#x]
               +- SubqueryAlias coursesales
                  +- View (`courseSales`, [course#x, year#x, earnings#x])
                     +- Project [cast(course#x as string) AS course#x, cast(year#x as int) AS year#x, cast(earnings#x as int) AS earnings#x]
                        +- Project [course#x, year#x, earnings#x]
                           +- SubqueryAlias courseSales
                              +- LocalRelation [course#x, year#x, earnings#x]


-- !query
SELECT firstYear_s, secondYear_s, firstYear_a, secondYear_a, c FROM (
  SELECT year y, course c, earnings e FROM courseSales
)
PIVOT (
  udf(sum(e)) s, udf(avg(e)) a
  FOR y IN (2012 as firstYear, 2013 secondYear)
)
-- !query analysis
Project [firstYear_s#xL, secondYear_s#xL, firstYear_a#x, secondYear_a#x, c#x]
+- Project [c#x, __pivot_CAST(udf(cast(sum(e) as string)) AS BIGINT) AS s AS `CAST(udf(cast(sum(e) as string)) AS BIGINT) AS s`#x[0] AS firstYear_s#xL, __pivot_CAST(udf(cast(avg(e) as string)) AS DOUBLE) AS a AS `CAST(udf(cast(avg(e) as string)) AS DOUBLE) AS a`#x[0] AS firstYear_a#x, __pivot_CAST(udf(cast(sum(e) as string)) AS BIGINT) AS s AS `CAST(udf(cast(sum(e) as string)) AS BIGINT) AS s`#x[1] AS secondYear_s#xL, __pivot_CAST(udf(cast(avg(e) as string)) AS DOUBLE) AS a AS `CAST(udf(cast(avg(e) as string)) AS DOUBLE) AS a`#x[1] AS secondYear_a#x]
   +- Aggregate [c#x], [c#x, pivotfirst(y#x, CAST(udf(cast(sum(e) as string)) AS BIGINT) AS s#xL, 2012, 2013, 0, 0) AS __pivot_CAST(udf(cast(sum(e) as string)) AS BIGINT) AS s AS `CAST(udf(cast(sum(e) as string)) AS BIGINT) AS s`#x, pivotfirst(y#x, CAST(udf(cast(avg(e) as string)) AS DOUBLE) AS a#x, 2012, 2013, 0, 0) AS __pivot_CAST(udf(cast(avg(e) as string)) AS DOUBLE) AS a AS `CAST(udf(cast(avg(e) as string)) AS DOUBLE) AS a`#x]
      +- Aggregate [c#x, y#x], [c#x, y#x, cast(udf(cast(sum(e#x) as string)) as bigint) AS CAST(udf(cast(sum(e) as string)) AS BIGINT) AS s#xL, cast(udf(cast(avg(e#x) as string)) as double) AS CAST(udf(cast(avg(e) as string)) AS DOUBLE) AS a#x]
         +- SubqueryAlias __auto_generated_subquery_name
            +- Project [year#x AS y#x, course#x AS c#x, earnings#x AS e#x]
               +- SubqueryAlias coursesales
                  +- View (`courseSales`, [course#x, year#x, earnings#x])
                     +- Project [cast(course#x as string) AS course#x, cast(year#x as int) AS year#x, cast(earnings#x as int) AS earnings#x]
                        +- Project [course#x, year#x, earnings#x]
                           +- SubqueryAlias courseSales
                              +- LocalRelation [course#x, year#x, earnings#x]


-- !query
SELECT * FROM courseSales
PIVOT (
  udf(abs(earnings))
  FOR year IN (2012, 2013)
)
-- !query analysis
org.apache.spark.sql.AnalysisException
{
  "errorClass" : "_LEGACY_ERROR_TEMP_1006",
  "messageParameters" : {
    "sql" : "coursesales.earnings"
  }
}


-- !query
SELECT * FROM (
  SELECT year, course, earnings FROM courseSales
)
PIVOT (
  udf(sum(earnings)), year
  FOR course IN ('dotNET', 'Java')
)
-- !query analysis
org.apache.spark.sql.AnalysisException
{
  "errorClass" : "_LEGACY_ERROR_TEMP_1006",
  "messageParameters" : {
    "sql" : "__auto_generated_subquery_name.year"
  }
}


-- !query
SELECT * FROM (
  SELECT course, earnings FROM courseSales
)
PIVOT (
  udf(sum(earnings))
  FOR year IN (2012, 2013)
)
-- !query analysis
org.apache.spark.sql.catalyst.ExtendedAnalysisException
{
  "errorClass" : "UNRESOLVED_COLUMN.WITH_SUGGESTION",
  "sqlState" : "42703",
  "messageParameters" : {
    "objectName" : "`year`",
    "proposal" : "`course`, `earnings`"
  },
  "queryContext" : [ {
    "objectType" : "",
    "objectName" : "",
    "startIndex" : 62,
    "stopIndex" : 118,
    "fragment" : "PIVOT (\n  udf(sum(earnings))\n  FOR year IN (2012, 2013)\n)"
  } ]
}


-- !query
SELECT * FROM (
  SELECT year, course, earnings FROM courseSales
)
PIVOT (
  udf(ceil(udf(sum(earnings)))), avg(earnings) + 1 as a1
  FOR course IN ('dotNET', 'Java')
)
-- !query analysis
Project [year#x, dotNET_udf(CEIL(udf(sum(earnings))))#xL, dotNET_a1#x, Java_udf(CEIL(udf(sum(earnings))))#xL, Java_a1#x]
+- Project [year#x, __pivot_CAST(udf(cast(CEIL(cast(udf(cast(sum(earnings) as string)) as bigint)) as string)) AS BIGINT) AS `CAST(udf(cast(CEIL(cast(udf(cast(sum(earnings) as string)) as bigint)) as string)) AS BIGINT)`#x[0] AS dotNET_udf(CEIL(udf(sum(earnings))))#xL, __pivot_(avg(__auto_generated_subquery_name.earnings) + CAST(1 AS DOUBLE)) AS a1 AS `(avg(__auto_generated_subquery_name.earnings) + CAST(1 AS DOUBLE)) AS a1`#x[0] AS dotNET_a1#x, __pivot_CAST(udf(cast(CEIL(cast(udf(cast(sum(earnings) as string)) as bigint)) as string)) AS BIGINT) AS `CAST(udf(cast(CEIL(cast(udf(cast(sum(earnings) as string)) as bigint)) as string)) AS BIGINT)`#x[1] AS Java_udf(CEIL(udf(sum(earnings))))#xL, __pivot_(avg(__auto_generated_subquery_name.earnings) + CAST(1 AS DOUBLE)) AS a1 AS `(avg(__auto_generated_subquery_name.earnings) + CAST(1 AS DOUBLE)) AS a1`#x[1] AS Java_a1#x]
   +- Aggregate [year#x], [year#x, pivotfirst(course#x, CAST(udf(cast(CEIL(cast(udf(cast(sum(earnings) as string)) as bigint)) as string)) AS BIGINT)#xL, dotNET, Java, 0, 0) AS __pivot_CAST(udf(cast(CEIL(cast(udf(cast(sum(earnings) as string)) as bigint)) as string)) AS BIGINT) AS `CAST(udf(cast(CEIL(cast(udf(cast(sum(earnings) as string)) as bigint)) as string)) AS BIGINT)`#x, pivotfirst(course#x, (avg(__auto_generated_subquery_name.earnings) + CAST(1 AS DOUBLE)) AS a1#x, dotNET, Java, 0, 0) AS __pivot_(avg(__auto_generated_subquery_name.earnings) + CAST(1 AS DOUBLE)) AS a1 AS `(avg(__auto_generated_subquery_name.earnings) + CAST(1 AS DOUBLE)) AS a1`#x]
      +- Aggregate [year#x, course#x], [year#x, course#x, cast(udf(cast(CEIL(cast(udf(cast(sum(earnings#x) as string)) as bigint)) as string)) as bigint) AS CAST(udf(cast(CEIL(cast(udf(cast(sum(earnings) as string)) as bigint)) as string)) AS BIGINT)#xL, (avg(earnings#x) + cast(1 as double)) AS (avg(__auto_generated_subquery_name.earnings) + CAST(1 AS DOUBLE)) AS a1#x]
         +- SubqueryAlias __auto_generated_subquery_name
            +- Project [year#x, course#x, earnings#x]
               +- SubqueryAlias coursesales
                  +- View (`courseSales`, [course#x, year#x, earnings#x])
                     +- Project [cast(course#x as string) AS course#x, cast(year#x as int) AS year#x, cast(earnings#x as int) AS earnings#x]
                        +- Project [course#x, year#x, earnings#x]
                           +- SubqueryAlias courseSales
                              +- LocalRelation [course#x, year#x, earnings#x]


-- !query
SELECT * FROM (
  SELECT year, course, earnings FROM courseSales
)
PIVOT (
  sum(udf(avg(earnings)))
  FOR course IN ('dotNET', 'Java')
)
-- !query analysis
org.apache.spark.sql.catalyst.ExtendedAnalysisException
{
  "errorClass" : "NESTED_AGGREGATE_FUNCTION",
  "sqlState" : "42607",
  "queryContext" : [ {
    "objectType" : "",
    "objectName" : "",
    "startIndex" : 86,
    "stopIndex" : 98,
    "fragment" : "avg(earnings)"
  } ]
}


-- !query
SELECT * FROM (
  SELECT course, year, earnings, s
  FROM courseSales
  JOIN years ON year = y
)
PIVOT (
  udf(sum(earnings))
  FOR (course, year) IN (('dotNET', 2012), ('Java', 2013))
)
-- !query analysis
Project [s#x, {dotNET, 2012}#xL, {Java, 2013}#xL]
+- Project [s#x, __pivot_CAST(udf(cast(sum(earnings) as string)) AS BIGINT) AS `CAST(udf(cast(sum(earnings) as string)) AS BIGINT)`#x[0] AS {dotNET, 2012}#xL, __pivot_CAST(udf(cast(sum(earnings) as string)) AS BIGINT) AS `CAST(udf(cast(sum(earnings) as string)) AS BIGINT)`#x[1] AS {Java, 2013}#xL]
   +- Aggregate [s#x], [s#x, pivotfirst(__pivot_col#x, CAST(udf(cast(sum(earnings) as string)) AS BIGINT)#xL, [dotNET,2012], [Java,2013], 0, 0) AS __pivot_CAST(udf(cast(sum(earnings) as string)) AS BIGINT) AS `CAST(udf(cast(sum(earnings) as string)) AS BIGINT)`#x]
      +- Aggregate [s#x, named_struct(course, course#x, year, year#x)], [s#x, named_struct(course, course#x, year, year#x) AS __pivot_col#x, cast(udf(cast(sum(earnings#x) as string)) as bigint) AS CAST(udf(cast(sum(earnings) as string)) AS BIGINT)#xL]
         +- SubqueryAlias __auto_generated_subquery_name
            +- Project [course#x, year#x, earnings#x, s#x]
               +- Join Inner, (year#x = y#x)
                  :- SubqueryAlias coursesales
                  :  +- View (`courseSales`, [course#x, year#x, earnings#x])
                  :     +- Project [cast(course#x as string) AS course#x, cast(year#x as int) AS year#x, cast(earnings#x as int) AS earnings#x]
                  :        +- Project [course#x, year#x, earnings#x]
                  :           +- SubqueryAlias courseSales
                  :              +- LocalRelation [course#x, year#x, earnings#x]
                  +- SubqueryAlias years
                     +- View (`years`, [y#x, s#x])
                        +- Project [cast(y#x as int) AS y#x, cast(s#x as int) AS s#x]
                           +- Project [y#x, s#x]
                              +- SubqueryAlias years
                                 +- LocalRelation [y#x, s#x]


-- !query
SELECT * FROM (
  SELECT course, year, earnings, s
  FROM courseSales
  JOIN years ON year = y
)
PIVOT (
  udf(sum(earnings))
  FOR (course, s) IN (('dotNET', 2) as c1, ('Java', 1) as c2)
)
-- !query analysis
Project [year#x, c1#xL, c2#xL]
+- Project [year#x, __pivot_CAST(udf(cast(sum(earnings) as string)) AS BIGINT) AS `CAST(udf(cast(sum(earnings) as string)) AS BIGINT)`#x[0] AS c1#xL, __pivot_CAST(udf(cast(sum(earnings) as string)) AS BIGINT) AS `CAST(udf(cast(sum(earnings) as string)) AS BIGINT)`#x[1] AS c2#xL]
   +- Aggregate [year#x], [year#x, pivotfirst(__pivot_col#x, CAST(udf(cast(sum(earnings) as string)) AS BIGINT)#xL, [dotNET,2], [Java,1], 0, 0) AS __pivot_CAST(udf(cast(sum(earnings) as string)) AS BIGINT) AS `CAST(udf(cast(sum(earnings) as string)) AS BIGINT)`#x]
      +- Aggregate [year#x, named_struct(course, course#x, s, s#x)], [year#x, named_struct(course, course#x, s, s#x) AS __pivot_col#x, cast(udf(cast(sum(earnings#x) as string)) as bigint) AS CAST(udf(cast(sum(earnings) as string)) AS BIGINT)#xL]
         +- SubqueryAlias __auto_generated_subquery_name
            +- Project [course#x, year#x, earnings#x, s#x]
               +- Join Inner, (year#x = y#x)
                  :- SubqueryAlias coursesales
                  :  +- View (`courseSales`, [course#x, year#x, earnings#x])
                  :     +- Project [cast(course#x as string) AS course#x, cast(year#x as int) AS year#x, cast(earnings#x as int) AS earnings#x]
                  :        +- Project [course#x, year#x, earnings#x]
                  :           +- SubqueryAlias courseSales
                  :              +- LocalRelation [course#x, year#x, earnings#x]
                  +- SubqueryAlias years
                     +- View (`years`, [y#x, s#x])
                        +- Project [cast(y#x as int) AS y#x, cast(s#x as int) AS s#x]
                           +- Project [y#x, s#x]
                              +- SubqueryAlias years
                                 +- LocalRelation [y#x, s#x]


-- !query
SELECT * FROM (
  SELECT course, year, earnings, s
  FROM courseSales
  JOIN years ON year = y
)
PIVOT (
  udf(sum(earnings))
  FOR (course, year) IN ('dotNET', 'Java')
)
-- !query analysis
org.apache.spark.sql.AnalysisException
{
  "errorClass" : "PIVOT_VALUE_DATA_TYPE_MISMATCH",
  "sqlState" : "42K09",
  "messageParameters" : {
    "pivotType" : "struct<course:string,year:int>",
    "value" : "dotNET",
    "valueType" : "string"
  }
}


-- !query
SELECT * FROM courseSales
PIVOT (
  udf(sum(earnings))
  FOR year IN (s, 2013)
)
-- !query analysis
org.apache.spark.sql.catalyst.ExtendedAnalysisException
{
  "errorClass" : "UNRESOLVED_COLUMN.WITH_SUGGESTION",
  "sqlState" : "42703",
  "messageParameters" : {
    "objectName" : "`s`",
    "proposal" : "`year`, `course`, `earnings`"
  },
  "queryContext" : [ {
    "objectType" : "",
    "objectName" : "",
    "startIndex" : 71,
    "stopIndex" : 71,
    "fragment" : "s"
  } ]
}


-- !query
SELECT * FROM courseSales
PIVOT (
  udf(sum(earnings))
  FOR year IN (course, 2013)
)
-- !query analysis
org.apache.spark.sql.AnalysisException
{
  "errorClass" : "NON_LITERAL_PIVOT_VALUES",
  "sqlState" : "42K08",
  "messageParameters" : {
    "expression" : "\"course\""
  }
}


-- !query
SELECT * FROM (
  SELECT earnings, year, a
  FROM courseSales
  JOIN yearsWithComplexTypes ON year = y
)
PIVOT (
  udf(sum(earnings))
  FOR a IN (array(1, 1), array(2, 2))
)
-- !query analysis
Project [year#x, [1, 1]#xL, [2, 2]#xL]
+- Project [year#x, __pivot_CAST(udf(cast(sum(earnings) as string)) AS BIGINT) AS `CAST(udf(cast(sum(earnings) as string)) AS BIGINT)`#x[0] AS [1, 1]#xL, __pivot_CAST(udf(cast(sum(earnings) as string)) AS BIGINT) AS `CAST(udf(cast(sum(earnings) as string)) AS BIGINT)`#x[1] AS [2, 2]#xL]
   +- Aggregate [year#x], [year#x, pivotfirst(a#x, CAST(udf(cast(sum(earnings) as string)) AS BIGINT)#xL, [1,1], [2,2], 0, 0) AS __pivot_CAST(udf(cast(sum(earnings) as string)) AS BIGINT) AS `CAST(udf(cast(sum(earnings) as string)) AS BIGINT)`#x]
      +- Aggregate [year#x, a#x], [year#x, a#x, cast(udf(cast(sum(earnings#x) as string)) as bigint) AS CAST(udf(cast(sum(earnings) as string)) AS BIGINT)#xL]
         +- SubqueryAlias __auto_generated_subquery_name
            +- Project [earnings#x, year#x, a#x]
               +- Join Inner, (year#x = y#x)
                  :- SubqueryAlias coursesales
                  :  +- View (`courseSales`, [course#x, year#x, earnings#x])
                  :     +- Project [cast(course#x as string) AS course#x, cast(year#x as int) AS year#x, cast(earnings#x as int) AS earnings#x]
                  :        +- Project [course#x, year#x, earnings#x]
                  :           +- SubqueryAlias courseSales
                  :              +- LocalRelation [course#x, year#x, earnings#x]
                  +- SubqueryAlias yearswithcomplextypes
                     +- View (`yearsWithComplexTypes`, [y#x, a#x, m#x, s#x])
                        +- Project [cast(y#x as int) AS y#x, cast(a#x as array<int>) AS a#x, cast(m#x as map<string,int>) AS m#x, cast(s#x as struct<col1:int,col2:string>) AS s#x]
                           +- Project [y#x, a#x, m#x, s#x]
                              +- SubqueryAlias yearsWithComplexTypes
                                 +- LocalRelation [y#x, a#x, m#x, s#x]


-- !query
SELECT * FROM (
  SELECT course, earnings, udf(year) as year, a
  FROM courseSales
  JOIN yearsWithComplexTypes ON year = y
)
PIVOT (
  udf(sum(earnings))
  FOR (course, a) IN (('dotNET', array(1, 1)), ('Java', array(2, 2)))
)
-- !query analysis
Project [year#x, {dotNET, [1, 1]}#xL, {Java, [2, 2]}#xL]
+- Project [year#x, __pivot_CAST(udf(cast(sum(earnings) as string)) AS BIGINT) AS `CAST(udf(cast(sum(earnings) as string)) AS BIGINT)`#x[0] AS {dotNET, [1, 1]}#xL, __pivot_CAST(udf(cast(sum(earnings) as string)) AS BIGINT) AS `CAST(udf(cast(sum(earnings) as string)) AS BIGINT)`#x[1] AS {Java, [2, 2]}#xL]
   +- Aggregate [year#x], [year#x, pivotfirst(__pivot_col#x, CAST(udf(cast(sum(earnings) as string)) AS BIGINT)#xL, [dotNET,[1,1]], [Java,[2,2]], 0, 0) AS __pivot_CAST(udf(cast(sum(earnings) as string)) AS BIGINT) AS `CAST(udf(cast(sum(earnings) as string)) AS BIGINT)`#x]
      +- Aggregate [year#x, named_struct(course, course#x, a, a#x)], [year#x, named_struct(course, course#x, a, a#x) AS __pivot_col#x, cast(udf(cast(sum(earnings#x) as string)) as bigint) AS CAST(udf(cast(sum(earnings) as string)) AS BIGINT)#xL]
         +- SubqueryAlias __auto_generated_subquery_name
            +- Project [course#x, earnings#x, cast(udf(cast(year#x as string)) as int) AS year#x, a#x]
               +- Join Inner, (year#x = y#x)
                  :- SubqueryAlias coursesales
                  :  +- View (`courseSales`, [course#x, year#x, earnings#x])
                  :     +- Project [cast(course#x as string) AS course#x, cast(year#x as int) AS year#x, cast(earnings#x as int) AS earnings#x]
                  :        +- Project [course#x, year#x, earnings#x]
                  :           +- SubqueryAlias courseSales
                  :              +- LocalRelation [course#x, year#x, earnings#x]
                  +- SubqueryAlias yearswithcomplextypes
                     +- View (`yearsWithComplexTypes`, [y#x, a#x, m#x, s#x])
                        +- Project [cast(y#x as int) AS y#x, cast(a#x as array<int>) AS a#x, cast(m#x as map<string,int>) AS m#x, cast(s#x as struct<col1:int,col2:string>) AS s#x]
                           +- Project [y#x, a#x, m#x, s#x]
                              +- SubqueryAlias yearsWithComplexTypes
                                 +- LocalRelation [y#x, a#x, m#x, s#x]


-- !query
SELECT * FROM (
  SELECT earnings, year, s
  FROM courseSales
  JOIN yearsWithComplexTypes ON year = y
)
PIVOT (
  udf(sum(earnings))
  FOR s IN ((1, 'a'), (2, 'b'))
)
-- !query analysis
Project [year#x, {1, a}#xL, {2, b}#xL]
+- Project [year#x, __pivot_CAST(udf(cast(sum(earnings) as string)) AS BIGINT) AS `CAST(udf(cast(sum(earnings) as string)) AS BIGINT)`#x[0] AS {1, a}#xL, __pivot_CAST(udf(cast(sum(earnings) as string)) AS BIGINT) AS `CAST(udf(cast(sum(earnings) as string)) AS BIGINT)`#x[1] AS {2, b}#xL]
   +- Aggregate [year#x], [year#x, pivotfirst(s#x, CAST(udf(cast(sum(earnings) as string)) AS BIGINT)#xL, [1,a], [2,b], 0, 0) AS __pivot_CAST(udf(cast(sum(earnings) as string)) AS BIGINT) AS `CAST(udf(cast(sum(earnings) as string)) AS BIGINT)`#x]
      +- Aggregate [year#x, s#x], [year#x, s#x, cast(udf(cast(sum(earnings#x) as string)) as bigint) AS CAST(udf(cast(sum(earnings) as string)) AS BIGINT)#xL]
         +- SubqueryAlias __auto_generated_subquery_name
            +- Project [earnings#x, year#x, s#x]
               +- Join Inner, (year#x = y#x)
                  :- SubqueryAlias coursesales
                  :  +- View (`courseSales`, [course#x, year#x, earnings#x])
                  :     +- Project [cast(course#x as string) AS course#x, cast(year#x as int) AS year#x, cast(earnings#x as int) AS earnings#x]
                  :        +- Project [course#x, year#x, earnings#x]
                  :           +- SubqueryAlias courseSales
                  :              +- LocalRelation [course#x, year#x, earnings#x]
                  +- SubqueryAlias yearswithcomplextypes
                     +- View (`yearsWithComplexTypes`, [y#x, a#x, m#x, s#x])
                        +- Project [cast(y#x as int) AS y#x, cast(a#x as array<int>) AS a#x, cast(m#x as map<string,int>) AS m#x, cast(s#x as struct<col1:int,col2:string>) AS s#x]
                           +- Project [y#x, a#x, m#x, s#x]
                              +- SubqueryAlias yearsWithComplexTypes
                                 +- LocalRelation [y#x, a#x, m#x, s#x]


-- !query
SELECT * FROM (
  SELECT course, earnings, year, s
  FROM courseSales
  JOIN yearsWithComplexTypes ON year = y
)
PIVOT (
  udf(sum(earnings))
  FOR (course, s) IN (('dotNET', (1, 'a')), ('Java', (2, 'b')))
)
-- !query analysis
Project [year#x, {dotNET, {1, a}}#xL, {Java, {2, b}}#xL]
+- Project [year#x, __pivot_CAST(udf(cast(sum(earnings) as string)) AS BIGINT) AS `CAST(udf(cast(sum(earnings) as string)) AS BIGINT)`#x[0] AS {dotNET, {1, a}}#xL, __pivot_CAST(udf(cast(sum(earnings) as string)) AS BIGINT) AS `CAST(udf(cast(sum(earnings) as string)) AS BIGINT)`#x[1] AS {Java, {2, b}}#xL]
   +- Aggregate [year#x], [year#x, pivotfirst(__pivot_col#x, CAST(udf(cast(sum(earnings) as string)) AS BIGINT)#xL, [dotNET,[1,a]], [Java,[2,b]], 0, 0) AS __pivot_CAST(udf(cast(sum(earnings) as string)) AS BIGINT) AS `CAST(udf(cast(sum(earnings) as string)) AS BIGINT)`#x]
      +- Aggregate [year#x, named_struct(course, course#x, s, s#x)], [year#x, named_struct(course, course#x, s, s#x) AS __pivot_col#x, cast(udf(cast(sum(earnings#x) as string)) as bigint) AS CAST(udf(cast(sum(earnings) as string)) AS BIGINT)#xL]
         +- SubqueryAlias __auto_generated_subquery_name
            +- Project [course#x, earnings#x, year#x, s#x]
               +- Join Inner, (year#x = y#x)
                  :- SubqueryAlias coursesales
                  :  +- View (`courseSales`, [course#x, year#x, earnings#x])
                  :     +- Project [cast(course#x as string) AS course#x, cast(year#x as int) AS year#x, cast(earnings#x as int) AS earnings#x]
                  :        +- Project [course#x, year#x, earnings#x]
                  :           +- SubqueryAlias courseSales
                  :              +- LocalRelation [course#x, year#x, earnings#x]
                  +- SubqueryAlias yearswithcomplextypes
                     +- View (`yearsWithComplexTypes`, [y#x, a#x, m#x, s#x])
                        +- Project [cast(y#x as int) AS y#x, cast(a#x as array<int>) AS a#x, cast(m#x as map<string,int>) AS m#x, cast(s#x as struct<col1:int,col2:string>) AS s#x]
                           +- Project [y#x, a#x, m#x, s#x]
                              +- SubqueryAlias yearsWithComplexTypes
                                 +- LocalRelation [y#x, a#x, m#x, s#x]


-- !query
SELECT * FROM (
  SELECT earnings, year, m
  FROM courseSales
  JOIN yearsWithComplexTypes ON year = y
)
PIVOT (
  udf(sum(earnings))
  FOR m IN (map('1', 1), map('2', 2))
)
-- !query analysis
org.apache.spark.sql.AnalysisException
{
  "errorClass" : "INCOMPARABLE_PIVOT_COLUMN",
  "sqlState" : "42818",
  "messageParameters" : {
    "columnName" : "`m`"
  }
}


-- !query
SELECT * FROM (
  SELECT course, earnings, year, m
  FROM courseSales
  JOIN yearsWithComplexTypes ON year = y
)
PIVOT (
  udf(sum(earnings))
  FOR (course, m) IN (('dotNET', map('1', 1)), ('Java', map('2', 2)))
)
-- !query analysis
org.apache.spark.sql.AnalysisException
{
  "errorClass" : "INCOMPARABLE_PIVOT_COLUMN",
  "sqlState" : "42818",
  "messageParameters" : {
    "columnName" : "`named_struct('course', __auto_generated_subquery_name`.`course, 'm', __auto_generated_subquery_name`.`m)`"
  }
}


-- !query
SELECT * FROM (
  SELECT course, earnings, udf("a") as a, udf("z") as z, udf("b") as b, udf("y") as y,
  udf("c") as c, udf("x") as x, udf("d") as d, udf("w") as w
  FROM courseSales
)
PIVOT (
  udf(sum(Earnings))
  FOR Course IN ('dotNET', 'Java')
)
-- !query analysis
Project [a#x, z#x, b#x, y#x, c#x, x#x, d#x, w#x, dotNET#xL, Java#xL]
+- Project [a#x, z#x, b#x, y#x, c#x, x#x, d#x, w#x, __pivot_CAST(udf(cast(sum(Earnings) as string)) AS BIGINT) AS `CAST(udf(cast(sum(Earnings) as string)) AS BIGINT)`#x[0] AS dotNET#xL, __pivot_CAST(udf(cast(sum(Earnings) as string)) AS BIGINT) AS `CAST(udf(cast(sum(Earnings) as string)) AS BIGINT)`#x[1] AS Java#xL]
   +- Aggregate [a#x, z#x, b#x, y#x, c#x, x#x, d#x, w#x], [a#x, z#x, b#x, y#x, c#x, x#x, d#x, w#x, pivotfirst(Course#x, CAST(udf(cast(sum(Earnings) as string)) AS BIGINT)#xL, dotNET, Java, 0, 0) AS __pivot_CAST(udf(cast(sum(Earnings) as string)) AS BIGINT) AS `CAST(udf(cast(sum(Earnings) as string)) AS BIGINT)`#x]
      +- Aggregate [a#x, z#x, b#x, y#x, c#x, x#x, d#x, w#x, Course#x], [a#x, z#x, b#x, y#x, c#x, x#x, d#x, w#x, Course#x, cast(udf(cast(sum(Earnings#x) as string)) as bigint) AS CAST(udf(cast(sum(Earnings) as string)) AS BIGINT)#xL]
         +- SubqueryAlias __auto_generated_subquery_name
            +- Project [course#x, earnings#x, cast(udf(cast(a as string)) as string) AS a#x, cast(udf(cast(z as string)) as string) AS z#x, cast(udf(cast(b as string)) as string) AS b#x, cast(udf(cast(y as string)) as string) AS y#x, cast(udf(cast(c as string)) as string) AS c#x, cast(udf(cast(x as string)) as string) AS x#x, cast(udf(cast(d as string)) as string) AS d#x, cast(udf(cast(w as string)) as string) AS w#x]
               +- SubqueryAlias coursesales
                  +- View (`courseSales`, [course#x, year#x, earnings#x])
                     +- Project [cast(course#x as string) AS course#x, cast(year#x as int) AS year#x, cast(earnings#x as int) AS earnings#x]
                        +- Project [course#x, year#x, earnings#x]
                           +- SubqueryAlias courseSales
                              +- LocalRelation [course#x, year#x, earnings#x]
