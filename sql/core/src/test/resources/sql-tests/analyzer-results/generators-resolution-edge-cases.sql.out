-- Automatically generated by SQLQueryTestSuite
-- !query
SELECT explode(explode(array(array(1, 2, 3))))
-- !query analysis
org.apache.spark.sql.AnalysisException
{
  "errorClass" : "UNSUPPORTED_GENERATOR.NESTED_IN_EXPRESSIONS",
  "sqlState" : "42K0E",
  "messageParameters" : {
    "expression" : "\"explode(explode(array(array(1, 2, 3))))\""
  }
}


-- !query
SELECT 1 + explode(array(1, 2, 3))
-- !query analysis
org.apache.spark.sql.AnalysisException
{
  "errorClass" : "UNSUPPORTED_GENERATOR.NESTED_IN_EXPRESSIONS",
  "sqlState" : "42K0E",
  "messageParameters" : {
    "expression" : "\"(1 + explode(array(1, 2, 3)))\""
  }
}


-- !query
SELECT explode(array(0, 1, 2)), explode(array(10, 20))
-- !query analysis
Project [col#x, col#x]
+- Generate explode(array(10, 20)), false, [col#x]
   +- Generate explode(array(0, 1, 2)), false, [col#x]
      +- OneRowRelation


-- !query
SELECT explode(array(sin(0), 1, 2)), explode(array(10, 20))
-- !query analysis
Project [col#x, col#x]
+- Generate explode(array(SIN(cast(0 as double)), cast(1 as double), cast(2 as double))), false, [col#x]
   +- Generate explode(array(10, 20)), false, [col#x]
      +- OneRowRelation


-- !query
SELECT explode(array(1, 2)), explode(array(3, 4)), count(*)
-- !query analysis
org.apache.spark.sql.AnalysisException
{
  "errorClass" : "UNSUPPORTED_GENERATOR.MULTI_GENERATOR",
  "sqlState" : "42K0E",
  "messageParameters" : {
    "generators" : "\"explode(array(1, 2))\", \"explode(array(3, 4))\"",
    "num" : "2"
  }
}


-- !query
SELECT explode(array(1, 2)) AS a, posexplode(array('x', 'y', 'z')) AS (pos, b)
-- !query analysis
Project [a#x, pos#x, b#x]
+- Generate posexplode(array(x, y, z)), false, [pos#x, b#x]
   +- Generate explode(array(1, 2)), false, [a#x]
      +- OneRowRelation


-- !query
SELECT explode(collect_list(id)) AS val FROM range(5)
-- !query analysis
Project [val#xL]
+- Generate explode(_gen_input_0#x), false, [val#xL]
   +- Aggregate [collect_list(id#xL, 0, 0) AS _gen_input_0#x]
      +- Range (0, 5, step=1)


-- !query
SELECT explode(collect_list(id)) AS val, count(*) AS cnt FROM range(3)
-- !query analysis
Project [val#xL, cnt#xL]
+- Generate explode(_gen_input_0#x), false, [val#xL]
   +- Aggregate [collect_list(id#xL, 0, 0) AS _gen_input_0#x, count(1) AS cnt#xL]
      +- Range (0, 3, step=1)


-- !query
SELECT id, explode(array(1, 2, 3)) AS array_element
FROM (VALUES (1), (2)) AS t(id)
GROUP BY id, array_element
-- !query analysis
org.apache.spark.sql.catalyst.ExtendedAnalysisException
{
  "errorClass" : "UNRESOLVED_COLUMN.WITH_SUGGESTION",
  "sqlState" : "42703",
  "messageParameters" : {
    "objectName" : "`array_element`",
    "proposal" : "`id`"
  },
  "queryContext" : [ {
    "objectType" : "",
    "objectName" : "",
    "startIndex" : 98,
    "stopIndex" : 110,
    "fragment" : "array_element"
  } ]
}


-- !query
SELECT id, posexplode_outer(CASE WHEN id = 1 THEN array('a', 'b') ELSE null END) AS (pos, val)
FROM range(3)
-- !query analysis
Project [id#xL, pos#x, val#x]
+- Generate posexplode(CASE WHEN (id#xL = cast(1 as bigint)) THEN array(a, b) ELSE cast(null as array<string>) END), true, [pos#x, val#x]
   +- Range (0, 3, step=1)


-- !query
WITH cte AS (SELECT explode(array(1, 2, 3)) AS col)
SELECT * FROM cte
UNION ALL
SELECT * FROM cte
-- !query analysis
WithCTE
:- CTERelationDef xxxx, false
:  +- SubqueryAlias cte
:     +- Project [col#x]
:        +- Generate explode(array(1, 2, 3)), false, [col#x]
:           +- OneRowRelation
+- Union false, false
   :- Project [col#x]
   :  +- SubqueryAlias cte
   :     +- CTERelationRef xxxx, true, [col#x], false, false
   +- Project [col#x]
      +- SubqueryAlias cte
         +- CTERelationRef xxxx, true, [col#x], false, false


-- !query
WITH cte AS (SELECT explode(array(1, 2)) AS col)
SELECT t1.col, t2.col FROM cte t1 JOIN cte t2 ON t1.col = t2.col
-- !query analysis
WithCTE
:- CTERelationDef xxxx, false
:  +- SubqueryAlias cte
:     +- Project [col#x]
:        +- Generate explode(array(1, 2)), false, [col#x]
:           +- OneRowRelation
+- Project [col#x, col#x]
   +- Join Inner, (col#x = col#x)
      :- SubqueryAlias t1
      :  +- SubqueryAlias cte
      :     +- CTERelationRef xxxx, true, [col#x], false, false
      +- SubqueryAlias t2
         +- SubqueryAlias cte
            +- CTERelationRef xxxx, true, [col#x], false, false


-- !query
SELECT * FROM (SELECT explode(array(1, 2, 3)) AS val) t WHERE val > 1
-- !query analysis
Project [val#x]
+- Filter (val#x > 1)
   +- SubqueryAlias t
      +- Project [val#x]
         +- Generate explode(array(1, 2, 3)), false, [val#x]
            +- OneRowRelation


-- !query
SELECT *
FROM (SELECT * FROM (SELECT explode(array(1, 2, 3, 4, 5)) AS val) WHERE val > 1)
WHERE val < 5
-- !query analysis
Project [val#x]
+- Filter (val#x < 5)
   +- SubqueryAlias __auto_generated_subquery_name
      +- Project [val#x]
         +- Filter (val#x > 1)
            +- SubqueryAlias __auto_generated_subquery_name
               +- Project [val#x]
                  +- Generate explode(array(1, 2, 3, 4, 5)), false, [val#x]
                     +- OneRowRelation


-- !query
SELECT explode(arr) AS package
FROM (VALUES(array('a', 'b'))) AS t(arr)
GROUP BY ALL
-- !query analysis
Project [package#x]
+- Generate explode(_gen_input_0#x), false, [package#x]
   +- Aggregate [arr#x], [arr#x AS _gen_input_0#x]
      +- SubqueryAlias t
         +- Project [col1#x AS arr#x]
            +- LocalRelation [col1#x]


-- !query
SELECT explode(collect_list(a)) AS val
FROM (VALUES ('a'), ('b')) AS t(a)
GROUP BY ALL
-- !query analysis
Project [val#x]
+- Generate explode(_gen_input_0#x), false, [val#x]
   +- Aggregate [collect_list(a#x, 0, 0) AS _gen_input_0#x]
      +- SubqueryAlias t
         +- Project [col1#x AS a#x]
            +- LocalRelation [col1#x]


-- !query
SELECT stack(2, id + 10L, count(val))
FROM (VALUES (1,'a'), (1,'b'), (2, 'c')) AS t(id, val)
GROUP BY ALL
-- !query analysis
Project [col0#xL]
+- Generate stack(2, _gen_input_1#xL, _gen_input_2#xL), false, [col0#xL]
   +- Aggregate [(cast(id#x as bigint) + 10)], [(cast(id#x as bigint) + 10) AS _gen_input_1#xL, count(val#x) AS _gen_input_2#xL]
      +- SubqueryAlias t
         +- Project [col1#x AS id#x, col2#x AS val#x]
            +- LocalRelation [col1#x, col2#x]


-- !query
SELECT id, explode(arr)
FROM (VALUES(42, array('a', 'b', 'c'))) AS t(id, arr)
GROUP BY id, 2
-- !query analysis
Project [id#x, col#x]
+- Generate explode(_gen_input_0#x), false, [col#x]
   +- Aggregate [id#x, arr#x], [id#x, arr#x AS _gen_input_0#x]
      +- SubqueryAlias t
         +- Project [col1#x AS id#x, col2#x AS arr#x]
            +- LocalRelation [col1#x, col2#x]


-- !query
SELECT stack(2, 'first', count(*), arr,
             'second', 0L, array('1', '2', '3')) AS (x1, x2, x3), id
FROM (VALUES (1, array('a', 'b'))) AS t(id, arr)
GROUP BY 2, 3
-- !query analysis
Project [x1#x, x2#xL, x3#x, id#x]
+- Generate stack(2, first, _gen_input_2#xL, _gen_input_3#x, second, 0, array(1, 2, 3)), false, [x1#x, x2#xL, x3#x]
   +- Aggregate [arr#x, id#x], [count(1) AS _gen_input_2#xL, arr#x AS _gen_input_3#x, id#x]
      +- SubqueryAlias t
         +- Project [col1#x AS id#x, col2#x AS arr#x]
            +- LocalRelation [col1#x, col2#x]


-- !query
SELECT stack(2, 'first', count(*), arr,
             'second', 0L, array('1', '2', '3')) AS (x1, x2, x3), id
FROM (VALUES (1, array('a', 'b'))) AS t(id, arr)
GROUP BY _gen_input_3, id
-- !query analysis
Project [x1#x, x2#xL, x3#x, id#x]
+- Generate stack(2, first, _gen_input_2#xL, _gen_input_3#x, second, 0, array(1, 2, 3)), false, [x1#x, x2#xL, x3#x]
   +- Aggregate [arr#x, id#x], [count(1) AS _gen_input_2#xL, arr#x AS _gen_input_3#x, id#x]
      +- SubqueryAlias t
         +- Project [col1#x AS id#x, col2#x AS arr#x]
            +- LocalRelation [col1#x, col2#x]


-- !query
SELECT stack(2, 'first', count(*), arr,
             'second', 0L, array('1', '2', '3')) AS (x1, x2, x3), id
FROM (VALUES (1, array('a', 'b'))) AS t(id, arr)
GROUP BY _gen_input_3, id
HAVING size (_gen_input_3) > 0
-- !query analysis
org.apache.spark.sql.catalyst.ExtendedAnalysisException
{
  "errorClass" : "UNRESOLVED_COLUMN.WITH_SUGGESTION",
  "sqlState" : "42703",
  "messageParameters" : {
    "objectName" : "`_gen_input_3`",
    "proposal" : "`t`.`id`, `x1`, `x2`, `x3`"
  },
  "queryContext" : [ {
    "objectType" : "",
    "objectName" : "",
    "startIndex" : 198,
    "stopIndex" : 209,
    "fragment" : "_gen_input_3"
  } ]
}


-- !query
SELECT explode(array(t1.c1, t2.c1)) AS x1
FROM (VALUES (1), (2)) AS t1(c1)
         FULL OUTER JOIN (VALUES (2), (3)) AS t2(c1)
                         USING (c1)
-- !query analysis
Project [x1#x]
+- Project [c1#x, x1#x]
   +- Generate explode(array(c1#x, c1#x)), false, [x1#x]
      +- Project [coalesce(c1#x, c1#x) AS c1#x, c1#x, c1#x]
         +- Join FullOuter, (c1#x = c1#x)
            :- SubqueryAlias t1
            :  +- Project [col1#x AS c1#x]
            :     +- LocalRelation [col1#x]
            +- SubqueryAlias t2
               +- Project [col1#x AS c1#x]
                  +- LocalRelation [col1#x]


-- !query
SELECT explode(array(t1.c1, t2.c1)) AS x1, explode(array(t1.c1)) AS x2
FROM (VALUES (1), (2), (3)) AS t1(c1)
         FULL OUTER JOIN (VALUES (2), (3), (4)) AS t2(c1)
                         USING (c1)
-- !query analysis
Project [x1#x, x2#x]
+- Project [c1#x, x1#x, x2#x]
   +- Generate explode(array(c1#x)), false, [x2#x]
      +- Project [c1#x, x1#x, c1#x]
         +- Generate explode(array(c1#x, c1#x)), false, [x1#x]
            +- Project [coalesce(c1#x, c1#x) AS c1#x, c1#x, c1#x]
               +- Join FullOuter, (c1#x = c1#x)
                  :- SubqueryAlias t1
                  :  +- Project [col1#x AS c1#x]
                  :     +- LocalRelation [col1#x]
                  +- SubqueryAlias t2
                     +- Project [col1#x AS c1#x]
                        +- LocalRelation [col1#x]


-- !query
SELECT id, posexplode(arr) AS (index, value), index, value
FROM (VALUES (42, array('a', 'b', 'c')), (42, array('t'))) AS t(id, arr)
-- !query analysis
Project [id#x, index#x, value#x, index#x, value#x]
+- Generate posexplode(arr#x), false, [index#x, value#x]
   +- SubqueryAlias t
      +- Project [col1#x AS id#x, col2#x AS arr#x]
         +- LocalRelation [col1#x, col2#x]


-- !query
SELECT array(1, 2, 3) as arr, explode(arr) as col
-- !query analysis
org.apache.spark.SparkException
{
  "errorClass" : "INTERNAL_ERROR",
  "sqlState" : "XX000",
  "messageParameters" : {
    "message" : "Resolved plan should not contain any LateralColumnAliasReference.\nDebugging information: plan:\nGenerate explode(lateralAliasReference(arr)), false, [col#x]\n+- OneRowRelation\n"
  },
  "queryContext" : [ {
    "objectType" : "",
    "objectName" : "",
    "startIndex" : 39,
    "stopIndex" : 41,
    "fragment" : "arr"
  } ]
}


-- !query
SELECT array(1, 2, 3) as arr, explode(arr) as col, count(*)
-- !query analysis
Project [arr#x, col#x, count(1)#xL]
+- Generate explode(_gen_input_0#x), false, [col#x]
   +- Project [arr#x, arr#x AS _gen_input_0#x, count(1)#xL AS count(1)#xL]
      +- Project [count(1)#xL, array(1, 2, 3) AS arr#x]
         +- Aggregate [count(1) AS count(1)#xL]
            +- OneRowRelation


-- !query
SELECT array(1, 2, 3) as arr, explode(arr) as col, count(*), col + 1 as col2
-- !query analysis
org.apache.spark.sql.catalyst.ExtendedAnalysisException
{
  "errorClass" : "UNRESOLVED_COLUMN.WITHOUT_SUGGESTION",
  "sqlState" : "42703",
  "messageParameters" : {
    "objectName" : "`col`"
  },
  "queryContext" : [ {
    "objectType" : "",
    "objectName" : "",
    "startIndex" : 62,
    "stopIndex" : 64,
    "fragment" : "col"
  } ]
}


-- !query
SELECT explode(array(1, 2, 3)) as col, col + 1 as col2, count(*)
-- !query analysis
org.apache.spark.sql.catalyst.ExtendedAnalysisException
{
  "errorClass" : "UNRESOLVED_COLUMN.WITHOUT_SUGGESTION",
  "sqlState" : "42703",
  "messageParameters" : {
    "objectName" : "`col`"
  },
  "queryContext" : [ {
    "objectType" : "",
    "objectName" : "",
    "startIndex" : 40,
    "stopIndex" : 42,
    "fragment" : "col"
  } ]
}


-- !query
SELECT array(1, 2, 3) as arr, explode(arr) as col, col + 1 as col2
-- !query analysis
org.apache.spark.SparkException
{
  "errorClass" : "INTERNAL_ERROR",
  "sqlState" : "XX000",
  "messageParameters" : {
    "message" : "Resolved plan should not contain any LateralColumnAliasReference.\nDebugging information: plan:\nGenerate explode(lateralAliasReference(arr)), false, [col#x]\n+- OneRowRelation\n"
  },
  "queryContext" : [ {
    "objectType" : "",
    "objectName" : "",
    "startIndex" : 39,
    "stopIndex" : 41,
    "fragment" : "arr"
  } ]
}


-- !query
SELECT explode(array(1, 2, 3)) as col, col + 1 as col2
-- !query analysis
Project [col#x, (col#x + 1) AS col2#x]
+- Generate explode(array(1, 2, 3)), false, [col#x]
   +- OneRowRelation


-- !query
SELECT explode(array(1, 2, 3)) as col, count(*) OVER ()
-- !query analysis
Project [col#x, count(1) OVER (ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)#xL]
+- Project [col#x, count(1) OVER (ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)#xL, count(1) OVER (ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)#xL]
   +- Window [count(1) windowspecdefinition(specifiedwindowframe(RowFrame, unboundedpreceding$(), unboundedfollowing$())) AS count(1) OVER (ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)#xL]
      +- Project [col#x]
         +- Generate explode(array(1, 2, 3)), false, [col#x]
            +- OneRowRelation


-- !query
SELECT explode(array(1, 2, 3)), count(*) OVER (), count(*)
-- !query analysis
Project [col#x, count(1) OVER (ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)#xL, count(1)#xL]
+- Generate explode(array(1, 2, 3)), false, [col#x]
   +- Project [count(1) OVER (ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)#xL, count(1)#xL]
      +- Project [count(1)#xL, count(1) OVER (ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)#xL, count(1) OVER (ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)#xL]
         +- Window [count(1) windowspecdefinition(specifiedwindowframe(RowFrame, unboundedpreceding$(), unboundedfollowing$())) AS count(1) OVER (ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)#xL]
            +- Aggregate [count(1) AS count(1)#xL]
               +- OneRowRelation


-- !query
SELECT explode(array(array(0), array(1), array(2))) as arr, explode(arr) as col
-- !query analysis
Project [arr#x, col#x]
+- Generate explode(arr#x), false, [col#x]
   +- Generate explode(array(array(0), array(1), array(2))), false, [arr#x]
      +- OneRowRelation


-- !query
SELECT explode(arr) as col, explode(array(array(0), array(1), array(2))) as arr
-- !query analysis
Project [col#x, arr#x]
+- Generate explode(arr#x), false, [col#x]
   +- Generate explode(array(array(0), array(1), array(2))), false, [arr#x]
      +- OneRowRelation
