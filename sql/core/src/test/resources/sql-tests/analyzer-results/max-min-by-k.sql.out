-- Automatically generated by SQLQueryTestSuite
-- !query
CREATE OR REPLACE TEMPORARY VIEW basic_data AS SELECT * FROM VALUES
  ('Alice', 85),
  ('Bob', 92),
  ('Carol', 78),
  ('Dave', 95),
  ('Eve', 88)
AS basic_data(name, score)
-- !query analysis
CreateViewCommand `basic_data`, SELECT * FROM VALUES
  ('Alice', 85),
  ('Bob', 92),
  ('Carol', 78),
  ('Dave', 95),
  ('Eve', 88)
AS basic_data(name, score), false, true, LocalTempView, UNSUPPORTED, true
   +- Project [name#x, score#x]
      +- SubqueryAlias basic_data
         +- LocalRelation [name#x, score#x]


-- !query
SELECT max_by(name, score, 3) FROM basic_data
-- !query analysis
Aggregate [max_by(name#x, score#x, 3, false, 0, 0) AS max_by(name, score, 3)#x]
+- SubqueryAlias basic_data
   +- View (`basic_data`, [name#x, score#x])
      +- Project [cast(name#x as string) AS name#x, cast(score#x as int) AS score#x]
         +- Project [name#x, score#x]
            +- SubqueryAlias basic_data
               +- LocalRelation [name#x, score#x]


-- !query
SELECT min_by(name, score, 3) FROM basic_data
-- !query analysis
Aggregate [min_by(name#x, score#x, 3, true, 0, 0) AS min_by(name, score, 3)#x]
+- SubqueryAlias basic_data
   +- View (`basic_data`, [name#x, score#x])
      +- Project [cast(name#x as string) AS name#x, cast(score#x as int) AS score#x]
         +- Project [name#x, score#x]
            +- SubqueryAlias basic_data
               +- LocalRelation [name#x, score#x]


-- !query
SELECT max_by(name, score, 1) FROM basic_data
-- !query analysis
Aggregate [max_by(name#x, score#x, 1, false, 0, 0) AS max_by(name, score, 1)#x]
+- SubqueryAlias basic_data
   +- View (`basic_data`, [name#x, score#x])
      +- Project [cast(name#x as string) AS name#x, cast(score#x as int) AS score#x]
         +- Project [name#x, score#x]
            +- SubqueryAlias basic_data
               +- LocalRelation [name#x, score#x]


-- !query
SELECT min_by(name, score, 1) FROM basic_data
-- !query analysis
Aggregate [min_by(name#x, score#x, 1, true, 0, 0) AS min_by(name, score, 1)#x]
+- SubqueryAlias basic_data
   +- View (`basic_data`, [name#x, score#x])
      +- Project [cast(name#x as string) AS name#x, cast(score#x as int) AS score#x]
         +- Project [name#x, score#x]
            +- SubqueryAlias basic_data
               +- LocalRelation [name#x, score#x]


-- !query
SELECT max_by(name, score, 10) FROM basic_data
-- !query analysis
Aggregate [max_by(name#x, score#x, 10, false, 0, 0) AS max_by(name, score, 10)#x]
+- SubqueryAlias basic_data
   +- View (`basic_data`, [name#x, score#x])
      +- Project [cast(name#x as string) AS name#x, cast(score#x as int) AS score#x]
         +- Project [name#x, score#x]
            +- SubqueryAlias basic_data
               +- LocalRelation [name#x, score#x]


-- !query
SELECT min_by(name, score, 10) FROM basic_data
-- !query analysis
Aggregate [min_by(name#x, score#x, 10, true, 0, 0) AS min_by(name, score, 10)#x]
+- SubqueryAlias basic_data
   +- View (`basic_data`, [name#x, score#x])
      +- Project [cast(name#x as string) AS name#x, cast(score#x as int) AS score#x]
         +- Project [name#x, score#x]
            +- SubqueryAlias basic_data
               +- LocalRelation [name#x, score#x]


-- !query
CREATE OR REPLACE TEMPORARY VIEW dept_data AS SELECT * FROM VALUES
  ('Eng', 'Alice', 120000),
  ('Eng', 'Bob', 95000),
  ('Eng', 'Carol', 110000),
  ('Sales', 'Dave', 80000),
  ('Sales', 'Eve', 75000),
  ('Sales', 'Frank', 85000)
AS dept_data(dept, emp, salary)
-- !query analysis
CreateViewCommand `dept_data`, SELECT * FROM VALUES
  ('Eng', 'Alice', 120000),
  ('Eng', 'Bob', 95000),
  ('Eng', 'Carol', 110000),
  ('Sales', 'Dave', 80000),
  ('Sales', 'Eve', 75000),
  ('Sales', 'Frank', 85000)
AS dept_data(dept, emp, salary), false, true, LocalTempView, UNSUPPORTED, true
   +- Project [dept#x, emp#x, salary#x]
      +- SubqueryAlias dept_data
         +- LocalRelation [dept#x, emp#x, salary#x]


-- !query
SELECT dept, max_by(emp, salary, 2) FROM dept_data GROUP BY dept ORDER BY dept
-- !query analysis
Sort [dept#x ASC NULLS FIRST], true
+- Aggregate [dept#x], [dept#x, max_by(emp#x, salary#x, 2, false, 0, 0) AS max_by(emp, salary, 2)#x]
   +- SubqueryAlias dept_data
      +- View (`dept_data`, [dept#x, emp#x, salary#x])
         +- Project [cast(dept#x as string) AS dept#x, cast(emp#x as string) AS emp#x, cast(salary#x as int) AS salary#x]
            +- Project [dept#x, emp#x, salary#x]
               +- SubqueryAlias dept_data
                  +- LocalRelation [dept#x, emp#x, salary#x]


-- !query
SELECT dept, min_by(emp, salary, 2) FROM dept_data GROUP BY dept ORDER BY dept
-- !query analysis
Sort [dept#x ASC NULLS FIRST], true
+- Aggregate [dept#x], [dept#x, min_by(emp#x, salary#x, 2, true, 0, 0) AS min_by(emp, salary, 2)#x]
   +- SubqueryAlias dept_data
      +- View (`dept_data`, [dept#x, emp#x, salary#x])
         +- Project [cast(dept#x as string) AS dept#x, cast(emp#x as string) AS emp#x, cast(salary#x as int) AS salary#x]
            +- Project [dept#x, emp#x, salary#x]
               +- SubqueryAlias dept_data
                  +- LocalRelation [dept#x, emp#x, salary#x]


-- !query
CREATE OR REPLACE TEMPORARY VIEW null_data AS SELECT * FROM VALUES
  ('a', 10),
  ('b', NULL),
  ('c', 30),
  ('d', 20)
AS null_data(x, y)
-- !query analysis
CreateViewCommand `null_data`, SELECT * FROM VALUES
  ('a', 10),
  ('b', NULL),
  ('c', 30),
  ('d', 20)
AS null_data(x, y), false, true, LocalTempView, UNSUPPORTED, true
   +- Project [x#x, y#x]
      +- SubqueryAlias null_data
         +- LocalRelation [x#x, y#x]


-- !query
SELECT max_by(x, y, 2) FROM null_data
-- !query analysis
Aggregate [max_by(x#x, y#x, 2, false, 0, 0) AS max_by(x, y, 2)#x]
+- SubqueryAlias null_data
   +- View (`null_data`, [x#x, y#x])
      +- Project [cast(x#x as string) AS x#x, cast(y#x as int) AS y#x]
         +- Project [x#x, y#x]
            +- SubqueryAlias null_data
               +- LocalRelation [x#x, y#x]


-- !query
SELECT min_by(x, y, 2) FROM null_data
-- !query analysis
Aggregate [min_by(x#x, y#x, 2, true, 0, 0) AS min_by(x, y, 2)#x]
+- SubqueryAlias null_data
   +- View (`null_data`, [x#x, y#x])
      +- Project [cast(x#x as string) AS x#x, cast(y#x as int) AS y#x]
         +- Project [x#x, y#x]
            +- SubqueryAlias null_data
               +- LocalRelation [x#x, y#x]


-- !query
CREATE OR REPLACE TEMPORARY VIEW null_value_data AS SELECT * FROM VALUES
  (NULL, 10),
  ('b', 20),
  ('c', 30)
AS null_value_data(x, y)
-- !query analysis
CreateViewCommand `null_value_data`, SELECT * FROM VALUES
  (NULL, 10),
  ('b', 20),
  ('c', 30)
AS null_value_data(x, y), false, true, LocalTempView, UNSUPPORTED, true
   +- Project [x#x, y#x]
      +- SubqueryAlias null_value_data
         +- LocalRelation [x#x, y#x]


-- !query
SELECT max_by(x, y, 2) FROM null_value_data
-- !query analysis
Aggregate [max_by(x#x, y#x, 2, false, 0, 0) AS max_by(x, y, 2)#x]
+- SubqueryAlias null_value_data
   +- View (`null_value_data`, [x#x, y#x])
      +- Project [cast(x#x as string) AS x#x, cast(y#x as int) AS y#x]
         +- Project [x#x, y#x]
            +- SubqueryAlias null_value_data
               +- LocalRelation [x#x, y#x]


-- !query
SELECT min_by(x, y, 2) FROM null_value_data
-- !query analysis
Aggregate [min_by(x#x, y#x, 2, true, 0, 0) AS min_by(x, y, 2)#x]
+- SubqueryAlias null_value_data
   +- View (`null_value_data`, [x#x, y#x])
      +- Project [cast(x#x as string) AS x#x, cast(y#x as int) AS y#x]
         +- Project [x#x, y#x]
            +- SubqueryAlias null_value_data
               +- LocalRelation [x#x, y#x]


-- !query
CREATE OR REPLACE TEMPORARY VIEW typed_data AS SELECT * FROM VALUES
  ('a', 1.5),
  ('b', 2.5),
  ('c', 0.5)
AS typed_data(name, score)
-- !query analysis
CreateViewCommand `typed_data`, SELECT * FROM VALUES
  ('a', 1.5),
  ('b', 2.5),
  ('c', 0.5)
AS typed_data(name, score), false, true, LocalTempView, UNSUPPORTED, true
   +- Project [name#x, score#x]
      +- SubqueryAlias typed_data
         +- LocalRelation [name#x, score#x]


-- !query
SELECT max_by(name, score, 2) FROM typed_data
-- !query analysis
Aggregate [max_by(name#x, score#x, 2, false, 0, 0) AS max_by(name, score, 2)#x]
+- SubqueryAlias typed_data
   +- View (`typed_data`, [name#x, score#x])
      +- Project [cast(name#x as string) AS name#x, cast(score#x as decimal(2,1)) AS score#x]
         +- Project [name#x, score#x]
            +- SubqueryAlias typed_data
               +- LocalRelation [name#x, score#x]


-- !query
SELECT min_by(name, score, 2) FROM typed_data
-- !query analysis
Aggregate [min_by(name#x, score#x, 2, true, 0, 0) AS min_by(name, score, 2)#x]
+- SubqueryAlias typed_data
   +- View (`typed_data`, [name#x, score#x])
      +- Project [cast(name#x as string) AS name#x, cast(score#x as decimal(2,1)) AS score#x]
         +- Project [name#x, score#x]
            +- SubqueryAlias typed_data
               +- LocalRelation [name#x, score#x]


-- !query
CREATE OR REPLACE TEMPORARY VIEW date_data AS SELECT * FROM VALUES
  ('event1', DATE '2024-01-15'),
  ('event2', DATE '2024-03-20'),
  ('event3', DATE '2024-02-10')
AS date_data(event, event_date)
-- !query analysis
CreateViewCommand `date_data`, SELECT * FROM VALUES
  ('event1', DATE '2024-01-15'),
  ('event2', DATE '2024-03-20'),
  ('event3', DATE '2024-02-10')
AS date_data(event, event_date), false, true, LocalTempView, UNSUPPORTED, true
   +- Project [event#x, event_date#x]
      +- SubqueryAlias date_data
         +- LocalRelation [event#x, event_date#x]


-- !query
SELECT max_by(event, event_date, 2) FROM date_data
-- !query analysis
Aggregate [max_by(event#x, event_date#x, 2, false, 0, 0) AS max_by(event, event_date, 2)#x]
+- SubqueryAlias date_data
   +- View (`date_data`, [event#x, event_date#x])
      +- Project [cast(event#x as string) AS event#x, cast(event_date#x as date) AS event_date#x]
         +- Project [event#x, event_date#x]
            +- SubqueryAlias date_data
               +- LocalRelation [event#x, event_date#x]


-- !query
SELECT min_by(event, event_date, 2) FROM date_data
-- !query analysis
Aggregate [min_by(event#x, event_date#x, 2, true, 0, 0) AS min_by(event, event_date, 2)#x]
+- SubqueryAlias date_data
   +- View (`date_data`, [event#x, event_date#x])
      +- Project [cast(event#x as string) AS event#x, cast(event_date#x as date) AS event_date#x]
         +- Project [event#x, event_date#x]
            +- SubqueryAlias date_data
               +- LocalRelation [event#x, event_date#x]


-- !query
SELECT dept, emp, salary,
       max_by(emp, salary, 2) OVER (PARTITION BY dept) as top2,
       min_by(emp, salary, 2) OVER (PARTITION BY dept) as bottom2
FROM dept_data
ORDER BY dept, emp
-- !query analysis
Sort [dept#x ASC NULLS FIRST, emp#x ASC NULLS FIRST], true
+- Project [dept#x, emp#x, salary#x, top2#x, bottom2#x]
   +- Project [dept#x, emp#x, salary#x, top2#x, bottom2#x, top2#x, bottom2#x]
      +- Window [max_by(emp#x, salary#x, 2, false, 0, 0) windowspecdefinition(dept#x, specifiedwindowframe(RowFrame, unboundedpreceding$(), unboundedfollowing$())) AS top2#x, min_by(emp#x, salary#x, 2, true, 0, 0) windowspecdefinition(dept#x, specifiedwindowframe(RowFrame, unboundedpreceding$(), unboundedfollowing$())) AS bottom2#x], [dept#x]
         +- Project [dept#x, emp#x, salary#x]
            +- SubqueryAlias dept_data
               +- View (`dept_data`, [dept#x, emp#x, salary#x])
                  +- Project [cast(dept#x as string) AS dept#x, cast(emp#x as string) AS emp#x, cast(salary#x as int) AS salary#x]
                     +- Project [dept#x, emp#x, salary#x]
                        +- SubqueryAlias dept_data
                           +- LocalRelation [dept#x, emp#x, salary#x]


-- !query
SELECT max_by(name, score, 0) FROM basic_data
-- !query analysis
org.apache.spark.sql.catalyst.ExtendedAnalysisException
{
  "errorClass" : "DATATYPE_MISMATCH.VALUE_OUT_OF_RANGE",
  "sqlState" : "42K09",
  "messageParameters" : {
    "currentValue" : "0",
    "exprName" : "`k`",
    "sqlExpr" : "\"max_by(name, score, 0)\"",
    "valueRange" : "[1, 100000]"
  },
  "queryContext" : [ {
    "objectType" : "",
    "objectName" : "",
    "startIndex" : 8,
    "stopIndex" : 29,
    "fragment" : "max_by(name, score, 0)"
  } ]
}


-- !query
SELECT max_by(name, score, -1) FROM basic_data
-- !query analysis
org.apache.spark.sql.catalyst.ExtendedAnalysisException
{
  "errorClass" : "DATATYPE_MISMATCH.VALUE_OUT_OF_RANGE",
  "sqlState" : "42K09",
  "messageParameters" : {
    "currentValue" : "-1",
    "exprName" : "`k`",
    "sqlExpr" : "\"max_by(name, score, -1)\"",
    "valueRange" : "[1, 100000]"
  },
  "queryContext" : [ {
    "objectType" : "",
    "objectName" : "",
    "startIndex" : 8,
    "stopIndex" : 30,
    "fragment" : "max_by(name, score, -1)"
  } ]
}


-- !query
SELECT max_by(name, score, 100001) FROM basic_data
-- !query analysis
org.apache.spark.sql.catalyst.ExtendedAnalysisException
{
  "errorClass" : "DATATYPE_MISMATCH.VALUE_OUT_OF_RANGE",
  "sqlState" : "42K09",
  "messageParameters" : {
    "currentValue" : "100001",
    "exprName" : "`k`",
    "sqlExpr" : "\"max_by(name, score, 100001)\"",
    "valueRange" : "[1, 100000]"
  },
  "queryContext" : [ {
    "objectType" : "",
    "objectName" : "",
    "startIndex" : 8,
    "stopIndex" : 34,
    "fragment" : "max_by(name, score, 100001)"
  } ]
}


-- !query
DROP VIEW basic_data
-- !query analysis
DropTempViewCommand basic_data


-- !query
DROP VIEW dept_data
-- !query analysis
DropTempViewCommand dept_data


-- !query
DROP VIEW null_data
-- !query analysis
DropTempViewCommand null_data


-- !query
DROP VIEW null_value_data
-- !query analysis
DropTempViewCommand null_value_data


-- !query
DROP VIEW typed_data
-- !query analysis
DropTempViewCommand typed_data


-- !query
DROP VIEW date_data
-- !query analysis
DropTempViewCommand date_data
