-- Automatically generated by SQLQueryTestSuite
-- !query
create temporary view t as select * from values 0, 1, 2 as t(id)
-- !query schema
struct<>
-- !query output



-- !query
create temporary view t2 as select * from values 0, 1 as t(id)
-- !query schema
struct<>
-- !query output



-- !query
create temporary view t3 as select * from t
-- !query schema
struct<>
-- !query output



-- !query
WITH s AS (SELECT 1 FROM s) SELECT * FROM s
-- !query schema
struct<>
-- !query output
org.apache.spark.sql.catalyst.ExtendedAnalysisException
{
  "errorClass" : "TABLE_OR_VIEW_NOT_FOUND",
  "sqlState" : "42P01",
  "messageParameters" : {
    "relationName" : "`s`"
  },
  "queryContext" : [ {
    "objectType" : "",
    "objectName" : "",
    "startIndex" : 26,
    "stopIndex" : 26,
    "fragment" : "s"
  } ]
}


-- !query
WITH r AS (SELECT (SELECT * FROM r))
SELECT * FROM r
-- !query schema
struct<>
-- !query output
org.apache.spark.sql.catalyst.ExtendedAnalysisException
{
  "errorClass" : "TABLE_OR_VIEW_NOT_FOUND",
  "sqlState" : "42P01",
  "messageParameters" : {
    "relationName" : "`r`"
  },
  "queryContext" : [ {
    "objectType" : "",
    "objectName" : "",
    "startIndex" : 34,
    "stopIndex" : 34,
    "fragment" : "r"
  } ]
}


-- !query
WITH t AS (SELECT 1 FROM t) SELECT * FROM t
-- !query schema
struct<1:int>
-- !query output
1
1
1


-- !query
WITH t AS (SELECT 1) SELECT * FROM t3
-- !query schema
struct<id:int>
-- !query output
0
1
2


-- !query
WITH s1 AS (SELECT 1 FROM s2), s2 AS (SELECT 1 FROM s1) SELECT * FROM s1, s2
-- !query schema
struct<>
-- !query output
org.apache.spark.sql.catalyst.ExtendedAnalysisException
{
  "errorClass" : "TABLE_OR_VIEW_NOT_FOUND",
  "sqlState" : "42P01",
  "messageParameters" : {
    "relationName" : "`s2`"
  },
  "queryContext" : [ {
    "objectType" : "",
    "objectName" : "",
    "startIndex" : 27,
    "stopIndex" : 28,
    "fragment" : "s2"
  } ]
}


-- !query
WITH t1 AS (SELECT * FROM t2), t2 AS (SELECT 2 FROM t1) SELECT * FROM t1 cross join t2
-- !query schema
struct<id:int,2:int>
-- !query output
0	2
0	2
1	2
1	2


-- !query
WITH CTE1 AS (
  SELECT b.id AS id
  FROM   T2 a
         CROSS JOIN (SELECT id AS id FROM T2) b
)
SELECT t1.id AS c1,
       t2.id AS c2
FROM   CTE1 t1
       CROSS JOIN CTE1 t2
-- !query schema
struct<c1:int,c2:int>
-- !query output
0	0
0	0
0	0
0	0
0	1
0	1
0	1
0	1
1	0
1	0
1	0
1	0
1	1
1	1
1	1
1	1


-- !query
WITH t(x) AS (SELECT 1)
SELECT * FROM t WHERE x = 1
-- !query schema
struct<x:int>
-- !query output
1


-- !query
WITH t(x, y) AS (SELECT 1, 2)
SELECT * FROM t WHERE x = 1 AND y = 2
-- !query schema
struct<x:int,y:int>
-- !query output
1	2


-- !query
WITH t(x, x) AS (SELECT 1, 2)
SELECT * FROM t
-- !query schema
struct<x:int,x:int>
-- !query output
1	2


-- !query
WITH t() AS (SELECT 1)
SELECT * FROM t
-- !query schema
struct<>
-- !query output
org.apache.spark.sql.catalyst.parser.ParseException
{
  "errorClass" : "PARSE_SYNTAX_ERROR",
  "sqlState" : "42601",
  "messageParameters" : {
    "error" : "')'",
    "hint" : ""
  }
}


-- !query
WITH
  t(x) AS (SELECT 1),
  t(x) AS (SELECT 2)
SELECT * FROM t
-- !query schema
struct<>
-- !query output
org.apache.spark.sql.catalyst.parser.ParseException
{
  "errorClass" : "DUPLICATED_CTE_NAMES",
  "sqlState" : "42602",
  "messageParameters" : {
    "duplicateNames" : "`t`"
  },
  "queryContext" : [ {
    "objectType" : "",
    "objectName" : "",
    "startIndex" : 1,
    "stopIndex" : 63,
    "fragment" : "WITH\n  t(x) AS (SELECT 1),\n  t(x) AS (SELECT 2)\nSELECT * FROM t"
  } ]
}


-- !query
WITH t AS (SELECT 1 FROM non_existing_table)
SELECT 2
-- !query schema
struct<>
-- !query output
org.apache.spark.sql.catalyst.ExtendedAnalysisException
{
  "errorClass" : "TABLE_OR_VIEW_NOT_FOUND",
  "sqlState" : "42P01",
  "messageParameters" : {
    "relationName" : "`non_existing_table`"
  },
  "queryContext" : [ {
    "objectType" : "",
    "objectName" : "",
    "startIndex" : 26,
    "stopIndex" : 43,
    "fragment" : "non_existing_table"
  } ]
}


-- !query
SELECT count(*) FROM (
  WITH q1(x) AS (SELECT random() FROM range(1, 5))
    SELECT * FROM q1
  UNION
    SELECT * FROM q1
) ss
-- !query schema
struct<count(1):bigint>
-- !query output
4


-- !query
WITH w1(c1) AS
 (WITH w2(c2) AS
  (WITH w3(c3) AS
   (WITH w4(c4) AS
    (WITH w5(c5) AS
     (WITH w6(c6) AS
      (WITH w7(c7) AS
       (WITH w8(c8) AS
        (SELECT 1)
        SELECT * FROM w8)
       SELECT * FROM w7)
      SELECT * FROM w6)
     SELECT * FROM w5)
    SELECT * FROM w4)
   SELECT * FROM w3)
  SELECT * FROM w2)
SELECT * FROM w1
-- !query schema
struct<c1:int>
-- !query output
1


-- !query
SELECT ( WITH cte(foo) AS ( VALUES(id) )
         SELECT (SELECT foo FROM cte) )
FROM t
-- !query schema
struct<>
-- !query output
org.apache.spark.sql.AnalysisException
{
  "errorClass" : "INVALID_INLINE_TABLE.CANNOT_EVALUATE_EXPRESSION_IN_INLINE_TABLE",
  "sqlState" : "42000",
  "messageParameters" : {
    "expr" : "\"outer(t.id)\""
  },
  "queryContext" : [ {
    "objectType" : "",
    "objectName" : "",
    "startIndex" : 36,
    "stopIndex" : 37,
    "fragment" : "id"
  } ]
}


-- !query
WITH same_name AS (SELECT 42)
SELECT * FROM same_name, (SELECT 10) AS same_name
-- !query schema
struct<42:int,10:int>
-- !query output
42	10


-- !query
WITH same_name(x) AS (SELECT 42)
SELECT same_name.x FROM (SELECT 10) AS same_name(x), same_name
-- !query schema
struct<>
-- !query output
org.apache.spark.sql.AnalysisException
{
  "errorClass" : "AMBIGUOUS_REFERENCE",
  "sqlState" : "42704",
  "messageParameters" : {
    "name" : "`same_name`.`x`",
    "referenceNames" : "[`same_name`.`x`, `same_name`.`x`]"
  },
  "queryContext" : [ {
    "objectType" : "",
    "objectName" : "",
    "startIndex" : 41,
    "stopIndex" : 51,
    "fragment" : "same_name.x"
  } ]
}


-- !query
WITH q AS (SELECT 'foo' AS x)
SELECT x, typeof(x) FROM q
-- !query schema
struct<x:string,typeof(x):string>
-- !query output
foo	string


-- !query
with cte as (select id as id_alias from t)
select id from cte
-- !query schema
struct<>
-- !query output
org.apache.spark.sql.catalyst.ExtendedAnalysisException
{
  "errorClass" : "UNRESOLVED_COLUMN.WITH_SUGGESTION",
  "sqlState" : "42703",
  "messageParameters" : {
    "objectName" : "`id`",
    "proposal" : "`id_alias`"
  },
  "queryContext" : [ {
    "objectType" : "",
    "objectName" : "",
    "startIndex" : 51,
    "stopIndex" : 52,
    "fragment" : "id"
  } ]
}


-- !query
with r1 as (select * from r2),
     r2 as (select 1)
select 2
-- !query schema
struct<>
-- !query output
org.apache.spark.sql.catalyst.ExtendedAnalysisException
{
  "errorClass" : "TABLE_OR_VIEW_NOT_FOUND",
  "sqlState" : "42P01",
  "messageParameters" : {
    "relationName" : "`r2`"
  },
  "queryContext" : [ {
    "objectType" : "",
    "objectName" : "",
    "startIndex" : 27,
    "stopIndex" : 28,
    "fragment" : "r2"
  } ]
}


-- !query
SELECT * FROM
  (WITH q AS (select 1 x) SELECT x+1 AS y FROM q)
-- !query schema
struct<y:int>
-- !query output
2


-- !query
select (with q as (select 1 x) select * from q)
-- !query schema
struct<scalarsubquery():int>
-- !query output
1


-- !query
select 1 in (with q as (select 1) select * from q)
-- !query schema
struct<(1 IN (listquery())):boolean>
-- !query output
true


-- !query
SELECT * FROM
  (WITH q AS (select 1 x) SELECT x+1 AS y FROM q),
  q
-- !query schema
struct<>
-- !query output
org.apache.spark.sql.catalyst.ExtendedAnalysisException
{
  "errorClass" : "TABLE_OR_VIEW_NOT_FOUND",
  "sqlState" : "42P01",
  "messageParameters" : {
    "relationName" : "`q`"
  },
  "queryContext" : [ {
    "objectType" : "",
    "objectName" : "",
    "startIndex" : 68,
    "stopIndex" : 68,
    "fragment" : "q"
  } ]
}


-- !query
WITH T1 as (select 1 a)
select *
from
  T1 x,
  (WITH T1 as (select 2 b) select * from T1) y,
  T1 z
-- !query schema
struct<a:int,b:int,a:int>
-- !query output
1	2	1


-- !query
WITH TTtt as (select 1 a),
     `tTTt_2` as (select 2 a)
select *
from
  (WITH TtTt as (select 3 c) select * from ttTT, `tttT_2`)
-- !query schema
struct<c:int,a:int>
-- !query output
3	2


-- !query
select
  (WITH q AS (select T.x) select * from q)
from (select 1 x, 2 y) T
-- !query schema
struct<scalarsubquery(x):int>
-- !query output
1


-- !query
select
  (WITH q AS (select 3 z) select x + t.y + z from q)
from (select 1 x, 2 y) T
-- !query schema
struct<scalarsubquery(x, y):int>
-- !query output
6


-- !query
WITH q1 as (select 1 x)
select * from
  (with q2 as (select * from q1) select * from q2)
-- !query schema
struct<x:int>
-- !query output
1


-- !query
WITH q1 as (select 1 x)
select * from
  (with q1 as (select x+1 from q1) select * from q1)
-- !query schema
struct<(x + 1):int>
-- !query output
2


-- !query
with cte1 as (select 42), cte1 as (select 42) select * FROM cte1
-- !query schema
struct<>
-- !query output
org.apache.spark.sql.catalyst.parser.ParseException
{
  "errorClass" : "DUPLICATED_CTE_NAMES",
  "sqlState" : "42602",
  "messageParameters" : {
    "duplicateNames" : "`cte1`"
  },
  "queryContext" : [ {
    "objectType" : "",
    "objectName" : "",
    "startIndex" : 1,
    "stopIndex" : 64,
    "fragment" : "with cte1 as (select 42), cte1 as (select 42) select * FROM cte1"
  } ]
}


-- !query
with cte1 as (Select id as j from t)
select * from cte1 where j = (select max(j) from cte1 as cte2)
-- !query schema
struct<j:int>
-- !query output
2


-- !query
with cte AS (SELECT * FROM va) SELECT * FROM cte
-- !query schema
struct<>
-- !query output
org.apache.spark.sql.catalyst.ExtendedAnalysisException
{
  "errorClass" : "TABLE_OR_VIEW_NOT_FOUND",
  "sqlState" : "42P01",
  "messageParameters" : {
    "relationName" : "`va`"
  },
  "queryContext" : [ {
    "objectType" : "",
    "objectName" : "",
    "startIndex" : 28,
    "stopIndex" : 29,
    "fragment" : "va"
  } ]
}


-- !query
with cte as (select * from cte) select * from cte
-- !query schema
struct<>
-- !query output
org.apache.spark.sql.catalyst.ExtendedAnalysisException
{
  "errorClass" : "TABLE_OR_VIEW_NOT_FOUND",
  "sqlState" : "42P01",
  "messageParameters" : {
    "relationName" : "`cte`"
  },
  "queryContext" : [ {
    "objectType" : "",
    "objectName" : "",
    "startIndex" : 28,
    "stopIndex" : 30,
    "fragment" : "cte"
  } ]
}


-- !query
DROP VIEW IF EXISTS t
-- !query schema
struct<>
-- !query output



-- !query
DROP VIEW IF EXISTS t2
-- !query schema
struct<>
-- !query output



-- !query
DROP VIEW IF EXISTS t3
-- !query schema
struct<>
-- !query output

