-- Automatically generated by SQLQueryTestSuite
-- !query
CREATE TEMP VIEW df AS
SELECT * FROM (VALUES ('a', 'b'), ('a', 'c'), ('b', 'c'), ('b', 'd'), (NULL, NULL))
-- !query schema
struct<>
-- !query output



-- !query
CREATE TEMP VIEW df2 AS
SELECT * FROM (VALUES (1, true), (2, false), (3, false))
-- !query schema
struct<>
-- !query output



-- !query
WITH t(col) AS (SELECT listagg(col2) FROM df GROUP BY col1) SELECT len(col), regexp_count(col, 'a'), regexp_count(col, 'b'), regexp_count(col, 'c'), regexp_count(col, 'd') FROM t
-- !query schema
struct<len(col):int,regexp_count(col, a):int,regexp_count(col, b):int,regexp_count(col, c):int,regexp_count(col, d):int>
-- !query output
2	0	0	1	1
2	0	1	1	0
NULL	NULL	NULL	NULL	NULL


-- !query
WITH t(col) AS (SELECT string_agg(col2) FROM df GROUP BY col1) SELECT len(col), regexp_count(col, 'a'), regexp_count(col, 'b'), regexp_count(col, 'c'), regexp_count(col, 'd') FROM t
-- !query schema
struct<len(col):int,regexp_count(col, a):int,regexp_count(col, b):int,regexp_count(col, c):int,regexp_count(col, d):int>
-- !query output
2	0	0	1	1
2	0	1	1	0
NULL	NULL	NULL	NULL	NULL


-- !query
WITH t(col) AS (SELECT listagg(col2, NULL) FROM df GROUP BY col1) SELECT len(col), regexp_count(col, 'a'), regexp_count(col, 'b'), regexp_count(col, 'c'), regexp_count(col, 'd') FROM t
-- !query schema
struct<len(col):int,regexp_count(col, a):int,regexp_count(col, b):int,regexp_count(col, c):int,regexp_count(col, d):int>
-- !query output
2	0	0	1	1
2	0	1	1	0
NULL	NULL	NULL	NULL	NULL


-- !query
SELECT listagg(col2) FROM df WHERE 1 != 1
-- !query schema
struct<listagg(col2, NULL):string>
-- !query output
NULL


-- !query
WITH t(col) AS (SELECT listagg(col2, '|') FROM df GROUP BY col1) SELECT len(col), regexp_count(col, 'a'), regexp_count(col, 'b'), regexp_count(col, 'c'), regexp_count(col, 'd') FROM t
-- !query schema
struct<len(col):int,regexp_count(col, a):int,regexp_count(col, b):int,regexp_count(col, c):int,regexp_count(col, d):int>
-- !query output
3	0	0	1	1
3	0	1	1	0
NULL	NULL	NULL	NULL	NULL


-- !query
WITH t(col) AS (SELECT listagg(col1) FROM df) SELECT len(col), regexp_count(col, 'a'), regexp_count(col, 'b') FROM t
-- !query schema
struct<len(col):int,regexp_count(col, a):int,regexp_count(col, b):int>
-- !query output
4	2	2


-- !query
WITH t(col) AS (SELECT listagg(DISTINCT col1) FROM df) SELECT len(col), regexp_count(col, 'a'), regexp_count(col, 'b') FROM t
-- !query schema
struct<len(col):int,regexp_count(col, a):int,regexp_count(col, b):int>
-- !query output
2	1	1


-- !query
SELECT listagg(col1) WITHIN GROUP (ORDER BY col1) FROM df
-- !query schema
struct<listagg(col1, NULL) WITHIN GROUP (ORDER BY col1 ASC NULLS FIRST):string>
-- !query output
aabb


-- !query
SELECT listagg(col1) WITHIN GROUP (ORDER BY col1 DESC) FROM df
-- !query schema
struct<listagg(col1, NULL) WITHIN GROUP (ORDER BY col1 DESC NULLS LAST):string>
-- !query output
bbaa


-- !query
SELECT listagg(col1) WITHIN GROUP (ORDER BY col1 DESC) OVER (PARTITION BY col2) FROM df
-- !query schema
struct<listagg(col1, NULL) WITHIN GROUP (ORDER BY col1 DESC NULLS LAST) OVER (PARTITION BY col2 ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING):string>
-- !query output
NULL
a
b
ba
ba


-- !query
SELECT listagg(col1) WITHIN GROUP (ORDER BY col2) FROM df
-- !query schema
struct<listagg(col1, NULL) WITHIN GROUP (ORDER BY col2 ASC NULLS FIRST):string>
-- !query output
aabb


-- !query
WITH t(col) AS (SELECT listagg(col1) WITHIN GROUP (ORDER BY col2 DESC) FROM df) SELECT (col == 'baba') || (col == 'bbaa') FROM t
-- !query schema
struct<concat((col = baba), (col = bbaa)):string>
-- !query output
truefalse


-- !query
WITH t(col) AS (SELECT listagg(col1, '|') WITHIN GROUP (ORDER BY col2 DESC) FROM df) SELECT (col == 'b|a|b|a') || (col == 'b|b|a|a') FROM t
-- !query schema
struct<concat((col = b|a|b|a), (col = b|b|a|a)):string>
-- !query output
truefalse


-- !query
SELECT listagg(col1, '|') WITHIN GROUP (ORDER BY col2 DESC) FROM df
-- !query schema
struct<listagg(col1, |) WITHIN GROUP (ORDER BY col2 DESC NULLS LAST):string>
-- !query output
b|a|b|a


-- !query
SELECT listagg(col1) WITHIN GROUP (ORDER BY col2 DESC, col1 ASC) FROM df
-- !query schema
struct<listagg(col1, NULL) WITHIN GROUP (ORDER BY col2 DESC NULLS LAST, col1 ASC NULLS FIRST):string>
-- !query output
baba


-- !query
SELECT listagg(col1) WITHIN GROUP (ORDER BY col2 DESC, col1 DESC) FROM df
-- !query schema
struct<listagg(col1, NULL) WITHIN GROUP (ORDER BY col2 DESC NULLS LAST, col1 DESC NULLS LAST):string>
-- !query output
bbaa


-- !query
WITH t(col) AS (SELECT listagg(col1) FROM (VALUES (X'DEAD'), (X'BEEF'))) SELECT len(col), regexp_count(hex(col), hex(X'DEAD')), regexp_count(hex(col), hex(X'BEEF')) FROM t
-- !query schema
struct<len(col):int,regexp_count(hex(col), hex(X'DEAD')):int,regexp_count(hex(col), hex(X'BEEF')):int>
-- !query output
4	1	1


-- !query
WITH t(col) AS (SELECT listagg(col1, NULL) FROM (VALUES (X'DEAD'), (X'BEEF'))) SELECT len(col), regexp_count(hex(col), hex(X'DEAD')), regexp_count(hex(col), hex(X'BEEF')) FROM t
-- !query schema
struct<len(col):int,regexp_count(hex(col), hex(X'DEAD')):int,regexp_count(hex(col), hex(X'BEEF')):int>
-- !query output
4	1	1


-- !query
WITH t(col) AS (SELECT listagg(col1, X'42') FROM (VALUES (X'DEAD'), (X'BEEF'))) SELECT len(col), regexp_count(hex(col), hex(X'42')), regexp_count(hex(col), hex(X'DEAD')), regexp_count(hex(col), hex(X'BEEF')) FROM t
-- !query schema
struct<len(col):int,regexp_count(hex(col), hex(X'42')):int,regexp_count(hex(col), hex(X'DEAD')):int,regexp_count(hex(col), hex(X'BEEF')):int>
-- !query output
5	1	1	1


-- !query
WITH t(col1, col2) AS (SELECT listagg(col1), listagg(col2, ',') FROM df2) SELECT len(col1), regexp_count(col1, '1'), regexp_count(col1, '2'), regexp_count(col1, '3'), len(col2), regexp_count(col2, 'true'), regexp_count(col1, 'false') FROM t
-- !query schema
struct<len(col1):int,regexp_count(col1, 1):int,regexp_count(col1, 2):int,regexp_count(col1, 3):int,len(col2):int,regexp_count(col2, true):int,regexp_count(col1, false):int>
-- !query output
3	1	1	1	16	1	0


-- !query
SELECT listagg(DISTINCT col, ',') WITHIN GROUP (ORDER BY col) FROM VALUES (1), (2), (2), (3) AS t(col)
-- !query schema
struct<listagg(DISTINCT col, ,) WITHIN GROUP (ORDER BY col ASC NULLS FIRST):string>
-- !query output
1,2,3


-- !query
SELECT listagg(DISTINCT col, ',') WITHIN GROUP (ORDER BY col) FROM VALUES (cast(1 as bigint)), (cast(2 as bigint)), (cast(2 as bigint)), (cast(3 as bigint)) AS t(col)
-- !query schema
struct<listagg(DISTINCT col, ,) WITHIN GROUP (ORDER BY col ASC NULLS FIRST):string>
-- !query output
1,2,3


-- !query
SELECT listagg(DISTINCT col, ',') WITHIN GROUP (ORDER BY col) FROM VALUES (cast(1 as smallint)), (cast(2 as smallint)), (cast(2 as smallint)), (cast(3 as smallint)) AS t(col)
-- !query schema
struct<listagg(DISTINCT col, ,) WITHIN GROUP (ORDER BY col ASC NULLS FIRST):string>
-- !query output
1,2,3


-- !query
SELECT listagg(DISTINCT col, ',') WITHIN GROUP (ORDER BY col) FROM VALUES (cast(1 as tinyint)), (cast(2 as tinyint)), (cast(2 as tinyint)), (cast(3 as tinyint)) AS t(col)
-- !query schema
struct<listagg(DISTINCT col, ,) WITHIN GROUP (ORDER BY col ASC NULLS FIRST):string>
-- !query output
1,2,3


-- !query
SELECT listagg(DISTINCT col, ',') WITHIN GROUP (ORDER BY col) FROM VALUES (cast(1.10 as decimal(10,2))), (cast(2.20 as decimal(10,2))), (cast(2.20 as decimal(10,2))) AS t(col)
-- !query schema
struct<listagg(DISTINCT col, ,) WITHIN GROUP (ORDER BY col ASC NULLS FIRST):string>
-- !query output
1.10,2.20


-- !query
SELECT listagg(DISTINCT col, ',') WITHIN GROUP (ORDER BY col) FROM VALUES (DATE'2024-01-01'), (DATE'2024-01-02'), (DATE'2024-01-01') AS t(col)
-- !query schema
struct<listagg(DISTINCT col, ,) WITHIN GROUP (ORDER BY col ASC NULLS FIRST):string>
-- !query output
2024-01-01,2024-01-02


-- !query
SELECT listagg(DISTINCT col, ',') WITHIN GROUP (ORDER BY col) FROM VALUES (TIMESTAMP_NTZ'2024-01-01 10:00:00'), (TIMESTAMP_NTZ'2024-01-02 12:00:00'), (TIMESTAMP_NTZ'2024-01-01 10:00:00') AS t(col)
-- !query schema
struct<listagg(DISTINCT col, ,) WITHIN GROUP (ORDER BY col ASC NULLS FIRST):string>
-- !query output
2024-01-01 10:00:00,2024-01-02 12:00:00


-- !query
SELECT listagg(DISTINCT col, ',') WITHIN GROUP (ORDER BY col) FROM VALUES (true), (false), (true) AS t(col)
-- !query schema
struct<listagg(DISTINCT col, ,) WITHIN GROUP (ORDER BY col ASC NULLS FIRST):string>
-- !query output
false,true


-- !query
SELECT listagg(DISTINCT col, ',') WITHIN GROUP (ORDER BY col) FROM VALUES (INTERVAL '1' MONTH), (INTERVAL '2' MONTH), (INTERVAL '1' MONTH) AS t(col)
-- !query schema
struct<listagg(DISTINCT col, ,) WITHIN GROUP (ORDER BY col ASC NULLS FIRST):string>
-- !query output
INTERVAL '1' MONTH,INTERVAL '2' MONTH


-- !query
SELECT listagg(DISTINCT cast(col as string), ',') WITHIN GROUP (ORDER BY col) FROM VALUES (10), (1), (2), (20), (2) AS t(col)
-- !query schema
struct<listagg(DISTINCT CAST(col AS STRING), ,) WITHIN GROUP (ORDER BY col ASC NULLS FIRST):string>
-- !query output
1,2,10,20


-- !query
SELECT listagg(DISTINCT col, ',') WITHIN GROUP (ORDER BY col DESC) FROM VALUES (1), (10), (2), (20), (2) AS t(col)
-- !query schema
struct<listagg(DISTINCT col, ,) WITHIN GROUP (ORDER BY col DESC NULLS LAST):string>
-- !query output
20,10,2,1


-- !query
SELECT listagg(DISTINCT col, ',') WITHIN GROUP (ORDER BY col) FROM VALUES (1), (2), (null), (2), (3) AS t(col)
-- !query schema
struct<listagg(DISTINCT col, ,) WITHIN GROUP (ORDER BY col ASC NULLS FIRST):string>
-- !query output
1,2,3


-- !query
SELECT listagg(DISTINCT col, ',') WITHIN GROUP (ORDER BY col NULLS FIRST) FROM VALUES (1), (null), (2), (null) AS t(col)
-- !query schema
struct<listagg(DISTINCT col, ,) WITHIN GROUP (ORDER BY col ASC NULLS FIRST):string>
-- !query output
1,2


-- !query
SELECT grp, listagg(DISTINCT col) WITHIN GROUP (ORDER BY col) FROM VALUES (1, 'a'), (1, 'b'), (2, 'a'), (2, 'a'), (1, 'b') AS t(grp, col) GROUP BY grp
-- !query schema
struct<grp:int,listagg(DISTINCT col, NULL) WITHIN GROUP (ORDER BY col ASC NULLS FIRST):string>
-- !query output
1	ab
2	a


-- !query
WITH t(col) AS (SELECT listagg(DISTINCT col1, X'2C') WITHIN GROUP (ORDER BY col1) FROM (VALUES (X'DEAD'), (X'BEEF'), (X'DEAD'), (X'CAFE'))) SELECT len(col), regexp_count(hex(col), hex(X'DEAD')), regexp_count(hex(col), hex(X'BEEF')), regexp_count(hex(col), hex(X'CAFE')) FROM t
-- !query schema
struct<len(col):int,regexp_count(hex(col), hex(X'DEAD')):int,regexp_count(hex(col), hex(X'BEEF')):int,regexp_count(hex(col), hex(X'CAFE')):int>
-- !query output
8	1	1	1


-- !query
WITH t(col) AS (SELECT listagg(DISTINCT col1, X'7C') WITHIN GROUP (ORDER BY col1) FROM (VALUES (X'BB'), (X'AA'), (NULL), (X'BB'))) SELECT len(col), regexp_count(hex(col), hex(X'AA')), regexp_count(hex(col), hex(X'BB')) FROM t
-- !query schema
struct<len(col):int,regexp_count(hex(col), hex(X'AA')):int,regexp_count(hex(col), hex(X'BB')):int>
-- !query output
3	1	1


-- !query
SELECT grp, hex(listagg(DISTINCT col, X'2C') WITHIN GROUP (ORDER BY col)) FROM VALUES (1, X'AA'), (1, X'BB'), (1, X'AA'), (2, X'CC'), (2, X'CC') AS t(grp, col) GROUP BY grp
-- !query schema
struct<grp:int,hex(listagg(DISTINCT col, X'2C') WITHIN GROUP (ORDER BY col ASC NULLS FIRST)):string>
-- !query output
1	AA2CBB
2	CC


-- !query
SELECT listagg(c1) FROM (VALUES (ARRAY('a', 'b'))) AS t(c1)
-- !query schema
struct<>
-- !query output
org.apache.spark.sql.catalyst.ExtendedAnalysisException
{
  "errorClass" : "DATATYPE_MISMATCH.UNEXPECTED_INPUT_TYPE",
  "sqlState" : "42K09",
  "messageParameters" : {
    "inputSql" : "\"c1\"",
    "inputType" : "\"ARRAY<STRING>\"",
    "paramIndex" : "first",
    "requiredType" : "(\"STRING\" or \"BINARY\")",
    "sqlExpr" : "\"listagg(c1, NULL)\""
  },
  "queryContext" : [ {
    "objectType" : "",
    "objectName" : "",
    "startIndex" : 8,
    "stopIndex" : 18,
    "fragment" : "listagg(c1)"
  } ]
}


-- !query
SELECT listagg(c1, ', ') FROM (VALUES (X'DEAD'), (X'BEEF')) AS t(c1)
-- !query schema
struct<>
-- !query output
org.apache.spark.sql.catalyst.ExtendedAnalysisException
{
  "errorClass" : "DATATYPE_MISMATCH.DATA_DIFF_TYPES",
  "sqlState" : "42K09",
  "messageParameters" : {
    "dataType" : "(\"BINARY\" or \"STRING\")",
    "functionName" : "`listagg`",
    "sqlExpr" : "\"listagg(c1, , )\""
  },
  "queryContext" : [ {
    "objectType" : "",
    "objectName" : "",
    "startIndex" : 8,
    "stopIndex" : 24,
    "fragment" : "listagg(c1, ', ')"
  } ]
}


-- !query
SELECT listagg(col2, col1) FROM df GROUP BY col1
-- !query schema
struct<>
-- !query output
org.apache.spark.sql.catalyst.ExtendedAnalysisException
{
  "errorClass" : "DATATYPE_MISMATCH.NON_FOLDABLE_INPUT",
  "sqlState" : "42K09",
  "messageParameters" : {
    "inputExpr" : "\"col1\"",
    "inputName" : "`delimiter`",
    "inputType" : "\"STRING\"",
    "sqlExpr" : "\"listagg(col2, col1)\""
  },
  "queryContext" : [ {
    "objectType" : "",
    "objectName" : "",
    "startIndex" : 8,
    "stopIndex" : 26,
    "fragment" : "listagg(col2, col1)"
  } ]
}


-- !query
SELECT listagg(col1) OVER (ORDER BY col1) FROM df
-- !query schema
struct<listagg(col1, NULL) OVER (ORDER BY col1 ASC NULLS FIRST RANGE BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW):string>
-- !query output
NULL
aa
aa
aabb
aabb


-- !query
SELECT listagg(col1) WITHIN GROUP (ORDER BY col1) OVER (ORDER BY col1) FROM df
-- !query schema
struct<>
-- !query output
org.apache.spark.sql.catalyst.ExtendedAnalysisException
{
  "errorClass" : "INVALID_WINDOW_SPEC_FOR_AGGREGATION_FUNC",
  "sqlState" : "42601",
  "messageParameters" : {
    "aggFunc" : "\"listagg(col1, NULL, col1 ASC NULLS FIRST)\""
  },
  "queryContext" : [ {
    "objectType" : "",
    "objectName" : "",
    "startIndex" : 8,
    "stopIndex" : 70,
    "fragment" : "listagg(col1) WITHIN GROUP (ORDER BY col1) OVER (ORDER BY col1)"
  } ]
}


-- !query
SELECT string_agg(col1) WITHIN GROUP (ORDER BY col1) OVER (ORDER BY col1) FROM df
-- !query schema
struct<>
-- !query output
org.apache.spark.sql.catalyst.ExtendedAnalysisException
{
  "errorClass" : "INVALID_WINDOW_SPEC_FOR_AGGREGATION_FUNC",
  "sqlState" : "42601",
  "messageParameters" : {
    "aggFunc" : "\"listagg(col1, NULL, col1 ASC NULLS FIRST)\""
  },
  "queryContext" : [ {
    "objectType" : "",
    "objectName" : "",
    "startIndex" : 8,
    "stopIndex" : 73,
    "fragment" : "string_agg(col1) WITHIN GROUP (ORDER BY col1) OVER (ORDER BY col1)"
  } ]
}


-- !query
SELECT listagg(DISTINCT col1) OVER (ORDER BY col1) FROM df
-- !query schema
struct<>
-- !query output
org.apache.spark.sql.catalyst.ExtendedAnalysisException
{
  "errorClass" : "DISTINCT_WINDOW_FUNCTION_UNSUPPORTED",
  "sqlState" : "0A000",
  "messageParameters" : {
    "windowExpr" : "\"listagg(DISTINCT col1, NULL) OVER (ORDER BY col1 ASC NULLS FIRST RANGE BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW)\""
  },
  "queryContext" : [ {
    "objectType" : "",
    "objectName" : "",
    "startIndex" : 8,
    "stopIndex" : 50,
    "fragment" : "listagg(DISTINCT col1) OVER (ORDER BY col1)"
  } ]
}


-- !query
SELECT listagg(DISTINCT col1) WITHIN GROUP (ORDER BY col2) FROM df
-- !query schema
struct<>
-- !query output
org.apache.spark.sql.catalyst.ExtendedAnalysisException
{
  "errorClass" : "INVALID_WITHIN_GROUP_EXPRESSION.MISMATCH_WITH_DISTINCT_INPUT",
  "sqlState" : "42K0K",
  "messageParameters" : {
    "funcArg" : "\"col1\"",
    "funcName" : "`listagg`",
    "orderingExpr" : "\"col2\""
  }
}


-- !query
SELECT listagg(DISTINCT col1) WITHIN GROUP (ORDER BY col1, col2) FROM df
-- !query schema
struct<>
-- !query output
org.apache.spark.sql.catalyst.ExtendedAnalysisException
{
  "errorClass" : "INVALID_WITHIN_GROUP_EXPRESSION.MISMATCH_WITH_DISTINCT_INPUT",
  "sqlState" : "42K0K",
  "messageParameters" : {
    "funcArg" : "\"col1\"",
    "funcName" : "`listagg`",
    "orderingExpr" : "\"col1\", \"col2\""
  }
}


-- !query
SELECT listagg(DISTINCT col, ',') WITHIN GROUP (ORDER BY col) FROM VALUES (cast(1.1 as double)), (cast(2.2 as double)), (cast(2.2 as double)), (cast(3.3 as double)) AS t(col)
-- !query schema
struct<>
-- !query output
org.apache.spark.sql.catalyst.ExtendedAnalysisException
{
  "errorClass" : "INVALID_WITHIN_GROUP_EXPRESSION.MISMATCH_WITH_DISTINCT_INPUT_UNSAFE_CAST",
  "sqlState" : "42K0K",
  "messageParameters" : {
    "castType" : "\"STRING\"",
    "funcName" : "`listagg`",
    "inputType" : "\"DOUBLE\""
  }
}


-- !query
SELECT listagg(DISTINCT col, ',') WITHIN GROUP (ORDER BY col) FROM VALUES (cast(1.0 as float)), (cast(2.0 as float)), (cast(2.0 as float)) AS t(col)
-- !query schema
struct<>
-- !query output
org.apache.spark.sql.catalyst.ExtendedAnalysisException
{
  "errorClass" : "INVALID_WITHIN_GROUP_EXPRESSION.MISMATCH_WITH_DISTINCT_INPUT_UNSAFE_CAST",
  "sqlState" : "42K0K",
  "messageParameters" : {
    "castType" : "\"STRING\"",
    "funcName" : "`listagg`",
    "inputType" : "\"FLOAT\""
  }
}


-- !query
SELECT listagg(DISTINCT col, ',') WITHIN GROUP (ORDER BY col) FROM VALUES (TIMESTAMP'2024-01-01 10:00:00'), (TIMESTAMP'2024-01-02 12:00:00'), (TIMESTAMP'2024-01-01 10:00:00') AS t(col)
-- !query schema
struct<>
-- !query output
org.apache.spark.sql.catalyst.ExtendedAnalysisException
{
  "errorClass" : "INVALID_WITHIN_GROUP_EXPRESSION.MISMATCH_WITH_DISTINCT_INPUT_UNSAFE_CAST",
  "sqlState" : "42K0K",
  "messageParameters" : {
    "castType" : "\"STRING\"",
    "funcName" : "`listagg`",
    "inputType" : "\"TIMESTAMP\""
  }
}
