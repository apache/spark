-- Automatically generated by SQLQueryTestSuite
-- !query
create temp view l (a, b)
as values
    (1, 2.0),
    (1, 2.0),
    (2, 1.0),
    (2, 1.0),
    (3, 3.0),
    (null, null),
    (null, 5.0),
    (6, null)
-- !query schema
struct<>
-- !query output



-- !query
create temp view r (c, d)
as values
    (2, 3.0),
    (2, 3.0),
    (3, 2.0),
    (4, 1.0),
    (null, null),
    (null, 5.0),
    (6, null)
-- !query schema
struct<>
-- !query output



-- !query
select *, (select count(*) from r where l.a = r.c) from l
-- !query schema
struct<a:int,b:decimal(2,1),scalarsubquery(a):bigint>
-- !query output
1	2.0	0
1	2.0	0
2	1.0	2
2	1.0	2
3	3.0	1
6	NULL	1
NULL	5.0	0
NULL	NULL	0


-- !query
select *, (select count(*) from r where l.a = r.c group by c) from l
-- !query schema
struct<a:int,b:decimal(2,1),scalarsubquery(a):bigint>
-- !query output
1	2.0	NULL
1	2.0	NULL
2	1.0	2
2	1.0	2
3	3.0	1
6	NULL	1
NULL	5.0	NULL
NULL	NULL	NULL


-- !query
select *, (select count(*) from r where l.a = r.c group by 'constant') from l
-- !query schema
struct<a:int,b:decimal(2,1),scalarsubquery(a):bigint>
-- !query output
1	2.0	NULL
1	2.0	NULL
2	1.0	2
2	1.0	2
3	3.0	1
6	NULL	1
NULL	5.0	NULL
NULL	NULL	NULL


-- !query
select *, (
  select (count(*)) is null
  from r
  where l.a = r.c)
from l
-- !query schema
struct<a:int,b:decimal(2,1),scalarsubquery(a):boolean>
-- !query output
1	2.0	false
1	2.0	false
2	1.0	false
2	1.0	false
3	3.0	false
6	NULL	false
NULL	5.0	false
NULL	NULL	false


-- !query
select *, (
  select (count(*)) is null
  from r
  where l.a = r.c
  group by r.c)
from l
-- !query schema
struct<a:int,b:decimal(2,1),scalarsubquery(a):boolean>
-- !query output
1	2.0	NULL
1	2.0	NULL
2	1.0	false
2	1.0	false
3	3.0	false
6	NULL	false
NULL	5.0	NULL
NULL	NULL	NULL


-- !query
select *, (select count(*) from r where l.a = r.c having count(*) <= 1) from l
-- !query schema
struct<a:int,b:decimal(2,1),scalarsubquery(a):bigint>
-- !query output
1	2.0	0
1	2.0	0
2	1.0	NULL
2	1.0	NULL
3	3.0	1
6	NULL	1
NULL	5.0	0
NULL	NULL	0


-- !query
select *, (select count(*) from r where l.a = r.c having count(*) >= 2) from l
-- !query schema
struct<a:int,b:decimal(2,1),scalarsubquery(a):bigint>
-- !query output
1	2.0	NULL
1	2.0	NULL
2	1.0	2
2	1.0	2
3	3.0	NULL
6	NULL	NULL
NULL	5.0	NULL
NULL	NULL	NULL


-- !query
CREATE TEMPORARY VIEW null_view(a, b) AS SELECT CAST(null AS int), CAST(null as int)
-- !query schema
struct<>
-- !query output



-- !query
SELECT
  (
    SELECT
      COUNT(null_view.a) AS result
    FROM
      null_view
    WHERE
      null_view.a = l.a
  )
FROM
  l
-- !query schema
struct<scalarsubquery(a):bigint>
-- !query output
0
0
0
0
0
0
0
0


-- !query
SELECT
  (
    SELECT
      COUNT(null_view.a) AS result
    FROM
      null_view
    WHERE
      null_view.a = l.a
    having count(*) > -1
  )
FROM
  l
-- !query schema
struct<scalarsubquery(a):bigint>
-- !query output
0
0
0
0
0
0
0
0


-- !query
SELECT
  (
    SELECT
      COUNT(null_view.a) AS result
    FROM
      null_view
    INNER JOIN r
      ON r.c = null_view.a
      AND r.c IS NOT NULL
    WHERE
      null_view.a = l.a
  )
FROM
  l
-- !query schema
struct<scalarsubquery(a):bigint>
-- !query output
0
0
0
0
0
0
0
0


-- !query
SELECT
(
  SELECT
    COUNT(null_view.a) AS result
  FROM
    null_view
  INNER JOIN r
    ON r.c = null_view.a
    AND r.c IS NOT NULL
  WHERE
    null_view.a = l.a
  HAVING COUNT(*) > -1
)
FROM
  l
-- !query schema
struct<scalarsubquery(a):bigint>
-- !query output
0
0
0
0
0
0
0
0


-- !query
SELECT
  (
    SELECT
      COUNT(f.a) AS result
    FROM
    (
        SELECT a, b FROM null_view
        INTERSECT
        SELECT c, d FROM r WHERE c IS NOT NULL
    ) AS f
    WHERE
      f.a = l.a
  )
FROM
  l
-- !query schema
struct<scalarsubquery(a):bigint>
-- !query output
0
0
0
0
0
0
0
0


-- !query
SELECT
(
  SELECT
    COUNT(f.a) AS result
  FROM
  (
      SELECT a, b FROM null_view
      INTERSECT
      SELECT c, d FROM r WHERE c IS NOT NULL
  ) AS f
  WHERE
    f.a = l.a
  HAVING COUNT(*) > -1
)
FROM
  l
-- !query schema
struct<scalarsubquery(a):bigint>
-- !query output
0
0
0
0
0
0
0
0


-- !query
set spark.sql.optimizer.decorrelateSubqueryLegacyIncorrectCountHandling.enabled = true
-- !query schema
struct<key:string,value:string>
-- !query output
spark.sql.optimizer.decorrelateSubqueryLegacyIncorrectCountHandling.enabled	true


-- !query
select *, (select count(*) from r where l.a = r.c) from l
-- !query schema
struct<a:int,b:decimal(2,1),scalarsubquery(a):bigint>
-- !query output
1	2.0	0
1	2.0	0
2	1.0	2
2	1.0	2
3	3.0	1
6	NULL	1
NULL	5.0	0
NULL	NULL	0


-- !query
select *, (select count(*) from r where l.a = r.c group by c) from l
-- !query schema
struct<a:int,b:decimal(2,1),scalarsubquery(a):bigint>
-- !query output
1	2.0	0
1	2.0	0
2	1.0	2
2	1.0	2
3	3.0	1
6	NULL	1
NULL	5.0	0
NULL	NULL	0


-- !query
select *, (select count(*) from r where l.a = r.c group by 'constant') from l
-- !query schema
struct<a:int,b:decimal(2,1),scalarsubquery(a):bigint>
-- !query output
1	2.0	0
1	2.0	0
2	1.0	2
2	1.0	2
3	3.0	1
6	NULL	1
NULL	5.0	0
NULL	NULL	0


-- !query
reset spark.sql.optimizer.decorrelateSubqueryLegacyIncorrectCountHandling.enabled
-- !query schema
struct<>
-- !query output

