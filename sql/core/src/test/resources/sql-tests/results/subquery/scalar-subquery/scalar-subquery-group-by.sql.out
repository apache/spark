-- Automatically generated by SQLQueryTestSuite
-- !query
create temp view x (x1, x2) as values (1, 1), (2, 2)
-- !query schema
struct<>
-- !query output



-- !query
create temp view y (y1, y2) as values (2, 0), (3, -1)
-- !query schema
struct<>
-- !query output



-- !query
create temp view z (z1, z2) as values (1, 0), (1, 1)
-- !query schema
struct<>
-- !query output



-- !query
select * from x where (select count(*) from y where y1 = x1 group by y1) = 1
-- !query schema
struct<x1:int,x2:int>
-- !query output
2	2


-- !query
select * from x where (select count(*) from y where y1 = x1 group by x1) = 1
-- !query schema
struct<>
-- !query output
org.apache.spark.sql.catalyst.ExtendedAnalysisException
{
  "condition" : "UNSUPPORTED_SUBQUERY_EXPRESSION_CATEGORY.CORRELATED_REFERENCE",
  "sqlState" : "0A000",
  "messageParameters" : {
    "sqlExprs" : "\"x1\""
  },
  "queryContext" : [ {
    "objectType" : "",
    "objectName" : "",
    "startIndex" : 61,
    "stopIndex" : 71,
    "fragment" : "group by x1"
  } ]
}


-- !query
select * from x where (select count(*) from y where y1 > x1 group by x1) = 1
-- !query schema
struct<>
-- !query output
org.apache.spark.sql.catalyst.ExtendedAnalysisException
{
  "condition" : "UNSUPPORTED_SUBQUERY_EXPRESSION_CATEGORY.CORRELATED_REFERENCE",
  "sqlState" : "0A000",
  "messageParameters" : {
    "sqlExprs" : "\"x1\""
  },
  "queryContext" : [ {
    "objectType" : "",
    "objectName" : "",
    "startIndex" : 61,
    "stopIndex" : 71,
    "fragment" : "group by x1"
  } ]
}


-- !query
select *, (select count(*) from y where x1 = y1 and y2 = 1 group by y2) from x
-- !query schema
struct<x1:int,x2:int,scalarsubquery(x1):bigint>
-- !query output
1	1	NULL
2	2	NULL


-- !query
select *, (select count(*) from y where x1 = y1 and y2 = x1 + 1 group by y2) from x
-- !query schema
struct<x1:int,x2:int,scalarsubquery(x1, x1):bigint>
-- !query output
1	1	NULL
2	2	NULL


-- !query
select *, (select count(*) from y where x1 = y1 and cast(y2 as double) = x1 + 1
           group by cast(y2 as double)) from x
-- !query schema
struct<x1:int,x2:int,scalarsubquery(x1, x1):bigint>
-- !query output
1	1	NULL
2	2	NULL


-- !query
select *, (select count(*) from y where y2 + 1 = x1 + x2 group by y2 + 1) from x
-- !query schema
struct<x1:int,x2:int,scalarsubquery(x1, x2):bigint>
-- !query output
1	1	NULL
2	2	NULL


-- !query
set spark.sql.optimizer.scalarSubqueryUseSingleJoin = false
-- !query schema
struct<key:string,value:string>
-- !query output
spark.sql.optimizer.scalarSubqueryUseSingleJoin	false


-- !query
select * from x where (select count(*) from y where y1 > x1 group by y1) = 1
-- !query schema
struct<>
-- !query output
org.apache.spark.sql.catalyst.ExtendedAnalysisException
{
  "condition" : "UNSUPPORTED_SUBQUERY_EXPRESSION_CATEGORY.NON_CORRELATED_COLUMNS_IN_GROUP_BY",
  "sqlState" : "0A000",
  "messageParameters" : {
    "value" : "y1"
  },
  "queryContext" : [ {
    "objectType" : "",
    "objectName" : "",
    "startIndex" : 23,
    "stopIndex" : 72,
    "fragment" : "(select count(*) from y where y1 > x1 group by y1)"
  } ]
}


-- !query
select *, (select count(*) from y where y1 + y2 = x1 group by y1) from x
-- !query schema
struct<>
-- !query output
org.apache.spark.sql.catalyst.ExtendedAnalysisException
{
  "condition" : "UNSUPPORTED_SUBQUERY_EXPRESSION_CATEGORY.NON_CORRELATED_COLUMNS_IN_GROUP_BY",
  "sqlState" : "0A000",
  "messageParameters" : {
    "value" : "y1"
  },
  "queryContext" : [ {
    "objectType" : "",
    "objectName" : "",
    "startIndex" : 11,
    "stopIndex" : 65,
    "fragment" : "(select count(*) from y where y1 + y2 = x1 group by y1)"
  } ]
}


-- !query
select *, (select count(*) from y where x1 = y1 and y2 + 10 = x1 + 1 group by y2) from x
-- !query schema
struct<>
-- !query output
org.apache.spark.sql.catalyst.ExtendedAnalysisException
{
  "condition" : "UNSUPPORTED_SUBQUERY_EXPRESSION_CATEGORY.NON_CORRELATED_COLUMNS_IN_GROUP_BY",
  "sqlState" : "0A000",
  "messageParameters" : {
    "value" : "y2"
  },
  "queryContext" : [ {
    "objectType" : "",
    "objectName" : "",
    "startIndex" : 11,
    "stopIndex" : 81,
    "fragment" : "(select count(*) from y where x1 = y1 and y2 + 10 = x1 + 1 group by y2)"
  } ]
}


-- !query
set spark.sql.optimizer.scalarSubqueryUseSingleJoin = true
-- !query schema
struct<key:string,value:string>
-- !query output
spark.sql.optimizer.scalarSubqueryUseSingleJoin	true


-- !query
select * from x where (select count(*) from y where y1 > x1 group by y1) = 1
-- !query schema
struct<>
-- !query output
org.apache.spark.SparkRuntimeException
{
  "condition" : "SCALAR_SUBQUERY_TOO_MANY_ROWS",
  "sqlState" : "21000"
}


-- !query
select *, (select count(*) from y where y1 + y2 = x1 group by y1) from x
-- !query schema
struct<>
-- !query output
org.apache.spark.SparkRuntimeException
{
  "condition" : "SCALAR_SUBQUERY_TOO_MANY_ROWS",
  "sqlState" : "21000"
}


-- !query
select *, (select count(*) from y where x1 = y1 and y2 + 10 = x1 + 1 group by y2) from x
-- !query schema
struct<x1:int,x2:int,scalarsubquery(x1, x1):bigint>
-- !query output
1	1	NULL
2	2	NULL


-- !query
select *, (select count(*) from (select * from y where y1 = x1 union all select * from y) sub group by y1) from x
-- !query schema
struct<>
-- !query output
org.apache.spark.SparkRuntimeException
{
  "condition" : "SCALAR_SUBQUERY_TOO_MANY_ROWS",
  "sqlState" : "21000"
}


-- !query
select *, (select count(*) from y left join (select * from z where z1 = x1) sub on y2 = z2 group by z1) from x
-- !query schema
struct<>
-- !query output
org.apache.spark.sql.catalyst.ExtendedAnalysisException
{
  "condition" : "UNSUPPORTED_SUBQUERY_EXPRESSION_CATEGORY.ACCESSING_OUTER_QUERY_COLUMN_IS_NOT_ALLOWED",
  "sqlState" : "0A000",
  "messageParameters" : {
    "treeNode" : "Filter (z1#x = outer(x1#x))\n+- SubqueryAlias z\n   +- View (`z`, [z1#x, z2#x])\n      +- Project [cast(col1#x as int) AS z1#x, cast(col2#x as int) AS z2#x]\n         +- LocalRelation [col1#x, col2#x]\n"
  },
  "queryContext" : [ {
    "objectType" : "",
    "objectName" : "",
    "startIndex" : 46,
    "stopIndex" : 74,
    "fragment" : "select * from z where z1 = x1"
  } ]
}


-- !query
set spark.sql.legacy.scalarSubqueryAllowGroupByNonEqualityCorrelatedPredicate = true
-- !query schema
struct<key:string,value:string>
-- !query output
spark.sql.legacy.scalarSubqueryAllowGroupByNonEqualityCorrelatedPredicate	true


-- !query
set spark.sql.optimizer.scalarSubqueryUseSingleJoin = false
-- !query schema
struct<key:string,value:string>
-- !query output
spark.sql.optimizer.scalarSubqueryUseSingleJoin	false


-- !query
select * from x where (select count(*) from y where y1 > x1 group by y1) = 1
-- !query schema
struct<x1:int,x2:int>
-- !query output
1	1
1	1
2	2


-- !query
reset spark.sql.legacy.scalarSubqueryAllowGroupByNonEqualityCorrelatedPredicate
-- !query schema
struct<>
-- !query output

