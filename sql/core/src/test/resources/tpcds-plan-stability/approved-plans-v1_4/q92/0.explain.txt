== Parsed Logical Plan ==
'GlobalLimit 100
+- 'LocalLimit 100
   +- 'Sort ['sum('ws_ext_discount_amt) ASC NULLS FIRST], true
      +- 'Project ['sum('ws_ext_discount_amt) AS Excess Discount Amount #1]
         +- 'Filter (((('i_manufact_id = 350) AND ('i_item_sk = 'ws_item_sk)) AND (('d_date >= 2000-01-27) AND ('d_date <= (cast(2000-01-27 as date) + 90 days)))) AND (('d_date_sk = 'ws_sold_date_sk) AND ('ws_ext_discount_amt > scalar-subquery#2 [])))
            :  +- 'Project [unresolvedalias((1.3 * 'avg('ws_ext_discount_amt)), None)]
            :     +- 'Filter ((('ws_item_sk = 'i_item_sk) AND (('d_date >= 2000-01-27) AND ('d_date <= (cast(2000-01-27 as date) + 90 days)))) AND ('d_date_sk = 'ws_sold_date_sk))
            :        +- 'Join Inner
            :           :- 'UnresolvedRelation [web_sales]
            :           +- 'UnresolvedRelation [date_dim]
            +- 'Join Inner
               :- 'Join Inner
               :  :- 'UnresolvedRelation [web_sales]
               :  +- 'UnresolvedRelation [item]
               +- 'UnresolvedRelation [date_dim]

== Analyzed Logical Plan ==
Excess Discount Amount : decimal(17,2)
GlobalLimit 100
+- LocalLimit 100
   +- Project [Excess Discount Amount #1]
      +- Sort [Excess Discount Amount #1 ASC NULLS FIRST], true
         +- Aggregate [sum(ws_ext_discount_amt#3) AS Excess Discount Amount #1]
            +- Filter ((((i_manufact_id#4 = 350) AND (i_item_sk#5 = ws_item_sk#6)) AND ((d_date#7 >= cast(2000-01-27 as date)) AND (d_date#7 <= cast(2000-01-27 as date) + 90 days))) AND ((d_date_sk#8 = ws_sold_date_sk#9) AND (cast(ws_ext_discount_amt#3 as decimal(14,7)) > cast(scalar-subquery#2 [i_item_sk#5] as decimal(14,7)))))
               :  +- Aggregate [CheckOverflow((promote_precision(cast(1.3 as decimal(11,6))) * promote_precision(cast(avg(ws_ext_discount_amt#3) as decimal(11,6)))), DecimalType(14,7), true) AS (CAST(1.3 AS DECIMAL(11,6)) * CAST(avg(ws_ext_discount_amt) AS DECIMAL(11,6)))#10]
               :     +- Filter (((ws_item_sk#6 = outer(i_item_sk#5)) AND ((d_date#7 >= cast(2000-01-27 as date)) AND (d_date#7 <= cast(2000-01-27 as date) + 90 days))) AND (d_date_sk#8 = ws_sold_date_sk#9))
               :        +- Join Inner
               :           :- SubqueryAlias spark_catalog.default.web_sales
               :           :  +- Relation[ws_sold_date_sk#9,ws_sold_time_sk#11,ws_ship_date_sk#12,ws_item_sk#6,ws_bill_customer_sk#13,ws_bill_cdemo_sk#14,ws_bill_hdemo_sk#15,ws_bill_addr_sk#16,ws_ship_customer_sk#17,ws_ship_cdemo_sk#18,ws_ship_hdemo_sk#19,ws_ship_addr_sk#20,ws_web_page_sk#21,ws_web_site_sk#22,ws_ship_mode_sk#23,ws_warehouse_sk#24,ws_promo_sk#25,ws_order_number#26,ws_quantity#27,ws_wholesale_cost#28,ws_list_price#29,ws_sales_price#30,ws_ext_discount_amt#3,ws_ext_sales_price#31,ws_ext_wholesale_cost#32,ws_ext_list_price#33,ws_ext_tax#34,ws_coupon_amt#35,ws_ext_ship_cost#36,ws_net_paid#37,ws_net_paid_inc_tax#38,ws_net_paid_inc_ship#39,ws_net_paid_inc_ship_tax#40,ws_net_profit#41] parquet
               :           +- SubqueryAlias spark_catalog.default.date_dim
               :              +- Relation[d_date_sk#8,d_date_id#42,d_date#7,d_month_seq#43,d_week_seq#44,d_quarter_seq#45,d_year#46,d_dow#47,d_moy#48,d_dom#49,d_qoy#50,d_fy_year#51,d_fy_quarter_seq#52,d_fy_week_seq#53,d_day_name#54,d_quarter_name#55,d_holiday#56,d_weekend#57,d_following_holiday#58,d_first_dom#59,d_last_dom#60,d_same_day_ly#61,d_same_day_lq#62,d_current_day#63,d_current_week#64,d_current_month#65,d_current_quarter#66,d_current_year#67] parquet
               +- Join Inner
                  :- Join Inner
                  :  :- SubqueryAlias spark_catalog.default.web_sales
                  :  :  +- Relation[ws_sold_date_sk#9,ws_sold_time_sk#11,ws_ship_date_sk#12,ws_item_sk#6,ws_bill_customer_sk#13,ws_bill_cdemo_sk#14,ws_bill_hdemo_sk#15,ws_bill_addr_sk#16,ws_ship_customer_sk#17,ws_ship_cdemo_sk#18,ws_ship_hdemo_sk#19,ws_ship_addr_sk#20,ws_web_page_sk#21,ws_web_site_sk#22,ws_ship_mode_sk#23,ws_warehouse_sk#24,ws_promo_sk#25,ws_order_number#26,ws_quantity#27,ws_wholesale_cost#28,ws_list_price#29,ws_sales_price#30,ws_ext_discount_amt#3,ws_ext_sales_price#31,ws_ext_wholesale_cost#32,ws_ext_list_price#33,ws_ext_tax#34,ws_coupon_amt#35,ws_ext_ship_cost#36,ws_net_paid#37,ws_net_paid_inc_tax#38,ws_net_paid_inc_ship#39,ws_net_paid_inc_ship_tax#40,ws_net_profit#41] parquet
                  :  +- SubqueryAlias spark_catalog.default.item
                  :     +- Relation[i_item_sk#5,i_item_id#68,i_rec_start_date#69,i_rec_end_date#70,i_item_desc#71,i_current_price#72,i_wholesale_cost#73,i_brand_id#74,i_brand#75,i_class_id#76,i_class#77,i_category_id#78,i_category#79,i_manufact_id#4,i_manufact#80,i_size#81,i_formulation#82,i_color#83,i_units#84,i_container#85,i_manager_id#86,i_product_name#87] parquet
                  +- SubqueryAlias spark_catalog.default.date_dim
                     +- Relation[d_date_sk#8,d_date_id#42,d_date#7,d_month_seq#43,d_week_seq#44,d_quarter_seq#45,d_year#46,d_dow#47,d_moy#48,d_dom#49,d_qoy#50,d_fy_year#51,d_fy_quarter_seq#52,d_fy_week_seq#53,d_day_name#54,d_quarter_name#55,d_holiday#56,d_weekend#57,d_following_holiday#58,d_first_dom#59,d_last_dom#60,d_same_day_ly#61,d_same_day_lq#62,d_current_day#63,d_current_week#64,d_current_month#65,d_current_quarter#66,d_current_year#67] parquet

== Optimized Logical Plan ==
GlobalLimit 100
+- LocalLimit 100
   +- Sort [Excess Discount Amount #1 ASC NULLS FIRST], true
      +- Aggregate [MakeDecimal(sum(UnscaledValue(ws_ext_discount_amt#3)),17,2) AS Excess Discount Amount #1]
         +- Project [ws_ext_discount_amt#3]
            +- Join Inner, (d_date_sk#8 = ws_sold_date_sk#9)
               :- Project [ws_sold_date_sk#9, ws_ext_discount_amt#3]
               :  +- Join Inner, ((cast(ws_ext_discount_amt#3 as decimal(14,7)) > (CAST(1.3 AS DECIMAL(11,6)) * CAST(avg(ws_ext_discount_amt) AS DECIMAL(11,6)))#10) AND (ws_item_sk#6#88 = i_item_sk#5))
               :     :- Project [ws_sold_date_sk#9, ws_ext_discount_amt#3, i_item_sk#5]
               :     :  +- Join Inner, (i_item_sk#5 = ws_item_sk#6)
               :     :     :- Project [ws_sold_date_sk#9, ws_item_sk#6, ws_ext_discount_amt#3]
               :     :     :  +- Filter ((isnotnull(ws_item_sk#6) AND isnotnull(ws_ext_discount_amt#3)) AND isnotnull(ws_sold_date_sk#9))
               :     :     :     +- Relation[ws_sold_date_sk#9,ws_sold_time_sk#11,ws_ship_date_sk#12,ws_item_sk#6,ws_bill_customer_sk#13,ws_bill_cdemo_sk#14,ws_bill_hdemo_sk#15,ws_bill_addr_sk#16,ws_ship_customer_sk#17,ws_ship_cdemo_sk#18,ws_ship_hdemo_sk#19,ws_ship_addr_sk#20,ws_web_page_sk#21,ws_web_site_sk#22,ws_ship_mode_sk#23,ws_warehouse_sk#24,ws_promo_sk#25,ws_order_number#26,ws_quantity#27,ws_wholesale_cost#28,ws_list_price#29,ws_sales_price#30,ws_ext_discount_amt#3,ws_ext_sales_price#31,ws_ext_wholesale_cost#32,ws_ext_list_price#33,ws_ext_tax#34,ws_coupon_amt#35,ws_ext_ship_cost#36,ws_net_paid#37,ws_net_paid_inc_tax#38,ws_net_paid_inc_ship#39,ws_net_paid_inc_ship_tax#40,ws_net_profit#41] parquet
               :     :     +- Project [i_item_sk#5]
               :     :        +- Filter ((isnotnull(i_manufact_id#4) AND (i_manufact_id#4 = 350)) AND isnotnull(i_item_sk#5))
               :     :           +- Relation[i_item_sk#5,i_item_id#68,i_rec_start_date#69,i_rec_end_date#70,i_item_desc#71,i_current_price#72,i_wholesale_cost#73,i_brand_id#74,i_brand#75,i_class_id#76,i_class#77,i_category_id#78,i_category#79,i_manufact_id#4,i_manufact#80,i_size#81,i_formulation#82,i_color#83,i_units#84,i_container#85,i_manager_id#86,i_product_name#87] parquet
               :     +- Filter isnotnull((CAST(1.3 AS DECIMAL(11,6)) * CAST(avg(ws_ext_discount_amt) AS DECIMAL(11,6)))#10)
               :        +- Aggregate [ws_item_sk#6], [CheckOverflow((1.300000 * promote_precision(cast((avg(UnscaledValue(ws_ext_discount_amt#3)) / 100.0) as decimal(11,6)))), DecimalType(14,7), true) AS (CAST(1.3 AS DECIMAL(11,6)) * CAST(avg(ws_ext_discount_amt) AS DECIMAL(11,6)))#10, ws_item_sk#6 AS ws_item_sk#6#88]
               :           +- Project [ws_item_sk#6, ws_ext_discount_amt#3]
               :              +- Join Inner, (d_date_sk#8 = ws_sold_date_sk#9)
               :                 :- Project [ws_sold_date_sk#9, ws_item_sk#6, ws_ext_discount_amt#3]
               :                 :  +- Filter (isnotnull(ws_sold_date_sk#9) AND isnotnull(ws_item_sk#6))
               :                 :     +- Relation[ws_sold_date_sk#9,ws_sold_time_sk#11,ws_ship_date_sk#12,ws_item_sk#6,ws_bill_customer_sk#13,ws_bill_cdemo_sk#14,ws_bill_hdemo_sk#15,ws_bill_addr_sk#16,ws_ship_customer_sk#17,ws_ship_cdemo_sk#18,ws_ship_hdemo_sk#19,ws_ship_addr_sk#20,ws_web_page_sk#21,ws_web_site_sk#22,ws_ship_mode_sk#23,ws_warehouse_sk#24,ws_promo_sk#25,ws_order_number#26,ws_quantity#27,ws_wholesale_cost#28,ws_list_price#29,ws_sales_price#30,ws_ext_discount_amt#3,ws_ext_sales_price#31,ws_ext_wholesale_cost#32,ws_ext_list_price#33,ws_ext_tax#34,ws_coupon_amt#35,ws_ext_ship_cost#36,ws_net_paid#37,ws_net_paid_inc_tax#38,ws_net_paid_inc_ship#39,ws_net_paid_inc_ship_tax#40,ws_net_profit#41] parquet
               :                 +- Project [d_date_sk#8]
               :                    +- Filter (((isnotnull(d_date#7) AND (d_date#7 >= 10983)) AND (d_date#7 <= 11073)) AND isnotnull(d_date_sk#8))
               :                       +- Relation[d_date_sk#8,d_date_id#42,d_date#7,d_month_seq#43,d_week_seq#44,d_quarter_seq#45,d_year#46,d_dow#47,d_moy#48,d_dom#49,d_qoy#50,d_fy_year#51,d_fy_quarter_seq#52,d_fy_week_seq#53,d_day_name#54,d_quarter_name#55,d_holiday#56,d_weekend#57,d_following_holiday#58,d_first_dom#59,d_last_dom#60,d_same_day_ly#61,d_same_day_lq#62,d_current_day#63,d_current_week#64,d_current_month#65,d_current_quarter#66,d_current_year#67] parquet
               +- Project [d_date_sk#8]
                  +- Filter (((isnotnull(d_date#7) AND (d_date#7 >= 10983)) AND (d_date#7 <= 11073)) AND isnotnull(d_date_sk#8))
                     +- Relation[d_date_sk#8,d_date_id#42,d_date#7,d_month_seq#43,d_week_seq#44,d_quarter_seq#45,d_year#46,d_dow#47,d_moy#48,d_dom#49,d_qoy#50,d_fy_year#51,d_fy_quarter_seq#52,d_fy_week_seq#53,d_day_name#54,d_quarter_name#55,d_holiday#56,d_weekend#57,d_following_holiday#58,d_first_dom#59,d_last_dom#60,d_same_day_ly#61,d_same_day_lq#62,d_current_day#63,d_current_week#64,d_current_month#65,d_current_quarter#66,d_current_year#67] parquet

== Physical Plan ==
TakeOrderedAndProject(limit=100, orderBy=[Excess Discount Amount #1 ASC NULLS FIRST], output=[Excess Discount Amount #1])
+- *(7) HashAggregate(keys=[], functions=[sum(UnscaledValue(ws_ext_discount_amt#3))], output=[Excess Discount Amount #1])
   +- Exchange SinglePartition, true, [id=#89]
      +- *(6) HashAggregate(keys=[], functions=[partial_sum(UnscaledValue(ws_ext_discount_amt#3))], output=[sum#90])
         +- *(6) Project [ws_ext_discount_amt#3]
            +- *(6) BroadcastHashJoin [ws_sold_date_sk#9], [d_date_sk#8], Inner, BuildRight
               :- *(6) Project [ws_sold_date_sk#9, ws_ext_discount_amt#3]
               :  +- *(6) BroadcastHashJoin [i_item_sk#5], [ws_item_sk#6#88], Inner, BuildRight, (cast(ws_ext_discount_amt#3 as decimal(14,7)) > (CAST(1.3 AS DECIMAL(11,6)) * CAST(avg(ws_ext_discount_amt) AS DECIMAL(11,6)))#10)
               :     :- *(6) Project [ws_sold_date_sk#9, ws_ext_discount_amt#3, i_item_sk#5]
               :     :  +- *(6) BroadcastHashJoin [ws_item_sk#6], [i_item_sk#5], Inner, BuildRight
               :     :     :- *(6) Project [ws_sold_date_sk#9, ws_item_sk#6, ws_ext_discount_amt#3]
               :     :     :  +- *(6) Filter ((isnotnull(ws_item_sk#6) AND isnotnull(ws_ext_discount_amt#3)) AND isnotnull(ws_sold_date_sk#9))
               :     :     :     +- *(6) ColumnarToRow
               :     :     :        +- FileScan parquet default.web_sales[ws_sold_date_sk#9,ws_item_sk#6,ws_ext_discount_amt#3] Batched: true, DataFilters: [isnotnull(ws_item_sk#6), isnotnull(ws_ext_discount_amt#3), isnotnull(ws_sold_date_sk#9)], Format: Parquet, Location: InMemoryFileIndex[file:/Users/yi.wu/IdeaProjects/spark/sql/core/spark-warehouse/org.apache.spark...., PartitionFilters: [], PushedFilters: [IsNotNull(ws_item_sk), IsNotNull(ws_ext_discount_amt), IsNotNull(ws_sold_date_sk)], ReadSchema: struct<ws_sold_date_sk:int,ws_item_sk:int,ws_ext_discount_amt:decimal(7,2)>
               :     :     +- BroadcastExchange HashedRelationBroadcastMode(List(cast(input[0, int, true] as bigint))), [id=#91]
               :     :        +- *(1) Project [i_item_sk#5]
               :     :           +- *(1) Filter ((isnotnull(i_manufact_id#4) AND (i_manufact_id#4 = 350)) AND isnotnull(i_item_sk#5))
               :     :              +- *(1) ColumnarToRow
               :     :                 +- FileScan parquet default.item[i_item_sk#5,i_manufact_id#4] Batched: true, DataFilters: [isnotnull(i_manufact_id#4), (i_manufact_id#4 = 350), isnotnull(i_item_sk#5)], Format: Parquet, Location: InMemoryFileIndex[file:/Users/yi.wu/IdeaProjects/spark/sql/core/spark-warehouse/org.apache.spark...., PartitionFilters: [], PushedFilters: [IsNotNull(i_manufact_id), EqualTo(i_manufact_id,350), IsNotNull(i_item_sk)], ReadSchema: struct<i_item_sk:int,i_manufact_id:int>
               :     +- BroadcastExchange HashedRelationBroadcastMode(List(cast(input[1, int, true] as bigint))), [id=#92]
               :        +- *(4) Filter isnotnull((CAST(1.3 AS DECIMAL(11,6)) * CAST(avg(ws_ext_discount_amt) AS DECIMAL(11,6)))#10)
               :           +- *(4) HashAggregate(keys=[ws_item_sk#6], functions=[avg(UnscaledValue(ws_ext_discount_amt#3))], output=[(CAST(1.3 AS DECIMAL(11,6)) * CAST(avg(ws_ext_discount_amt) AS DECIMAL(11,6)))#10, ws_item_sk#6#88])
               :              +- Exchange hashpartitioning(ws_item_sk#6, 5), true, [id=#93]
               :                 +- *(3) HashAggregate(keys=[ws_item_sk#6], functions=[partial_avg(UnscaledValue(ws_ext_discount_amt#3))], output=[ws_item_sk#6, sum#94, count#95])
               :                    +- *(3) Project [ws_item_sk#6, ws_ext_discount_amt#3]
               :                       +- *(3) BroadcastHashJoin [ws_sold_date_sk#9], [d_date_sk#8], Inner, BuildRight
               :                          :- *(3) Project [ws_sold_date_sk#9, ws_item_sk#6, ws_ext_discount_amt#3]
               :                          :  +- *(3) Filter (isnotnull(ws_sold_date_sk#9) AND isnotnull(ws_item_sk#6))
               :                          :     +- *(3) ColumnarToRow
               :                          :        +- FileScan parquet default.web_sales[ws_sold_date_sk#9,ws_item_sk#6,ws_ext_discount_amt#3] Batched: true, DataFilters: [isnotnull(ws_sold_date_sk#9), isnotnull(ws_item_sk#6)], Format: Parquet, Location: InMemoryFileIndex[file:/Users/yi.wu/IdeaProjects/spark/sql/core/spark-warehouse/org.apache.spark...., PartitionFilters: [], PushedFilters: [IsNotNull(ws_sold_date_sk), IsNotNull(ws_item_sk)], ReadSchema: struct<ws_sold_date_sk:int,ws_item_sk:int,ws_ext_discount_amt:decimal(7,2)>
               :                          +- BroadcastExchange HashedRelationBroadcastMode(List(cast(input[0, int, true] as bigint))), [id=#96]
               :                             +- *(2) Project [d_date_sk#8]
               :                                +- *(2) Filter (((isnotnull(d_date#7) AND (d_date#7 >= 10983)) AND (d_date#7 <= 11073)) AND isnotnull(d_date_sk#8))
               :                                   +- *(2) ColumnarToRow
               :                                      +- FileScan parquet default.date_dim[d_date_sk#8,d_date#7] Batched: true, DataFilters: [isnotnull(d_date#7), (d_date#7 >= 10983), (d_date#7 <= 11073), isnotnull(d_date_sk#8)], Format: Parquet, Location: InMemoryFileIndex[file:/Users/yi.wu/IdeaProjects/spark/sql/core/spark-warehouse/org.apache.spark...., PartitionFilters: [], PushedFilters: [IsNotNull(d_date), GreaterThanOrEqual(d_date,2000-01-27), LessThanOrEqual(d_date,2000-04-26), Is..., ReadSchema: struct<d_date_sk:int,d_date:date>
               +- ReusedExchange [d_date_sk#8], BroadcastExchange HashedRelationBroadcastMode(List(cast(input[0, int, true] as bigint))), [id=#96]
